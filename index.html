<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Theme Color changed to Navy Blue -->
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Gulistan Supermarket & Halal Meat Management System">
    <title>Gulistan - Supermarket & Halal Meat Management</title>
<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkd1bGlzdGFuIE1hbmFnZW1lbnQgU3lzdGVtIiwKICAic2hvcnRfbmFtZSI6ICJHdWxpc3RhbiIsCiAgImRlc2NyaXB0aW9uIjogIlN1cGVybWFya2V0ICYgSGFsYWwgTWVhdCBNYW5hZ2VtZW50IFN5c3RlbSIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzBmMTcyYSIsCiAgInRoZW1lX2NvbG9yIjogIiMwZjE3MmEiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdC1wcmltYXJ5IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAibG9nby5wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdCn0=">
<link rel="apple-touch-icon" href="logo.png">
<link rel="icon" href="logo.png" type="image/png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, setDoc, getDoc, doc, onSnapshot, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
// Firebase configuration - Gulistan Store
const firebaseConfig = {
apiKey: "AIzaSyBcHY8XLvoaKVyilWHwfNdOYpqGQ9Gswik",
authDomain: "gulistan-store.firebaseapp.com",
projectId: "gulistan-store",
storageBucket: "gulistan-store.firebasestorage.app",
messagingSenderId: "626332439320",
appId: "1:626332439320:web:a44e7b219d3418baed846d"
};
// Initialize Firebase
const app = initializeApp(firebaseConfig);
const firebaseDb = getFirestore(app);
// Make available globally for import
window.FirebaseDataMigration = {
firebaseDb,
collection,
getDocs,
addDoc,
updateDoc,
deleteDoc,
setDoc,
getDoc,
doc,
onSnapshot,
serverTimestamp,
Timestamp,
app
};
// Signal that Firebase is ready
window.FirebaseReady = true;
console.log('‚úì Firebase initialized successfully for gulistan-store project');
console.log('  - Project: gulistan-store');
console.log('  - Firestore ready: YES');
</script>
<style>
:root {
--primary-color: #1e3a8a;
--secondary-color: #3b82f6;
--accent-color: #60a5fa;
--glass-bg: rgba(15, 23, 42, 0.6);
--glass-border: rgba(59, 130, 246, 0.2);
--text-color: #f1f5f9;
--success-color: #10b981;
}
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #020617 0%, #1e293b 100%);
min-height: 100vh;
color: var(--text-color);
-webkit-print-color-adjust: exact;
}
.glass {
background: var(--glass-bg);
backdrop-filter: blur(10px);
-webkit-backdrop-filter: blur(10px);
border: 1px solid var(--glass-border);
box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
}
.glass-button {
background: rgba(59, 130, 246, 0.2);
backdrop-filter: blur(10px);
-webkit-backdrop-filter: blur(10px);
border: 1px solid rgba(59, 130, 246, 0.4);
color: white;
padding: 0.75rem 1.5rem;
border-radius: 8px;
cursor: pointer;
transition: all 0.3s ease;
font-weight: 500;
}
.glass-button:hover {
background: rgba(59, 130, 246, 0.4);
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
}
.nav-tab {
padding: 0.75rem 1.5rem;
border-radius: 8px;
cursor: pointer;
transition: all 0.2s ease;
background: rgba(255, 255, 255, 0.05);
border: 1px solid transparent;
color: #cbd5e1;
}
.nav-tab:hover {
background: rgba(255, 255, 255, 0.1);
}
.nav-tab.active {
background-color: var(--secondary-color);
color: white;
font-weight: 600;
box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
}
.text-center { text-align: center; }
.text-right { text-align: right; }
.glass-input:focus, .glass-select:focus {
background: var(--glass-bg);
border-color: var(--secondary-color);
box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
outline: none;
}
.glass-table {
background: rgba(30, 41, 59, 0.4);
backdrop-filter: blur(6px);
-webkit-backdrop-filter: blur(6px);
border-radius: 16px;
border: 1px solid var(--glass-border);
overflow: hidden;
padding: 1rem;
}
.tab-content { display: none; animation: fadeIn 0.3s ease; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.data-table {
width: 100%;
border-collapse: collapse;
margin-bottom: 1rem;
}
.data-table th {
background-color: rgba(15, 23, 42, 0.8);
padding: 0.75rem;
text-align: left;
font-weight: 600;
color: var(--accent-color);
border-bottom: 1px solid var(--glass-border);
}
.data-table td {
padding: 0.75rem;
border-bottom: 1px solid var(--glass-border);
color: var(--text-color);
vertical-align: top;
}
.data-table tr:hover {
background-color: rgba(59, 130, 246, 0.1);
}
.row-actions {
display: flex;
gap: 4px;
justify-content: center;
align-items: center;
min-width: 280px;
flex-wrap: wrap;
}
.action-button {
padding: 4px 8px;
border-radius: 6px;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 4px;
cursor: pointer;
transition: all 0.2s ease;
border: none;
color: #ffffff;
font-size: 0.75rem;
font-weight: 600;
white-space: nowrap;
line-height: 1.2;
height: 30px;
}
.action-button.edit { background: #22c55e; }
.action-button.edit:hover { background: #16a34a; }
.action-button.delete { background: #ef4444; }
.action-button.delete:hover { background: #dc2626; }
.action-button.print { background: #3b82f6; }
.action-button.print:hover { background: #2563eb; }
.action-button.share { background: #a855f7; }
.action-button.share:hover { background: #9333ea; }
.action-button.whatsapp { background: #25d366; }
.action-button.whatsapp:hover { background: #128c7e; }
.action-button:hover {
transform: translateY(-1px);
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}
table th:last-child, table td:last-child {
min-width: 280px;
white-space: nowrap;
}
.glass-table {
max-width: 100%;
overflow-x: auto;
-webkit-overflow-scrolling: touch;
}
.glass-table table { min-width: 800px; }
@media (max-width: 768px) {
.glass-table table { min-width: 600px; }
.glass-table { border-radius: 12px; }
}
@media (max-width: 480px) {
.glass-table table { min-width: 500px; }
}
.modal {
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
background: rgba(2, 6, 23, 0.9);
display: flex;
align-items: center;
justify-content: center;
z-index: 2000;
padding: 1rem;
}
.modal-content {
background: rgba(30, 41, 59, 0.95);
backdrop-filter: blur(15px);
-webkit-backdrop-filter: blur(15px);
border-radius: 20px;
padding: 2rem;
width: 90%;
max-width: 600px;
max-height: 80vh;
border: 1px solid var(--glass-border);
box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.5);
display: flex;
overflow-y: auto;
flex-direction: column;
}
@media (max-width: 768px) {
.modal-content { width: 95%; max-height: 85vh; padding: 1.5rem; border-radius: 16px; }
}
@media (max-width: 480px) {
.modal { padding: 0.5rem; }
.modal-content { width: 98%; max-height: 90vh; padding: 1rem; border-radius: 12px; }
}
.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1.5rem;
color: var(--text-color);
}
.modal-title { font-size: 1.5rem; font-weight: bold; }
.modal-close {
background: rgba(239, 68, 68, 0.7);
border: none;
color: white;
width: 30px; height: 30px;
border-radius: 50%;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
}
.modal-close:hover { background: rgba(239, 68, 68, 0.9); }
.form-group { margin-bottom: 1rem; }
#editModalBody {
max-height: 50vh;
overflow-y: auto;
padding-right: 0.5rem;
}
#editModalBody::-webkit-scrollbar { width: 6px; }
#editModalBody::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
#editModalBody::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }
.form-label { display: block; margin-bottom: 0.5rem; color: var(--text-color); font-weight: 500; }
.glass-input {
width: 100%;
padding: 0.75rem 1rem;
background: rgba(0, 0, 0, 0.3);
border: 1px solid var(--glass-border);
border-radius: 8px;
color: var(--text-color);
font-size: 0.875rem;
transition: all 0.2s ease;
}
.glass-input::placeholder { color: rgba(255, 255, 255, 0.5); }
select.glass-select, select.glass-input {
color: #1f2937;
background-color: rgba(255, 255, 255, 0.95);
cursor: pointer;
}
select.glass-select option, select.glass-input option {
background-color: white;
color: #1f2937;
}
select.glass-select, select.glass-input:not(.appearance-none) {
appearance: none;
-webkit-appearance: none;
-moz-appearance: none;
background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
background-position: right 0.5rem center;
background-repeat: no-repeat;
background-size: 1.5em 1.5em;
padding-right: 2.5rem !important;
}
.form-section {
background: rgba(0, 0, 0, 0.2);
border-radius: 12px;
padding: 1.5rem;
margin-bottom: 1.5rem;
border: 1px solid var(--glass-border);
}
.form-section h3 { margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--glass-border); }
#global-search {
background: rgba(0, 0, 0, 0.3);
backdrop-filter: blur(10px);
border: 1px solid var(--glass-border);
transition: all 0.3s ease;
}
#global-search:focus {
background: rgba(0, 0, 0, 0.5);
border-color: var(--secondary-color);
box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
.autocomplete-container { position: relative; }
.autocomplete-suggestions {
position: absolute;
top: 100%; left: 0; right: 0;
background: rgba(17, 24, 39, 0.95);
border: 1px solid var(--glass-border);
border-radius: 8px;
max-height: 200px;
overflow-y: auto;
z-index: 50;
margin-top: 4px;
box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
display: none;
}
.autocomplete-suggestions.show { display: block; }
.autocomplete-item {
padding: 10px 12px;
color: #d1d5db;
cursor: pointer;
border-bottom: 1px solid rgba(59, 130, 246, 0.1);
transition: all 0.2s ease;
font-size: 14px;
}
.autocomplete-item:hover, .autocomplete-item.selected {
background-color: rgba(59, 130, 246, 0.2);
color: #60a5fa;
padding-left: 16px;
}
.autocomplete-item:last-child { border-bottom: none; }
.notification {
position: fixed;
top: 20px; right: 20px;
padding: 1rem;
border-radius: 8px;
color: white;
font-weight: 500;
z-index: 3000;
transform: translateX(150%);
transition: transform 0.3s ease;
}
.notification.show { transform: translateX(0); }
.notification.success { background-color: var(--success-color); }
.notification.error { background-color: rgba(239, 68, 68, 0.8); }
.notification.info { background-color: var(--secondary-color); }
.notification.warning { background-color: rgba(245, 158, 11, 0.8); }
.spinner {
border: 4px solid rgba(255, 255, 255, 0.3);
border-radius: 50%;
border-top: 4px solid var(--secondary-color);
width: 20px; height: 20px;
animation: spin 1s linear infinite;
margin: 0 auto;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.form-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; }
.logo-container { margin-right: 1.5rem; position: relative; width: 140px; height: 140px; }
.logo-3d { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transform: perspective(1000px); }
.logo-circle {
position: absolute;
width: 100%; height: 100%;
border-radius: 50%;
background: transparent;
box-shadow: 0 20px 60px rgba(59, 130, 246, 0.4), 0 10px 30px rgba(59, 130, 246, 0.3), 0 5px 15px rgba(0, 0, 0, 0.2);
display: flex; align-items: center; justify-content: center;
overflow: visible; border: none;
transform: translateZ(50px);
}
.logo-circle::before {
content: '';
position: absolute;
top: -10px; left: -10px;
width: 50px; height: 50px;
background: radial-gradient(circle, rgba(255, 255, 255, 0.6), transparent);
border-radius: 50%;
filter: blur(15px); z-index: -1;
}
.logo-image {
width: 100%; height: 100%;
position: relative;
transform: translateZ(60px);
filter: drop-shadow(0 15px 30px rgba(0, 0, 0, 0.5))
drop-shadow(0 8px 16px rgba(59, 130, 246, 0.6))
drop-shadow(0 0 40px rgba(59, 130, 246, 0.4));
transition: transform 0.3s ease;
}
.logo-image img { width: 100%; height: 100%; object-fit: contain; background: transparent; }
.logo-text {
position: absolute;
top: 50%; left: 50%;
transform: translate(-50%, -50%) translateZ(40px);
font-weight: bold; font-size: 20px;
color: var(--text-color);
text-shadow: 0 3px 6px rgba(0,0,0,0.6), 0 0 20px rgba(59, 130, 246, 0.4);
opacity: 1; z-index: 2;
}
.brand-text {
text-shadow: 3px 3px 6px rgba(0,0,0,0.4), 0 0 20px rgba(59, 130, 246, 0.3);
font-size: 2.5rem; letter-spacing: 0.05em;
}
.advanced-search-container { transition: all 0.3s ease; }
.advanced-search-container.hidden { max-height: 0; opacity: 0; overflow: hidden; }
.advanced-search-container:not(.hidden) { max-height: 500px; opacity: 1; }
.firebase-status {
position: fixed;
bottom: 20px;
right: 20px;
padding: 0.5rem 1rem;
border-radius: 8px;
font-size: 0.875rem;
font-weight: 500;
z-index: 2500;
transition: all 0.3s ease;
}
.firebase-status.connected {
background-color: rgba(16, 185, 129, 0.9);
color: white;
}
.firebase-status.disconnected {
background-color: rgba(239, 68, 68, 0.9);
color: white;
}
.firebase-status.syncing {
background-color: rgba(245, 158, 11, 0.9);
color: white;
}
@media (max-width: 768px) {
.logo-container { width: 80px; height: 80px; }
.brand-text { font-size: 1.5rem !important; }
header .ml-auto { display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem; }
.grid-cols-1.md\:grid-cols-4 { grid-template-columns: 1fr; }
.grid-cols-1.lg\:grid-cols-2 { grid-template-columns: 1fr; }
.row-actions { min-width: 120px; }
.action-button { width: auto; height: 28px; font-size: 0.7rem; padding: 2px 6px; }
table { font-size: 0.875rem; }
th, td { padding: 0.5rem !important; }
nav .flex.space-x-8 { overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: thin; }
.nav-tab { white-space: nowrap; flex-shrink: 0; }
input, select, textarea { min-height: 44px; font-size: 16px !important; }
.glass-modal { width: 95% !important; max-height: 90vh !important; overflow-y: auto !important; }
.p-6 { padding: 1rem !important; }
.p-4 { padding: 0.75rem !important; }
}
#print-modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: #fff;
color: #000;
z-index: 9999;
overflow-y: auto;
padding: 20px;
}
#print-modal.active {
display: block;
}
#print-content {
max-width: 800px;
margin: 0 auto;
padding: 20px;
}
.print-header {
text-align: center;
margin-bottom: 30px;
border-bottom: 2px solid #000;
padding-bottom: 20px;
}
.print-header img {
height: 80px;
margin-bottom: 10px;
}
.print-header h1 {
font-size: 24px;
margin: 5px 0;
color: #000;
}
.print-header p {
font-size: 14px;
margin: 2px 0;
color: #000;
}
.print-table {
width: 100%;
border-collapse: collapse;
margin-top: 20px;
font-size: 14px;
}
.print-table th, .print-table td {
border: 1px solid #000;
padding: 8px;
text-align: left;
}
.print-table th {
background-color: #f2f2f2;
font-weight: bold;
}
.print-table td.text-right, .print-table th.text-right {
text-align: right;
}
.print-total-row {
font-weight: bold;
background-color: #f9f9f9;
}
.print-back-btn {
display: block;
position: fixed;
bottom: 20px;
left: 50%;
transform: translateX(-50%);
background-color: #3b82f6;
color: white;
padding: 15px 30px;
border-radius: 50px;
text-decoration: none;
font-weight: bold;
font-size: 18px;
box-shadow: 0 4px 12px rgba(0,0,0,0.3);
z-index: 10000;
}
.print-actions {
position: fixed;
bottom: 20px;
left: 50%;
transform: translateX(-50%);
display: flex;
gap: 10px;
z-index: 10000;
}
.print-action-btn {
background-color: #3b82f6;
color: white;
padding: 12px 24px;
border-radius: 8px;
border: none;
font-weight: 600;
font-size: 14px;
cursor: pointer;
transition: all 0.3s ease;
box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.print-action-btn:hover {
background-color: #2563eb;
transform: translateY(-2px);
box-shadow: 0 6px 16px rgba(0,0,0,0.4);
}
.print-action-btn:nth-child(1) {
background-color: #ef4444;
}
.print-action-btn:nth-child(1):hover {
background-color: #dc2626;
}
.print-action-btn:nth-child(2) {
background-color: #10b981;
}
.print-action-btn:nth-child(2):hover {
background-color: #059669;
}
.print-action-btn:nth-child(3) {
background-color: #8b5cf6;
}
.print-action-btn:nth-child(3):hover {
background-color: #7c3aed;
}
@media print {
body * {
visibility: hidden !important;
}
#print-modal, #print-modal * {
visibility: visible !important;
}
#print-modal {
display: block !important;
position: absolute;
top: 0;
left: 0;
width: 100%;
height: auto;
overflow: visible;
}
.print-back-btn {
display: none !important;
}
#print-content {
margin: 0;
padding: 0;
width: 100%;
}
}
.cash-drawer-widget {
background: rgba(0, 0, 0, 0.3);
border: 1px solid rgba(59, 130, 246, 0.3);
border-radius: 12px;
padding: 1.5rem;
margin-bottom: 1.5rem;
}
.cash-display {
font-size: 1.5rem;
font-weight: bold;
color: #10b981;
text-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
}
.cash-display.negative {
color: #ef4444;
text-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
}
.switch {
position: relative;
display: inline-block;
width: 60px;
height: 34px;
}
.switch input {
opacity: 0;
width: 0;
height: 0;
}
.slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: #ccc;
transition: .4s;
border-radius: 34px;
}
.slider:before {
position: absolute;
content: "";
height: 26px;
width: 26px;
left: 4px;
bottom: 4px;
background-color: white;
transition: .4s;
border-radius: 50%;
}
input:checked + .slider {
background-color: #2196F3;
}
input:checked + .slider:before {
transform: translateX(26px);
}
</style>
</head>
<body>
<div id="print-modal">
<div id="print-content"></div>
<div class="print-actions">
<button onclick="printManager.generatePDF()" class="print-action-btn" title="Download as PDF">
PDF
</button>
<button onclick="window.print()" class="print-action-btn" title="Print Document">
PRINT
</button>
<button onclick="shareManager.shareOutstanding()" class="print-action-btn" title="Share Record">
SHARE
</button>
<button onclick="printManager.closePrintModal()" class="print-action-btn" title="Back to App">
BACK
</button>
</div>
</div>
<header class="glass p-4 sticky top-0 z-50 border-b border-blue-900/50">
<div class="max-w-7xl mx-auto flex items-center justify-between">
<div class="flex items-center">
<div class="logo-container">
<div class="logo-3d">
<div class="logo-circle">
<div class="logo-image">
<img src="logo.png" alt="Gulistan Logo">
</div>
</div>
</div>
</div>
<div class="ml-3">
<h1 class="text-3xl font-bold text-white brand-text">Gulistan</h1>
<p class="text-sm text-blue-300">Supermarket & Halal Meat</p>
</div>
</div>
<div class="ml-auto flex items-center space-x-4">
<div class="text-sm text-white hidden sm:block">
<i class="fas fa-calendar-alt mr-1"></i>
<span id="current-date"></span>
</div>
<div class="text-sm text-white hidden sm:block">
<i class="fas fa-clock mr-1"></i>
<span id="current-time"></span>
</div>
<div class="firebase-status" id="firebase-status">
<i class="fas fa-sync fa-spin mr-1"></i> Connecting...
</div>
</div>
</div>
</header>
<nav class="glass mt-4 p-4 mx-4 rounded-xl overflow-x-auto">
<div class="max-w-7xl mx-auto">
<div class="flex space-x-2 h-12 items-center min-w-max px-2">
<button class="nav-tab active" data-tab="expenses">
<i class="fas fa-receipt mr-1"></i> Expenses
</button>
<button class="nav-tab" data-tab="investments">
<i class="fas fa-hand-holding-usd mr-1"></i> Investments
</button>
<button class="nav-tab" data-tab="suppliers">
<i class="fas fa-truck mr-1"></i> Suppliers
</button>
<button class="nav-tab" data-tab="invoices">
<i class="fas fa-file-invoice-dollar mr-1"></i> Invoices
</button>
<button class="nav-tab" data-tab="exchange">
<i class="fas fa-exchange-alt mr-1"></i> Money Exchange
</button>
<button class="nav-tab" data-tab="cash">
<i class="fas fa-coins mr-1"></i> Current Cash
</button>
<button class="nav-tab" data-tab="outstanding">
<i class="fas fa-star mr-1"></i> Outstanding
</button>
</div>
</div>
</nav>
<main class="max-w-7xl mx-auto px-4 py-8">
<!-- Expenses Tab -->
<div id="expenses" class="tab-content active">
<div class="glass-card p-6 rounded-xl">
<h1 class="text-2xl font-bold mb-4 flex items-center text-white">
<i class="fas fa-receipt mr-2"></i> Shop Expenses
</h1>
<div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
<select id="expense-type" class="glass-select p-2">
<option value="">Select Expense Type</option>
<option value="Rent">Rent</option>
<option value="Utilities">Utilities</option>
<option value="Staff Salaries">Staff Salaries</option>
<option value="Inventory">Inventory</option>
<option value="Marketing">Marketing</option>
<option value="Maintenance">Maintenance</option>
<option value="Insurance">Insurance</option>
<option value="Taxes">Taxes</option>
<option value="Supplies">Supplies</option>
<option value="Cash in Drawer">Cash in Drawer</option>
<option value="Other">Other</option>
</select>
<input id="expense-desc" placeholder="Description" class="glass-input p-2" />
<input id="expense-amount" type="number" placeholder="Amount (Excl GST)" class="glass-input p-2" />
<input id="expense-date" type="date" class="glass-input p-2" />
</div>
<button onclick="return expenseManager.addExpense()" class="glass-button text-white px-4 py-2 mb-4 w-full md:w-auto">
<i class="fas fa-plus mr-1"></i> Add Expense
</button>
<div class="mb-4">
<div class="relative">
<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
<i class="fas fa-search text-gray-400"></i>
</div>
<input
type="text"
id="expenses-search"
placeholder="Search expenses..."
class="glass-input w-full pl-10 pr-10 py-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
/>
<button
id="expenses-clear-search"
class="absolute inset-y-0 right-0 pr-3 text-gray-400 hover:text-white transition-colors hidden"
title="Clear search"
>
<i class="fas fa-times"></i>
</button>
</div>
</div>
<div class="glass-table overflow-x-auto">
<table class="data-table">
<thead>
<tr>
<th>Date</th>
<th>Type</th>
<th>Description</th>
<th class="text-right">Amount</th>
<th class="text-center">Actions</th>
</tr>
</thead>
<tbody id="expenses-list">
<tr>
<td colspan="5" class="text-center">
<div class="spinner"></div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="text-right mt-4">
<h3 class="text-lg text-white">Total (Excl GST): <b id="total-excl">$0.00</b></h3>
<h3 class="text-xl text-blue-300">Total (Incl GST): <b id="total-incl">$0.00</b></h3>
</div>
</div>
</div>

<!-- Outstanding Tab -->
<div id="outstanding" class="tab-content">
<div class="glass-card p-6 rounded-xl">
<h1 class="text-2xl font-bold mb-6 text-white">Outstanding Records</h1>

<!-- Quick Add Record Form -->
<div class="form-section">
<h3 class="text-lg font-semibold mb-4 text-white">Add Outstanding Record</h3>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
<div>
<label class="form-label">Name / Client</label>
<div class="relative">
<input id="outstanding-name" class="glass-input p-3 w-full" placeholder="Enter name or select from history" autocomplete="off" />
<div id="outstanding-name-suggestions" class="autocomplete-suggestions"></div>
</div>
</div>
<div>
<label class="form-label">Amount</label>
<input id="outstanding-amount" type="number" class="glass-input p-3" placeholder="0.00" step="0.01" />
</div>
<div>
<label class="form-label">Description</label>
<input id="outstanding-desc" class="glass-input p-3" placeholder="Details or notes" />
</div>
<div>
<label class="form-label">Date</label>
<input id="outstanding-date" type="date" class="glass-input p-3" />
</div>
<div>
<label class="form-label">Status</label>
<select id="outstanding-status" class="glass-select p-3">
<option value="Outstanding">Outstanding</option>
<option value="Partial">Partial Payment</option>
<option value="Paid">Paid</option>
</select>
</div>
<div>
<label class="form-label">Payment Method</label>
<div class="flex gap-4 mt-2">
<label class="flex items-center gap-2 text-white cursor-pointer">
<input type="radio" name="payment-method" value="Cash" checked class="w-4 h-4"> Cash
</label>
<label class="flex items-center gap-2 text-white cursor-pointer">
<input type="radio" name="payment-method" value="Bank" class="w-4 h-4"> Bank
</label>
</div>
</div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<div>
<label class="form-label">Paid On Date</label>
<input id="outstanding-paid-date" type="date" class="glass-input p-3" disabled />
</div>
<div>
<label class="form-label">Amount Paid</label>
<input id="outstanding-amount-paid" type="number" class="glass-input p-3" placeholder="0.00" step="0.01" disabled />
</div>
</div>

<div class="flex gap-3 flex-wrap">
<button onclick="outstandingManager.addRecord()" class="glass-button bg-green-600 hover:bg-green-700 text-white px-6 py-2">
Add Record
</button>
<button onclick="outstandingManager.clearForm()" class="glass-button bg-gray-600 hover:bg-gray-700 text-white px-6 py-2">
Clear Form
</button>
</div>
</div>

<!-- Advanced Search Section -->
<div class="mt-8">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-semibold text-white">Records</h3>
<button onclick="outstandingManager.toggleAdvancedSearch()" class="glass-button bg-purple-600 hover:bg-purple-700 text-white px-4 py-2">
Advanced Search
</button>
</div>

<!-- Advanced Search Form -->
<div id="outstanding-advanced-search" class="advanced-search-container hidden mb-6">
<div class="form-section">
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
<div>
<label class="form-label">Search Name</label>
<input id="search-name" class="glass-input p-2" placeholder="Client name..." />
</div>
<div>
<label class="form-label">Status</label>
<select id="search-status" class="glass-select p-2">
<option value="">All Status</option>
<option value="Outstanding">Outstanding</option>
<option value="Partial">Partial Payment</option>
<option value="Paid">Paid</option>
</select>
</div>
<div>
<label class="form-label">Method</label>
<select id="search-method" class="glass-select p-2">
<option value="">All Methods</option>
<option value="Cash">Cash</option>
<option value="Bank">Bank</option>
</select>
</div>
<div>
<label class="form-label">Amount Min</label>
<input id="search-amount-from" type="number" class="glass-input p-2" placeholder="Minimum" />
</div>
<div>
<label class="form-label">Amount Max</label>
<input id="search-amount-to" type="number" class="glass-input p-2" placeholder="Maximum" />
</div>
</div>
<div class="flex gap-2 mt-4">
<button onclick="outstandingManager.applyAdvancedSearch()" class="glass-button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2">
Search
</button>
<button onclick="outstandingManager.resetSearch()" class="glass-button bg-gray-600 hover:bg-gray-700 text-white px-4 py-2">
Reset
</button>
</div>
</div>
</div>

<!-- Quick Search -->
<div class="mb-4">
<input id="outstanding-quick-search" type="text" placeholder="Quick search by name, ref, or amount..." class="glass-input w-full p-3 text-base" />
</div>

<!-- Records Table -->
<div class="glass-table overflow-x-auto">
<table class="data-table">
<thead>
<tr>
<th>Ref</th>
<th>Name</th>
<th>Date</th>
<th class="text-right">Amount</th>
<th class="text-right">Paid</th>
<th>Status</th>
<th>Method</th>
<th class="text-center">Actions</th>
</tr>
</thead>
<tbody id="outstanding-list">
<tr>
<td colspan="8" class="text-center py-8">Loading...</td>
</tr>
</tbody>
</table>
</div>

<!-- Summary Stats -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
<div class="glass-table p-4">
<p class="text-gray-300 text-sm mb-2">Total Outstanding</p>
<p class="text-2xl font-bold text-orange-400" id="stat-total-outstanding">$0.00</p>
</div>
<div class="glass-table p-4">
<p class="text-gray-300 text-sm mb-2">Total Paid</p>
<p class="text-2xl font-bold text-green-400" id="stat-total-paid">$0.00</p>
</div>
<div class="glass-table p-4">
<p class="text-gray-300 text-sm mb-2">Total Records</p>
<p class="text-2xl font-bold text-blue-400" id="stat-total-records">0</p>
</div>
<div class="glass-table p-4">
<p class="text-gray-300 text-sm mb-2">Remaining Due</p>
<p class="text-2xl font-bold text-red-400" id="stat-remaining-due">$0.00</p>
</div>
</div>

</div>
</div>

</main>
<!-- Modals and other elements -->
<div id="printOptionsModal" class="modal" style="display: none;">
<div class="modal-content">
<div class="modal-header">
<h2 class="modal-title">Print Options</h2>
<button class="modal-close" onclick="printManager.closePrintOptions()">
<i class="fas fa-times"></i>
</button>
</div>
<div class="p-4">
<p class="mb-4">Choose how to print this record:</p>
<div class="flex gap-4 justify-center">
<button class="glass-button text-slate-900 px-4 py-2 bg-white" onclick="printManager.printAsPDF()">
<i class="fas fa-file-pdf mr-2"></i> Export PDF
</button>
<button class="glass-button text-slate-900 px-4 py-2 bg-white" onclick="printManager.printAsPrint()">
<i class="fas fa-print mr-2"></i> Print
</button>
</div>
</div>
</div>
</div>
<div id="editModal" class="modal" style="display: none;">
<div class="modal-content">
<div class="modal-header">
<h2 class="modal-title">Edit Record</h2>
<button class="modal-close" onclick="uiManager.closeEditModal()">
<i class="fas fa-times"></i>
</button>
</div>
<div id="editModalBody"></div>
<div class="form-actions">
<button onclick="uiManager.closeEditModal()" class="glass-button" style="background: rgba(239, 68, 68, 0.7);">
Cancel
</button>
<button onclick="return uiManager.saveEdit()" class="glass-button bg-white text-slate-900 hover:bg-gray-100">
Save Changes
</button>
</div>
</div>
</div>
<div id="notification" class="notification"></div>
<script>
// ============================================
// ENHANCED FIREBASE INTEGRATION
// ============================================

const FirebaseService = {
    isConnected: false,
    listenersSetup: false,
    offlinePollInterval: null,
    offlineMode: false,
    lastSyncTime: null,
    collections: ['expenses', 'investments', 'suppliers', 'invoices', 'exchange', 'cash', 'outstanding'],
    
    // Initialize Firebase connection monitoring
    init: function() {
        // FIRST: Load any existing offline data
        console.log('üìÇ Loading offline data from browser storage...');
        this.collections.forEach(collectionName => {
            const data = LocalDB.getCollection(collectionName);
            if (data && data.length > 0) {
                console.log(`‚úÖ Found ${data.length} ${collectionName} records in offline storage`);
            }
        });
        
        // THEN: Try Firebase connection
        if (!window.FirebaseReady) {
            console.warn('‚ö†Ô∏è Firebase SDK not loading, using offline mode only');
            this.setupOfflineMode();
            return;
        }
        
        if (!window.FirebaseDataMigration) {
            console.warn('‚ö†Ô∏è Firebase not initialized, using offline mode only');
            this.setupOfflineMode();
            return;
        }
        
        console.log('üîó Attempting Firebase connection...');
        console.log('üìä Firebase Config:', {
            projectId: window.FirebaseDataMigration.firebaseDb.app.options.projectId,
            apiKey: window.FirebaseDataMigration.firebaseDb.app.options.apiKey ? 'set' : 'missing'
        });
        
        // First attempt immediately
        this.attemptConnection();
        
        // Set up periodic connection checks (every 30 seconds)
        setInterval(() => this.attemptConnection(), 30000);
        
        // Start offline mode for immediate functionality
        this.setupOfflineMode();
    },
    
    attemptConnection: function() {
        const fb = window.FirebaseDataMigration;
        
        // Try to read from Firestore to verify connection
        fb.getDocs(fb.collection(fb.firebaseDb, 'outstanding'))
            .then((snapshot) => {
                this.isConnected = true;
                this.updateStatus('connected');
                console.log(`‚úÖ Firebase Connected! (${snapshot.size} outstanding records)`);
                
                // Setup real-time listeners after successful connection
                if (!this.listenersSetup) {
                    this.setupRealtimeListeners();
                    this.listenersSetup = true;
                }
                
                // Log success in localStorage
                localStorage.setItem('firebase_last_success', new Date().toISOString());
            })
            .catch((error) => {
                // PERMANENT OFFLINE MODE: App works without Firebase
                console.warn('‚ö†Ô∏è Firebase unavailable, using offline mode');
                console.warn('Error details:', error.code, '-', error.message);
                
                // Enable offline mode - user can still add/edit/delete records locally
                this.isConnected = false;
                this.updateStatus('disconnected');
                
                // Load from localStorage and setup for offline use
                this.setupOfflineMode();
                
                // Log the error but don't block app functionality
                localStorage.setItem('firebase_last_error', new Date().toISOString() + ' - ' + error.code);
            });
    },
    
    setupOfflineMode: function() {
        // Setup listeners from localStorage instead
        console.log('üì± Offline Mode Activated - Using Local Storage');
        
        this.collections.forEach(collectionName => {
            try {
                // Load data from localStorage
                const data = LocalDB.getCollection(collectionName);
                if (data && data.length > 0) {
                    console.log(`‚úÖ Loaded ${collectionName}: ${data.length} records from local storage`);
                }
            } catch (e) {
                console.warn(`Could not load ${collectionName}:`, e.message);
            }
        });
        
        // Poll localStorage for changes (fallback listener)
        if (!this.offlinePollInterval) {
            this.offlinePollInterval = setInterval(() => {
                const data = LocalDB.getCollection('outstanding');
                if (data && data.length > 0) {
                    this.allRecords = data;
                    this.filteredRecords = data;
                    this.render(data);
                    this.updateStats();
                }
            }, 1000); // Check every second
        }
    },
    },
    
    monitorConnection: function() {
        if (!window.FirebaseReady) return;
        
        const fb = window.FirebaseDataMigration;
        
        // Check connection by attempting to read from a collection
        const connectionCheckInterval = setInterval(() => {
            fb.getDocs(fb.collection(fb.firebaseDb, 'expenses'))
                .then(() => {
                    if (!this.isConnected) {
                        this.isConnected = true;
                        this.updateStatus('connected');
                        console.log('‚úÖ Firebase connection established');
                    }
                })
                .catch((error) => {
                    this.isConnected = false;
                    this.updateStatus('disconnected');
                    console.warn('‚ùå Firebase connection lost:', error.message);
                });
        }, 5000); // Check every 5 seconds
        
        // Store interval ID for cleanup if needed
        this.connectionCheckInterval = connectionCheckInterval;
    },
    
    setupRealtimeListeners: function() {
        if (!this.isConnected || !window.FirebaseDataMigration) return;
        
        console.log('üîå Setting up real-time listeners for all collections...');
        this.collections.forEach(collectionName => {
            try {
                this.setupCollectionListener(collectionName);
            } catch (error) {
                console.error(`Failed to setup listener for ${collectionName}:`, error);
            }
        });
    },
    
    setupCollectionListener: function(collectionName) {
        if (!this.isConnected) return;
        
        const fb = window.FirebaseDataMigration;
        const colRef = fb.collection(fb.firebaseDb, collectionName);
        
        fb.onSnapshot(colRef, 
            (snapshot) => {
                // Process changes
                const changes = snapshot.docChanges();
                if (changes.length > 0) {
                    console.log(`üîÑ Firebase update detected in ${collectionName}: ${changes.length} changes`);
                    this.processChanges(collectionName, changes);
                }
                
                // Save to localStorage for offline access
                const records = [];
                snapshot.forEach(doc => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                
                LocalDB.saveCollection(collectionName, records);
                this.lastSyncTime = new Date();
                
                // Trigger UI refresh if on active tab
                this.refreshUIIfActive(collectionName);
            },
            (error) => {
                console.error(`‚ùå Firebase listener error for ${collectionName}:`, error);
                this.updateStatus('disconnected');
            }
        );
    },
    
    processChanges: function(collectionName, changes) {
        changes.forEach(change => {
            if (change.type === 'added') {
                console.log(`‚ûï Added document to ${collectionName}:`, change.doc.id);
            } else if (change.type === 'modified') {
                console.log(`‚úèÔ∏è Modified document in ${collectionName}:`, change.doc.id);
            } else if (change.type === 'removed') {
                console.log(`üóëÔ∏è Removed document from ${collectionName}:`, change.doc.id);
            }
        });
    },
    
    refreshUIIfActive: function(collectionName) {
        const activeTab = localStorage.getItem('gulistan_active_tab');
        const tabMap = {
            'expenses': 'expenses',
            'investments': 'investments',
            'suppliers': 'suppliers',
            'invoices': 'invoices',
            'exchange': 'exchange',
            'cash': 'cash',
            'outstanding': 'outstanding'
        };
        
        if (activeTab && tabMap[collectionName] === activeTab) {
            console.log(`üîÑ Refreshing UI for ${collectionName}`);
            switch(collectionName) {
                case 'expenses': expenseManager.loadExpenses(); break;
                case 'investments': investmentManager.loadInvestments(); break;
                case 'suppliers': supplierManager.loadSuppliers(); break;
                case 'invoices': invoiceManager.loadInvoices(); break;
                case 'exchange': exchangeManager.loadExchangeRecords(); break;
                case 'cash': cashManager.loadCashRecords(); break;
                case 'outstanding': outstandingManager.loadRecords(); break;
            }
        }
    },
    
    updateStatus: function(status) {
        const statusEl = document.getElementById('firebase-status');
        if (!statusEl) return;
        
        statusEl.className = `firebase-status ${status}`;
        
        switch(status) {
            case 'connected':
                statusEl.innerHTML = '<i class="fas fa-cloud mr-1"></i> Connected';
                break;
            case 'disconnected':
                statusEl.innerHTML = '<i class="fas fa-cloud-sun mr-1"></i> Offline Mode';
                break;
            case 'syncing':
                statusEl.innerHTML = '<i class="fas fa-sync fa-spin mr-1"></i> Syncing...';
                break;
        }
    },
    
    syncData: async function(collectionName) {
        if (!this.isConnected) {
            console.warn('‚ö† Cannot sync - Firebase not connected');
            return false;
        }
        
        this.updateStatus('syncing');
        
        try {
            const fb = window.FirebaseDataMigration;
            const snapshot = await fb.getDocs(fb.collection(fb.firebaseDb, collectionName));
            
            const records = [];
            snapshot.forEach(doc => {
                records.push({ id: doc.id, ...doc.data() });
            });
            
            LocalDB.saveCollection(collectionName, records);
            this.updateStatus('connected');
            console.log(`‚úì Synced ${records.length} records from ${collectionName}`);
            return true;
        } catch (error) {
            console.error(`‚ùå Error syncing ${collectionName}:`, error);
            this.updateStatus('disconnected');
            return false;
        }
    },
    
    syncAllCollections: async function() {
        if (!this.isConnected) return;
        
        console.log('üîÑ Starting full sync...');
        this.updateStatus('syncing');
        
        const promises = this.collections.map(col => this.syncData(col));
        await Promise.all(promises);
        
        this.updateStatus('connected');
        console.log('‚úì Full sync completed');
    }
};

// ============================================
// LOCAL STORAGE DATABASE (OFFLINE SUPPORT)
// ============================================

const LocalDB = {
    getCollection: function(collectionName) {
        try {
            const data = localStorage.getItem(`gulistan_${collectionName}`);
            const parsed = data ? JSON.parse(data) : [];
            return Array.isArray(parsed) ? parsed : [];
        } catch (error) {
            console.warn(`‚ö† Error parsing collection ${collectionName}:`, error);
            localStorage.removeItem(`gulistan_${collectionName}`);
            return [];
        }
    },
    
    saveCollection: function(collectionName, data) {
        try {
            localStorage.setItem(`gulistan_${collectionName}`, JSON.stringify(data));
        } catch (error) {
            console.error(`‚ùå Error saving collection ${collectionName}:`, error);
        }
    },
    
    addDocument: function(collectionName, docData) {
        try {
            let collection = this.getCollection(collectionName);
            if (!Array.isArray(collection)) {
                collection = [];
            }
            
            // Generate unique ID
            const id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            const newDoc = { id, ...docData, createdAt: new Date().toISOString() };
            
            collection.push(newDoc);
            this.saveCollection(collectionName, collection);
            
            return id;
        } catch (error) {
            console.error(`‚ùå Error adding document to ${collectionName}:`, error);
            return null;
        }
    },
    
    updateDocument: function(collectionName, docId, updateData) {
        try {
            const collection = this.getCollection(collectionName);
            const index = collection.findIndex(doc => doc.id === docId);
            
            if (index !== -1) {
                collection[index] = { ...collection[index], ...updateData, updatedAt: new Date().toISOString() };
                this.saveCollection(collectionName, collection);
                return true;
            }
            
            return false;
        } catch (error) {
            console.error(`‚ùå Error updating document in ${collectionName}:`, error);
            return false;
        }
    },
    
    deleteDocument: function(collectionName, docId) {
        try {
            const collection = this.getCollection(collectionName);
            const filtered = collection.filter(doc => doc.id !== docId);
            this.saveCollection(collectionName, filtered);
            return true;
        } catch (error) {
            console.error(`‚ùå Error deleting document from ${collectionName}:`, error);
            return false;
        }
    }
};

// ============================================
// ENHANCED DATABASE WRAPPER WITH FIREBASE
// ============================================

const db = {
    // Check if Firebase is available and connected
    isFirebaseAvailable: function() {
        return FirebaseService.isConnected && window.FirebaseDataMigration;
    },
    
    // Get Firebase instance
    getFirebase: function() {
        return window.FirebaseDataMigration;
    },
    
    // Collection wrapper with Firebase integration
    collection: function(name) {
        return {
            // Get all documents
            get: async function() {
                if (db.isFirebaseAvailable()) {
                    try {
                        const fb = db.getFirebase();
                        const snapshot = await fb.getDocs(fb.collection(fb.firebaseDb, name));
                        
                        const data = [];
                        snapshot.forEach(doc => {
                            data.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Save to localStorage for offline access
                        LocalDB.saveCollection(name, data);
                        
                        return {
                            empty: data.length === 0,
                            size: data.length,
                            docs: data.map(doc => ({
                                id: doc.id,
                                data: () => {
                                    const { id, ...rest } = doc;
                                    return rest;
                                }
                            })),
                            forEach: (callback) => {
                                data.forEach(doc => {
                                    callback({
                                        id: doc.id,
                                        data: () => {
                                            const { id, ...rest } = doc;
                                            return rest;
                                        }
                                    });
                                });
                            }
                        };
                    } catch (error) {
                        console.warn(`‚ö† Firebase read failed for ${name}:`, error.message);
                    }
                }
                
                // Fallback to localStorage
                const data = LocalDB.getCollection(name);
                return {
                    empty: data.length === 0,
                    size: data.length,
                    docs: data.map(doc => ({
                        id: doc.id,
                        data: () => {
                            const { id, ...rest } = doc;
                            return rest;
                        }
                    })),
                    forEach: (callback) => {
                        data.forEach(doc => {
                            callback({
                                id: doc.id,
                                data: () => {
                                    const { id, ...rest } = doc;
                                    return rest;
                                }
                            });
                        });
                    }
                };
            },
            
            // Get specific document
            doc: function(id) {
                return {
                    get: async function() {
                        if (db.isFirebaseAvailable()) {
                            try {
                                const fb = db.getFirebase();
                                const docRef = fb.doc(fb.collection(fb.firebaseDb, name), id);
                                const docSnap = await fb.getDoc(docRef);
                                
                                if (docSnap.exists()) {
                                    return {
                                        exists: true,
                                        id: docSnap.id,
                                        data: () => docSnap.data()
                                    };
                                }
                            } catch (error) {
                                console.warn(`‚ö† Firebase get failed for ${name}/${id}:`, error.message);
                            }
                        }
                        
                        // Fallback to localStorage
                        const doc = LocalDB.getCollection(name).find(d => d.id === id);
                        return {
                            exists: !!doc,
                            id: doc ? doc.id : null,
                            data: () => doc ? doc : {}
                        };
                    },
                    
                    // Set document (create or overwrite)
                    set: async function(data) {
                        if (db.isFirebaseAvailable()) {
                            try {
                                const fb = db.getFirebase();
                                const docRef = fb.doc(fb.collection(fb.firebaseDb, name), id);
                                await fb.setDoc(docRef, data);
                            } catch (error) {
                                console.warn(`‚ö† Firebase set failed for ${name}/${id}:`, error.message);
                            }
                        }
                        
                        // Always save to localStorage
                        LocalDB.updateDocument(name, id, data);
                        return Promise.resolve();
                    },
                    
                    // Update document
                    update: async function(data) {
                        if (db.isFirebaseAvailable()) {
                            try {
                                const fb = db.getFirebase();
                                const docRef = fb.doc(fb.collection(fb.firebaseDb, name), id);
                                await fb.updateDoc(docRef, data);
                            } catch (error) {
                                console.warn(`‚ö† Firebase update failed for ${name}/${id}:`, error.message);
                            }
                        }
                        
                        // Always save to localStorage
                        LocalDB.updateDocument(name, id, data);
                        return Promise.resolve();
                    },
                    
                    // Delete document
                    delete: async function() {
                        if (db.isFirebaseAvailable()) {
                            try {
                                const fb = db.getFirebase();
                                const docRef = fb.doc(fb.collection(fb.firebaseDb, name), id);
                                await fb.deleteDoc(docRef);
                            } catch (error) {
                                console.warn(`‚ö† Firebase delete failed for ${name}/${id}:`, error.message);
                            }
                        }
                        
                        // Always delete from localStorage
                        LocalDB.deleteDocument(name, id);
                        return Promise.resolve();
                    }
                };
            },
            
            // Add new document
            add: async function(data) {
                // First save to localStorage
                const localId = LocalDB.addDocument(name, data);
                
                if (db.isFirebaseAvailable()) {
                    try {
                        const fb = db.getFirebase();
                        const docRef = await fb.addDoc(fb.collection(fb.firebaseDb, name), {
                            ...data,
                            createdAt: fb.serverTimestamp()
                        });
                        
                        // Update localStorage with Firebase ID
                        LocalDB.updateDocument(name, localId, { ...data, firebaseId: docRef.id });
                        
                        return { id: docRef.id };
                    } catch (error) {
                        console.warn(`‚ö† Firebase add failed for ${name}:`, error.message);
                    }
                }
                
                return { id: localId };
            },
            
            // Real-time listener
            onSnapshot: function(handler) {
                if (db.isFirebaseAvailable()) {
                    try {
                        const fb = db.getFirebase();
                        const colRef = fb.collection(fb.firebaseDb, name);
                        
                        return fb.onSnapshot(colRef, (snapshot) => {
                            const records = [];
                            snapshot.forEach(doc => {
                                records.push({ id: doc.id, ...doc.data() });
                            });
                            
                            // Save to localStorage
                            LocalDB.saveCollection(name, records);
                            
                            // Call handler
                            handler(records);
                        });
                    } catch (err) {
                        console.warn(`‚ö† Failed to attach onSnapshot for ${name}:`, err.message);
                    }
                }
                
                // Fallback: poll localStorage
                let last = null;
                const intervalId = setInterval(() => {
                    const data = LocalDB.getCollection(name);
                    const json = JSON.stringify(data);
                    if (json !== last) {
                        last = json;
                        handler(data);
                    }
                }, 2000);
                
                return () => clearInterval(intervalId);
            }
        };
    }
};

// ============================================
// APP STATE AND UTILITIES
// ============================================

const appState = {
    currentEditId: null,
    currentEditCollection: null,
    today: new Date().toISOString().split('T')[0]
};

const utils = {
    formatDate: function(dateString) {
        if (!dateString || dateString === 'N/A') return 'N/A';
        
        // Handle Firebase Timestamp
        if (dateString && typeof dateString.toDate === 'function') {
            dateString = dateString.toDate().toISOString();
        }
        
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        return `${day}-${month}-${year}`;
    },
    
    formatCurrency: function(amount) {
        return '$' + parseFloat(amount || 0).toFixed(2);
    },
    
    parseDate: function(dateString) {
        if (!dateString) return null;
        
        // Handle Firebase Timestamp
        if (dateString && typeof dateString.toDate === 'function') {
            return dateString.toDate();
        }
        
        return new Date(dateString);
    }
};

// ============================================
// EXPENSES MANAGER
// ============================================

const expenseManager = {
    unsubscribe: null,
    
    init: function() {
        // Set up real-time listener
        this.unsubscribe = db.collection("expenses").onSnapshot((records) => {
            console.log(`üîÑ Expenses updated: ${records.length} records`);
            this.renderExpenses(records);
        });
    },
    
    loadExpenses: function() {
        const expensesList = document.getElementById('expenses-list');
        expensesList.innerHTML = `<tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>`;
        
        db.collection("expenses").get()
            .then(snapshot => {
                const docs = snapshot.docs || [];
                const records = docs.map(doc => ({ id: doc.id, ...doc.data() }));
                this.renderExpenses(records);
            })
            .catch(error => {
                console.error("‚ùå Error loading expenses:", error);
                uiManager.showNotification("Failed to load expenses", "error");
            });
    },
    
    renderExpenses: function(records) {
        const expensesList = document.getElementById('expenses-list');
        expensesList.innerHTML = '';
        
        if (!records || records.length === 0) {
            expensesList.innerHTML = `<tr><td colspan="5" class="text-center py-8">No expenses found</td></tr>`;
            document.getElementById('total-excl').textContent = '0.00';
            document.getElementById('total-incl').textContent = '0.00';
            return;
        }
        
        let totalExcl = 0;
        
        // Sort by date descending
        records.sort((a, b) => {
            const dateA = utils.parseDate(a.date);
            const dateB = utils.parseDate(b.date);
            return dateB - dateA;
        });
        
        records.forEach(record => {
            const row = document.createElement('tr');
            row.setAttribute('data-id', record.id);
            
            const amount = parseFloat(record.amount) || 0;
            totalExcl += amount;
            
            row.innerHTML = `
                <td>${utils.formatDate(record.date)}</td>
                <td><span class="px-2 py-1 bg-blue-900/50 text-blue-200 rounded text-xs border border-blue-500/30">${record.type || 'Other'}</span></td>
                <td>${record.description || 'N/A'}</td>
                <td class="text-right">${utils.formatCurrency(amount)}</td>
                <td class="text-center">${this.renderActions(record.id)}</td>
            `;
            
            expensesList.appendChild(row);
        });
        
        document.getElementById('total-excl').textContent = totalExcl.toFixed(2);
        document.getElementById('total-incl').textContent = (totalExcl * 1.1).toFixed(2);
    },
    
    renderActions: function(id) {
        return `
            <div class="row-actions">
                <button class="action-button edit" onclick="uiManager.openEditModal('${id}', 'expenses')" title="Edit" type="button">
                    <i class="fas fa-edit"></i><span>Edit</span>
                </button>
                <button class="action-button print" onclick="printManager.printRecord('${id}', 'expenses')" title="Print" type="button">
                    <i class="fas fa-print"></i><span>Print</span>
                </button>
                <button class="action-button share" onclick="shareManager.shareRecord('${id}', 'expenses')" title="Share" type="button">
                    <i class="fas fa-share-alt"></i><span>Share</span>
                </button>
                <button class="action-button delete" onclick="expenseManager.deleteExpense('${id}')" title="Delete" type="button">
                    <i class="fas fa-trash-alt"></i><span>Delete</span>
                </button>
            </div>
        `;
    },
    
    addExpense: function() {
        const type = document.getElementById('expense-type').value;
        const desc = document.getElementById('expense-desc').value;
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const date = document.getElementById('expense-date').value;
        
        // Validation
        if (!type || !desc || !amount || !date) {
            uiManager.showNotification("Please fill in all required fields", "error");
            return false;
        }
        
        if (isNaN(amount) || amount <= 0) {
            uiManager.showNotification("Please enter a valid amount", "error");
            return false;
        }
        
        const expenseData = {
            type: type,
            description: desc,
            amount: amount,
            date: date,
            createdAt: new Date().toISOString()
        };
        
        // Show syncing status
        FirebaseService.updateStatus('syncing');
        
        db.collection("expenses").add(expenseData)
            .then(() => {
                // Clear form
                document.getElementById('expense-type').value = '';
                document.getElementById('expense-desc').value = '';
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-date').value = appState.today;
                
                uiManager.showNotification("Expense added successfully", "success");
                FirebaseService.updateStatus('connected');
            })
            .catch(error => {
                console.error("‚ùå Error adding expense:", error);
                uiManager.showNotification("Failed to add expense", "error");
                FirebaseService.updateStatus('disconnected');
            });
        
        return false;
    },
    
    deleteExpense: function(id) {
        if (!confirm('Are you sure you want to delete this expense?')) return;
        
        FirebaseService.updateStatus('syncing');
        
        db.collection("expenses").doc(id).delete()
            .then(() => {
                uiManager.showNotification("Expense deleted successfully", "success");
                FirebaseService.updateStatus('connected');
            })
            .catch(error => {
                console.error("‚ùå Error deleting expense:", error);
                uiManager.showNotification("Failed to delete expense", "error");
                FirebaseService.updateStatus('disconnected');
            });
    }
};

// ============================================
// UI MANAGER
// ============================================

const uiManager = {
    init: function() {
        this.setDefaultDates();
        this.setupTabNavigation();
        this.setupDateTimeUpdate();
        this.setupModalCloseOnOutsideClick();
        
        // Initialize Firebase Service
        FirebaseService.init();
        
        // Initialize managers
        expenseManager.init();
    },
    
    setDefaultDates: function() {
        const dateInputs = [
            'expense-date', 'investment-date', 'supplier-date',
            'invoice-date', 'exchange-date', 'cash-date', 'outstanding-date'
        ];
        
        dateInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = appState.today;
        });
    },
    
    setupDateTimeUpdate: function() {
        const updateDateTime = () => {
            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            
            document.getElementById('current-date').textContent = 
                utils.formatDate(now.toISOString().split('T')[0]);
            document.getElementById('current-time').textContent = 
                now.toLocaleTimeString(undefined, timeOptions);
        };
        
        updateDateTime();
        setInterval(updateDateTime, 60000);
    },
    
    setupTabNavigation: function() {
        const savedTab = localStorage.getItem('gulistan_active_tab');
        if (savedTab) {
            this.switchTab(savedTab, false);
        }
        
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                this.switchTab(tabId);
            });
        });
    },
    
    switchTab: function(tabId, save = true) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        document.querySelectorAll('.nav-tab').forEach(navTab => {
            navTab.classList.remove('active');
        });
        
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.nav-tab[data-tab="${tabId}"]`).classList.add('active');
        
        if (save) {
            localStorage.setItem('gulistan_active_tab', tabId);
        }
        
        // Refresh data for tab
        switch(tabId) {
            case 'expenses': expenseManager.loadExpenses(); break;
            case 'outstanding': outstandingManager.loadRecords(); break;
            // Other tabs would be handled here
        }
    },
    
    setupModalCloseOnOutsideClick: function() {
        const modal = document.getElementById('editModal');
        if (modal) {
            modal.addEventListener('click', function(event) {
                if (event.target === this) uiManager.closeEditModal();
            });
        }
    },
    
    showNotification: function(message, type = 'success') {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    },
    
    openEditModal: function(id, collection) {
        const modal = document.getElementById('editModal');
        const modalBody = document.getElementById('editModalBody');
        
        appState.currentEditId = id;
        appState.currentEditCollection = collection;
        
        modalBody.innerHTML = '<div class="spinner"></div>';
        modal.style.display = 'flex';
        
        db.collection(collection).doc(id).get()
            .then(doc => {
                if (!doc.exists) throw new Error("Document does not exist!");
                this.renderEditForm(collection, doc.data());
            })
            .catch(error => {
                console.error("‚ùå Error getting document:", error);
                this.showNotification("Failed to load record for editing", "error");
                this.closeEditModal();
            });
    },
    
    renderEditForm: function(collection, data) {
        const modalBody = document.getElementById('editModalBody');
        let formHTML = '';
        
        switch(collection) {
            case 'expenses':
                formHTML = this.getExpenseEditForm(data);
                break;
            case 'outstanding':
                formHTML = this.getOutstandingEditForm(data);
                break;
            // Other collections would be handled here
        }
        
        modalBody.innerHTML = formHTML;
    },
    
    getExpenseEditForm: function(data) {
        return `
            <div class="form-group">
                <label class="form-label">Expense Type</label>
                <select id="edit-expense-type" class="glass-select p-2">
                    <option value="Rent" ${data.type === 'Rent' ? 'selected' : ''}>Rent</option>
                    <option value="Utilities" ${data.type === 'Utilities' ? 'selected' : ''}>Utilities</option>
                    <option value="Staff Salaries" ${data.type === 'Staff Salaries' ? 'selected' : ''}>Staff Salaries</option>
                    <option value="Inventory" ${data.type === 'Inventory' ? 'selected' : ''}>Inventory</option>
                    <option value="Marketing" ${data.type === 'Marketing' ? 'selected' : ''}>Marketing</option>
                    <option value="Maintenance" ${data.type === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                    <option value="Insurance" ${data.type === 'Insurance' ? 'selected' : ''}>Insurance</option>
                    <option value="Taxes" ${data.type === 'Taxes' ? 'selected' : ''}>Taxes</option>
                    <option value="Supplies" ${data.type === 'Supplies' ? 'selected' : ''}>Supplies</option>
                    <option value="Cash in Drawer" ${data.type === 'Cash in Drawer' ? 'selected' : ''}>Cash in Drawer</option>
                    <option value="Other" ${data.type === 'Other' ? 'selected' : ''}>Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input id="edit-expense-desc" class="glass-input p-2" value="${data.description || ''}">
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input id="edit-expense-amount" type="number" class="glass-input p-2" value="${data.amount || 0}">
            </div>
            <div class="form-group">
                <label class="form-label">Date</label>
                <input id="edit-expense-date" type="date" class="glass-input p-2" value="${data.date || appState.today}">
            </div>
        `;
    },
    
    getOutstandingEditForm: function(data) {
        return `
            <div class="form-group">
                <label class="form-label">Reference</label>
                <input id="edit-outstanding-ref" class="glass-input p-2" value="${data.ref || ''}" disabled>
            </div>
            <div class="form-group">
                <label class="form-label">Name / Client</label>
                <input id="edit-outstanding-name" class="glass-input p-2" value="${data.name || ''}">
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input id="edit-outstanding-amount" type="number" class="glass-input p-2" value="${data.amount || 0}">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input id="edit-outstanding-desc" class="glass-input p-2" value="${data.description || ''}">
            </div>
            <div class="form-group">
                <label class="form-label">Date</label>
                <input id="edit-outstanding-date" type="date" class="glass-input p-2" value="${data.date || appState.today}">
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="edit-outstanding-status" class="glass-select p-2" onchange="uiManager.updateOutstandingEditUI(this.value)">
                    <option value="Outstanding" ${data.status === 'Outstanding' ? 'selected' : ''}>Outstanding</option>
                    <option value="Partial" ${data.status === 'Partial' ? 'selected' : ''}>Partial Payment</option>
                    <option value="Paid" ${data.status === 'Paid' ? 'selected' : ''}>Paid</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Payment Method</label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 text-white">
                        <input type="radio" name="edit-payment-method" value="Cash" ${data.method === 'Cash' ? 'checked' : ''} class="w-4 h-4"> Cash
                    </label>
                    <label class="flex items-center gap-2 text-white">
                        <input type="radio" name="edit-payment-method" value="Bank" ${data.method === 'Bank' ? 'checked' : ''} class="w-4 h-4"> Bank
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Paid On Date</label>
                <input id="edit-outstanding-paid-date" type="date" class="glass-input p-2" value="${data.paidDate || ''}" ${data.status === 'Paid' ? '' : 'disabled'}>
            </div>
            <div class="form-group">
                <label class="form-label">Amount Paid</label>
                <input id="edit-outstanding-amount-paid" type="number" class="glass-input p-2" value="${data.paidAmount || 0}" ${data.status === 'Paid' ? '' : 'disabled'}>
            </div>
        `;
    },
    
    updateOutstandingEditUI: function(status) {
        const paidDate = document.getElementById('edit-outstanding-paid-date');
        const paidAmount = document.getElementById('edit-outstanding-amount-paid');
        
        if (status === 'Paid') {
            paidDate.disabled = false;
            paidAmount.disabled = false;
        } else {
            paidDate.disabled = true;
            paidAmount.disabled = true;
        }
    },
    
    closeEditModal: function() {
        const modal = document.getElementById('editModal');
        if (modal) {
            modal.style.display = 'none';
        }
        
        appState.currentEditId = null;
        appState.currentEditCollection = null;
    },
    
    saveEdit: function() {
        if (!appState.currentEditId || !appState.currentEditCollection) {
            this.showNotification("No record selected for editing", "error");
            return false;
        }
        
        let updateData = {};
        
        try {
            switch(appState.currentEditCollection) {
                case 'expenses':
                    updateData = {
                        type: document.getElementById('edit-expense-type').value,
                        description: document.getElementById('edit-expense-desc').value,
                        amount: parseFloat(document.getElementById('edit-expense-amount').value) || 0,
                        date: document.getElementById('edit-expense-date').value
                    };
                    break;
                case 'outstanding':
                    updateData = {
                        name: document.getElementById('edit-outstanding-name').value,
                        amount: parseFloat(document.getElementById('edit-outstanding-amount').value) || 0,
                        description: document.getElementById('edit-outstanding-desc').value,
                        date: document.getElementById('edit-outstanding-date').value,
                        status: document.getElementById('edit-outstanding-status').value,
                        method: document.querySelector('input[name="edit-payment-method"]:checked').value,
                        paidDate: document.getElementById('edit-outstanding-paid-date').value || null,
                        paidAmount: parseFloat(document.getElementById('edit-outstanding-amount-paid').value) || 0
                    };
                    break;
                // Other collections would be handled here
            }
            
            FirebaseService.updateStatus('syncing');
            
            db.collection(appState.currentEditCollection).doc(appState.currentEditId).update(updateData)
                .then(() => {
                    this.closeEditModal();
                    this.showNotification("Record updated successfully", "success");
                    FirebaseService.updateStatus('connected');
                    
                    // Refresh the current tab
                    const activeTab = localStorage.getItem('gulistan_active_tab');
                    switch(activeTab) {
                        case 'expenses': expenseManager.loadExpenses(); break;
                        case 'outstanding': outstandingManager.loadRecords(); break;
                        // Other tabs would be handled here
                    }
                })
                .catch(error => {
                    console.error("‚ùå Error updating document:", error);
                    this.showNotification("Failed to update record", "error");
                    FirebaseService.updateStatus('disconnected');
                });
        } catch (error) {
            console.error("‚ùå Error preparing update data:", error);
            this.showNotification("Invalid data. Please check your inputs.", "error");
            FirebaseService.updateStatus('disconnected');
        }
        
        return false;
    }
};

// ============================================
// PRINT MANAGER
// ============================================

const printManager = {
    currentId: null,
    currentCollection: null,
    currentData: null,
    
    closePrintModal: function() {
        document.getElementById('print-modal').classList.remove('active');
    },
    
    printRecord: function(id, collection) {
        this.currentId = id;
        this.currentCollection = collection;
        
        db.collection(collection).doc(id).get()
            .then(doc => {
                if (doc.exists) {
                    this.currentData = doc.data();
                    this.showPrintModal(this.generateHTML());
                } else {
                    uiManager.showNotification("Record not found", "error");
                }
            })
            .catch(error => {
                console.error("‚ùå Error fetching record:", error);
                uiManager.showNotification("Failed to load record", "error");
            });
    },
    
    generateHTML: function() {
        let rows = '';
        
        for (const [key, value] of Object.entries(this.currentData)) {
            let displayValue = value;
            
            // Format dates
            if (key.toLowerCase().includes('date') && value) {
                displayValue = utils.formatDate(value);
            }
            
            // Format currency
            if (key.toLowerCase().includes('amount') && typeof value === 'number') {
                displayValue = utils.formatCurrency(value);
            }
            
            rows += `
                <tr>
                    <td class="font-bold">${key.charAt(0).toUpperCase() + key.slice(1)}</td>
                    <td>${displayValue}</td>
                </tr>
            `;
        }
        
        return `
            <div class="print-header">
                <img src="logo.png" alt="Logo">
                <h1>Gulistan Supermarket & Halal Meat</h1>
                <p>187-189 Thomas st Dandenong VIC 3175</p>
                <p>Phone: (03) 9706 9999</p>
            </div>
            <h2>${this.currentCollection.charAt(0).toUpperCase() + this.currentCollection.slice(1)} Record</h2>
            <table class="print-table">
                <tbody>${rows}</tbody>
            </table>
            <div class="mt-8 text-center text-sm text-gray-500">
                Generated on: ${new Date().toLocaleString()}
            </div>
        `;
    },
    
    showPrintModal: function(contentHTML) {
        const modal = document.getElementById('print-modal');
        const contentDiv = document.getElementById('print-content');
        
        contentDiv.innerHTML = contentHTML;
        modal.classList.add('active');
    },
    
    closePrintOptions: function() {
        document.getElementById('printOptionsModal').style.display = 'none';
    },
    
    printAsPDF: function() {
        alert("Click 'Print' button below, then choose 'Save as PDF' from print dialog.");
    },
    
    printAsPrint: function() {
        window.print();
    }
};

// ============================================
// SHARE MANAGER
// ============================================

const shareManager = {
    shareRecord: function(id, collection) {
        db.collection(collection).doc(id).get()
            .then(doc => {
                if (!doc.exists) throw new Error("Document does not exist!");
                
                const data = doc.data();
                let message = 'Gulistan Store Record: ';
                
                switch(collection) {
                    case 'expenses':
                        message += `Expense: ${data.description} - ${utils.formatCurrency(data.amount)}`;
                        break;
                    // Other collections would be handled here
                }
                
                // Try native share API
                if (navigator.share) {
                    navigator.share({
                        title: 'Gulistan Store Record',
                        text: message
                    }).catch(console.error);
                } else {
                    // Fallback to clipboard
                    navigator.clipboard.writeText(message)
                        .then(() => {
                            uiManager.showNotification("Record details copied to clipboard");
                        })
                        .catch(() => {
                            uiManager.showNotification("Sharing not supported", "error");
                        });
                }
            })
            .catch(error => {
                console.error("‚ùå Error sharing record:", error);
                uiManager.showNotification("Failed to share record", "error");
            });
    }
};

// ============================================
// OUTSTANDING MANAGER
// ============================================

// ============================================
// INVESTMENT MANAGER
// ============================================

const investmentManager = {
    data: [],
    
    init: function() {
        this.loadInvestments();
    },
    
    async loadInvestments() {
        try {
            this.data = await FirebaseService.getData('investments');
            const container = document.getElementById('investmentList');
            if (!container) return;
            
            container.innerHTML = '';
            let total = 0;
            
            this.data.forEach(inv => {
                total += parseFloat(inv.amount) || 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${inv.name || 'N/A'}</td>
                    <td>${utils.formatDate(inv.date)}</td>
                    <td>${utils.formatCurrency(inv.amount)}</td>
                    <td>
                        <button class="edit-btn" onclick="uiManager.openEditModal('${inv.id}', 'investments')">Edit</button>
                        <button class="delete-btn" onclick="investmentManager.delete('${inv.id}')">Delete</button>
                    </td>
                `;
                container.appendChild(row);
            });
            
            document.getElementById('investmentTotal').textContent = utils.formatCurrency(total);
        } catch(e) {
            console.error('Error loading investments:', e);
        }
    },
    
    async addInvestment() {
        const name = document.getElementById('investmentName').value;
        const amount = parseFloat(document.getElementById('investmentAmount').value);
        const date = document.getElementById('investmentDate').value;
        
        if (!name || isNaN(amount)) {
            uiManager.showNotification('Please fill all fields', 'error');
            return;
        }
        
        await FirebaseService.saveData('investments', null, { name, amount, date });
        document.getElementById('investmentName').value = '';
        document.getElementById('investmentAmount').value = '';
        document.getElementById('investmentDate').value = appState.today;
        
        uiManager.showNotification('Investment added', 'success');
        this.loadInvestments();
    },
    
    async delete(id) {
        if (confirm('Delete this investment?')) {
            await FirebaseService.deleteData('investments', id);
            uiManager.showNotification('Investment deleted', 'success');
            this.loadInvestments();
        }
    }
};

// ============================================
// SUPPLIER MANAGER
// ============================================

const supplierManager = {
    data: [],
    
    init: function() {
        this.loadSuppliers();
    },
    
    async loadSuppliers() {
        try {
            this.data = await FirebaseService.getData('suppliers');
            const container = document.getElementById('supplierList');
            if (!container) return;
            
            container.innerHTML = '';
            
            this.data.forEach(supplier => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${supplier.name || 'N/A'}</td>
                    <td>${supplier.contact || 'N/A'}</td>
                    <td>${supplier.email || 'N/A'}</td>
                    <td>
                        <button class="edit-btn" onclick="uiManager.openEditModal('${supplier.id}', 'suppliers')">Edit</button>
                        <button class="delete-btn" onclick="supplierManager.delete('${supplier.id}')">Delete</button>
                    </td>
                `;
                container.appendChild(row);
            });
        } catch(e) {
            console.error('Error loading suppliers:', e);
        }
    },
    
    async addSupplier() {
        const name = document.getElementById('supplierName').value;
        const contact = document.getElementById('supplierContact').value;
        const email = document.getElementById('supplierEmail').value;
        
        if (!name) {
            uiManager.showNotification('Please fill supplier name', 'error');
            return;
        }
        
        await FirebaseService.saveData('suppliers', null, { name, contact, email });
        document.getElementById('supplierName').value = '';
        document.getElementById('supplierContact').value = '';
        document.getElementById('supplierEmail').value = '';
        
        uiManager.showNotification('Supplier added', 'success');
        this.loadSuppliers();
    },
    
    async delete(id) {
        if (confirm('Delete this supplier?')) {
            await FirebaseService.deleteData('suppliers', id);
            uiManager.showNotification('Supplier deleted', 'success');
            this.loadSuppliers();
        }
    }
};

// ============================================
// INVOICE MANAGER
// ============================================

const invoiceManager = {
    data: [],
    
    init: function() {
        this.loadInvoices();
    },
    
    async loadInvoices() {
        try {
            this.data = await FirebaseService.getData('invoices');
            const container = document.getElementById('invoiceList');
            if (!container) return;
            
            container.innerHTML = '';
            let total = 0;
            
            this.data.forEach(inv => {
                total += parseFloat(inv.amount) || 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${inv.invoiceNumber || 'N/A'}</td>
                    <td>${inv.customer || 'N/A'}</td>
                    <td>${utils.formatDate(inv.date)}</td>
                    <td>${utils.formatCurrency(inv.amount)}</td>
                    <td><span class="badge ${inv.status}">${inv.status || 'pending'}</span></td>
                    <td>
                        <button class="edit-btn" onclick="uiManager.openEditModal('${inv.id}', 'invoices')">Edit</button>
                        <button class="delete-btn" onclick="invoiceManager.delete('${inv.id}')">Delete</button>
                    </td>
                `;
                container.appendChild(row);
            });
            
            document.getElementById('invoiceTotal').textContent = utils.formatCurrency(total);
        } catch(e) {
            console.error('Error loading invoices:', e);
        }
    },
    
    async addInvoice() {
        const invoiceNumber = document.getElementById('invoiceNumber').value;
        const customer = document.getElementById('invoiceCustomer').value;
        const amount = parseFloat(document.getElementById('invoiceAmount').value);
        const date = document.getElementById('invoiceDate').value;
        const status = document.getElementById('invoiceStatus').value;
        
        if (!invoiceNumber || !customer || isNaN(amount)) {
            uiManager.showNotification('Please fill all fields', 'error');
            return;
        }
        
        await FirebaseService.saveData('invoices', null, { invoiceNumber, customer, amount, date, status });
        document.getElementById('invoiceNumber').value = '';
        document.getElementById('invoiceCustomer').value = '';
        document.getElementById('invoiceAmount').value = '';
        document.getElementById('invoiceDate').value = appState.today;
        
        uiManager.showNotification('Invoice added', 'success');
        this.loadInvoices();
    },
    
    async delete(id) {
        if (confirm('Delete this invoice?')) {
            await FirebaseService.deleteData('invoices', id);
            uiManager.showNotification('Invoice deleted', 'success');
            this.loadInvoices();
        }
    }
};

// ============================================
// EXCHANGE MANAGER
// ============================================

const exchangeManager = {
    data: [],
    
    init: function() {
        this.loadExchangeRecords();
    },
    
    async loadExchangeRecords() {
        try {
            this.data = await FirebaseService.getData('exchange');
            const container = document.getElementById('exchangeList');
            if (!container) return;
            
            container.innerHTML = '';
            
            this.data.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.fromCurrency || 'N/A'}</td>
                    <td>${utils.formatCurrency(record.fromAmount)}</td>
                    <td>${record.toCurrency || 'N/A'}</td>
                    <td>${utils.formatCurrency(record.toAmount)}</td>
                    <td>${record.rate || 'N/A'}</td>
                    <td>${utils.formatDate(record.date)}</td>
                    <td>
                        <button class="edit-btn" onclick="uiManager.openEditModal('${record.id}', 'exchange')">Edit</button>
                        <button class="delete-btn" onclick="exchangeManager.delete('${record.id}')">Delete</button>
                    </td>
                `;
                container.appendChild(row);
            });
        } catch(e) {
            console.error('Error loading exchange records:', e);
        }
    },
    
    async addExchange() {
        const fromCurrency = document.getElementById('fromCurrency').value;
        const fromAmount = parseFloat(document.getElementById('fromAmount').value);
        const toCurrency = document.getElementById('toCurrency').value;
        const toAmount = parseFloat(document.getElementById('toAmount').value);
        const date = document.getElementById('exchangeDate').value;
        
        if (!fromCurrency || isNaN(fromAmount) || !toCurrency || isNaN(toAmount)) {
            uiManager.showNotification('Please fill all fields', 'error');
            return;
        }
        
        const rate = (toAmount / fromAmount).toFixed(4);
        
        await FirebaseService.saveData('exchange', null, { fromCurrency, fromAmount, toCurrency, toAmount, rate, date });
        document.getElementById('fromCurrency').value = '';
        document.getElementById('fromAmount').value = '';
        document.getElementById('toCurrency').value = '';
        document.getElementById('toAmount').value = '';
        
        uiManager.showNotification('Exchange record added', 'success');
        this.loadExchangeRecords();
    },
    
    async delete(id) {
        if (confirm('Delete this exchange record?')) {
            await FirebaseService.deleteData('exchange', id);
            uiManager.showNotification('Exchange record deleted', 'success');
            this.loadExchangeRecords();
        }
    }
};

// ============================================
// CASH MANAGER
// ============================================

const cashManager = {
    data: [],
    balance: 0,
    
    init: function() {
        this.loadCashRecords();
    },
    
    async loadCashRecords() {
        try {
            this.data = await FirebaseService.getData('cash');
            const container = document.getElementById('cashList');
            if (!container) return;
            
            container.innerHTML = '';
            this.balance = 0;
            
            this.data.forEach(record => {
                const amount = parseFloat(record.amount) || 0;
                if (record.type === 'in') this.balance += amount;
                else this.balance -= amount;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.description || 'N/A'}</td>
                    <td><span class="badge ${record.type === 'in' ? 'success' : 'danger'}">${record.type.toUpperCase()}</span></td>
                    <td>${utils.formatCurrency(amount)}</td>
                    <td>${utils.formatDate(record.date)}</td>
                    <td>
                        <button class="edit-btn" onclick="uiManager.openEditModal('${record.id}', 'cash')">Edit</button>
                        <button class="delete-btn" onclick="cashManager.delete('${record.id}')">Delete</button>
                    </td>
                `;
                container.appendChild(row);
            });
            
            document.getElementById('cashBalance').textContent = utils.formatCurrency(this.balance);
        } catch(e) {
            console.error('Error loading cash records:', e);
        }
    },
    
    async addCashRecord() {
        const description = document.getElementById('cashDescription').value;
        const type = document.getElementById('cashType').value;
        const amount = parseFloat(document.getElementById('cashAmount').value);
        const date = document.getElementById('cashDate').value;
        
        if (!description || isNaN(amount)) {
            uiManager.showNotification('Please fill all fields', 'error');
            return;
        }
        
        await FirebaseService.saveData('cash', null, { description, type, amount, date });
        document.getElementById('cashDescription').value = '';
        document.getElementById('cashAmount').value = '';
        document.getElementById('cashDate').value = appState.today;
        
        uiManager.showNotification('Cash record added', 'success');
        this.loadCashRecords();
    },
    
    async delete(id) {
        if (confirm('Delete this cash record?')) {
            await FirebaseService.deleteData('cash', id);
            uiManager.showNotification('Cash record deleted', 'success');
            this.loadCashRecords();
        }
    }
};

const outstandingManager = {
    allRecords: [],
    filteredRecords: [],
    refCounter: 0,
    unsubscribe: null,
    
    init: function() {
        // Load ref counter
        this.refCounter = parseInt(localStorage.getItem('outstanding_ref_counter')) || 0;
        
        // Setup event listeners
        document.getElementById('outstanding-status').addEventListener('change', (e) => {
            this.togglePaidFields(e.target.value);
        });
        
        document.getElementById('outstanding-name').addEventListener('input', (e) => {
            this.showNameSuggestions(e.target.value);
        });
        
        document.getElementById('outstanding-quick-search').addEventListener('input', (e) => {
            this.quickSearch(e.target.value);
        });
        
        // Setup real-time listener
        this.unsubscribe = db.collection("outstanding").onSnapshot((records) => {
            this.allRecords = records;
            this.filteredRecords = records;
            this.render(records);
            this.updateStats();
        });
        
        this.loadRecords();
    },
    
    loadRecords: function() {
        db.collection("outstanding").get()
            .then(snapshot => {
                const docs = snapshot.docs || [];
                const records = docs.map(doc => ({ id: doc.id, ...doc.data() }));
                this.allRecords = records;
                this.filteredRecords = records;
                this.render(records);
                this.updateStats();
            })
            .catch(error => {
                console.error("Error loading outstanding records:", error);
                uiManager.showNotification("Failed to load records", "error");
            });
    },
    
    updateStatusUI: function(status) {
        const paidDateInput = document.getElementById('outstanding-paid-date');
        const paidAmountInput = document.getElementById('outstanding-amount-paid');
        
        if (status === 'Paid') {
            paidDateInput.disabled = false;
            paidAmountInput.disabled = false;
            paidDateInput.style.opacity = '1';
            paidAmountInput.style.opacity = '1';
        } else {
            paidDateInput.disabled = true;
            paidAmountInput.disabled = true;
            paidDateInput.style.opacity = '0.5';
            paidAmountInput.style.opacity = '0.5';
            paidDateInput.value = '';
            paidAmountInput.value = '';
        }
    },

    togglePaidFields: function(status) {
        // Alias for updateStatusUI for clarity
        this.updateStatusUI(status);
    },
    
    getNextRef: function() {
        this.refCounter++;
        localStorage.setItem('outstanding_ref_counter', this.refCounter);
        return 'Ref-' + String(this.refCounter).padStart(3, '0');
    },
    
    showNameSuggestions: function(value) {
        if (!value || value.length < 1) {
            document.getElementById('outstanding-name-suggestions').classList.remove('show');
            return;
        }
        
        const names = LocalDB.getCollection('outstanding')
            .map(r => r.name)
            .filter((n, i, arr) => arr.indexOf(n) === i && n.toLowerCase().includes(value.toLowerCase()))
            .slice(0, 5);
        
        const container = document.getElementById('outstanding-name-suggestions');
        if (names.length === 0) {
            container.classList.remove('show');
            return;
        }
        
        container.innerHTML = names.map(name => 
            `<div class="autocomplete-item" onclick="document.getElementById('outstanding-name').value = '${name}'; document.getElementById('outstanding-name-suggestions').classList.remove('show');">${name}</div>`
        ).join('');
        container.classList.add('show');
    },
    
    addRecord: function() {
        const name = document.getElementById('outstanding-name').value.trim();
        const amount = parseFloat(document.getElementById('outstanding-amount').value);
        const desc = document.getElementById('outstanding-desc').value.trim();
        const date = document.getElementById('outstanding-date').value;
        const status = document.getElementById('outstanding-status').value;
        const method = document.querySelector('input[name="payment-method"]:checked').value;
        const paidDate = document.getElementById('outstanding-paid-date').value;
        const paidAmount = parseFloat(document.getElementById('outstanding-amount-paid').value) || 0;
        
        if (!name || !amount || !date) {
            uiManager.showNotification("Please fill all required fields", "error");
            return false;
        }
        
        if (isNaN(amount) || amount <= 0) {
            uiManager.showNotification("Please enter a valid amount", "error");
            return false;
        }
        
        const ref = this.getNextRef();
        
        const record = {
            ref: ref,
            name: name,
            amount: amount,
            description: desc,
            date: date,
            status: status,
            method: method,
            paidDate: paidDate || null,
            paidAmount: status === 'Paid' ? paidAmount : 0,
            createdAt: new Date().toISOString()
        };
        
        FirebaseService.updateStatus('syncing');
        
        db.collection("outstanding").add(record)
            .then(() => {
                this.clearForm();
                uiManager.showNotification("Record added successfully! Ref: " + ref, "success");
                FirebaseService.updateStatus('connected');
            })
            .catch(error => {
                console.error("Error adding record:", error);
                uiManager.showNotification("Failed to add record", "error");
                FirebaseService.updateStatus('disconnected');
            });
        
        return false;
    },
    
    clearForm: function() {
        document.getElementById('outstanding-name').value = '';
        document.getElementById('outstanding-amount').value = '';
        document.getElementById('outstanding-desc').value = '';
        document.getElementById('outstanding-date').value = appState.today;
        document.getElementById('outstanding-status').value = 'Outstanding';
        document.getElementById('outstanding-paid-date').value = '';
        document.getElementById('outstanding-amount-paid').value = '';
        document.querySelector('input[name="payment-method"]').checked = true;
        this.updateStatusUI('Outstanding');
        document.getElementById('outstanding-name-suggestions').classList.remove('show');
    },
    
    render: function(records) {
        const list = document.getElementById('outstanding-list');
        
        if (!records || records.length === 0) {
            list.innerHTML = '<tr><td colspan="8" class="text-center py-8">No records found</td></tr>';
            return;
        }
        
        records.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        list.innerHTML = records.map(r => {
            const remaining = r.amount - (r.paidAmount || 0);
            const statusColor = r.status === 'Paid' ? 'bg-green-900' : r.status === 'Partial' ? 'bg-yellow-900' : 'bg-red-900';
            
            return `<tr>
                <td><span class="font-bold text-blue-400">${r.ref}</span></td>
                <td>${r.name}</td>
                <td>${utils.formatDate(r.date)}</td>
                <td class="text-right">${utils.formatCurrency(r.amount)}</td>
                <td class="text-right">${utils.formatCurrency(r.paidAmount || 0)}</td>
                <td><span class="px-2 py-1 ${statusColor} rounded text-xs">${r.status}</span></td>
                <td>${r.method}</td>
                <td class="text-center">${this.renderActions(r.id)}</td>
            </tr>`;
        }).join('');
    },
    
    renderActions: function(id) {
        return `
            <div class="row-actions">
                <button class="action-button" style="background: #22c55e;" onclick="outstandingManager.editRecord('${id}')" title="Edit">Edit</button>
                <button class="action-button" style="background: #3b82f6;" onclick="printManager.printOutstanding('${id}')" title="Print">Print</button>
                <button class="action-button" style="background: #a855f7;" onclick="shareManager.shareOutstanding('${id}')" title="Share">Share</button>
                <button class="action-button" style="background: #ef4444;" onclick="outstandingManager.deleteRecord('${id}')" title="Delete">Delete</button>
            </div>
        `;
    },
    
    editRecord: function(id) {
        uiManager.openEditModal(id, 'outstanding');
    },
    
    deleteRecord: function(id) {
        if (!confirm('Delete this record?')) return;
        
        FirebaseService.updateStatus('syncing');
        
        db.collection("outstanding").doc(id).delete()
            .then(() => {
                uiManager.showNotification("Record deleted", "success");
                FirebaseService.updateStatus('connected');
            })
            .catch(error => {
                console.error("Error deleting record:", error);
                uiManager.showNotification("Failed to delete record", "error");
                FirebaseService.updateStatus('disconnected');
            });
    },
    
    quickSearch: function(query) {
        if (!query) {
            this.filteredRecords = this.allRecords;
        } else {
            const q = query.toLowerCase();
            this.filteredRecords = this.allRecords.filter(r => 
                r.ref.toLowerCase().includes(q) ||
                r.name.toLowerCase().includes(q) ||
                r.amount.toString().includes(q) ||
                (r.description && r.description.toLowerCase().includes(q))
            );
        }
        this.render(this.filteredRecords);
        this.updateStats();
    },
    
    toggleAdvancedSearch: function() {
        document.getElementById('outstanding-advanced-search').classList.toggle('hidden');
    },
    
    applyAdvancedSearch: function() {
        const name = document.getElementById('search-name').value.toLowerCase();
        const status = document.getElementById('search-status').value;
        const method = document.getElementById('search-method').value;
        const minAmount = parseFloat(document.getElementById('search-amount-from').value) || 0;
        const maxAmount = parseFloat(document.getElementById('search-amount-to').value) || Infinity;
        
        this.filteredRecords = this.allRecords.filter(r => {
            if (name && !r.name.toLowerCase().includes(name)) return false;
            if (status && r.status !== status) return false;
            if (method && r.method !== method) return false;
            if (r.amount < minAmount || r.amount > maxAmount) return false;
            return true;
        });
        
        this.render(this.filteredRecords);
        this.updateStats();
    },
    
    resetSearch: function() {
        document.getElementById('search-name').value = '';
        document.getElementById('search-status').value = '';
        document.getElementById('search-method').value = '';
        document.getElementById('search-amount-from').value = '';
        document.getElementById('search-amount-to').value = '';
        document.getElementById('outstanding-quick-search').value = '';
        
        this.filteredRecords = this.allRecords;
        this.render(this.allRecords);
        this.updateStats();
    },
    
    updateStats: function() {
        let totalAmount = 0;
        let totalPaid = 0;
        
        this.filteredRecords.forEach(r => {
            totalAmount += r.amount || 0;
            totalPaid += r.paidAmount || 0;
        });
        
        const remaining = totalAmount - totalPaid;
        
        document.getElementById('stat-total-outstanding').textContent = utils.formatCurrency(totalAmount);
        document.getElementById('stat-total-paid').textContent = utils.formatCurrency(totalPaid);
        document.getElementById('stat-total-records').textContent = this.filteredRecords.length;
        document.getElementById('stat-remaining-due').textContent = utils.formatCurrency(remaining);
    }
};

// ============================================
// ENHANCED PRINT MANAGER WITH PDF
// ============================================

const printManagerEnhanced = Object.assign({}, printManager, {
    currentRecordData: null,
    currentRecordId: null,
    
    printOutstanding: function(id) {
        this.currentRecordId = id;
        
        db.collection("outstanding").doc(id).get()
            .then(doc => {
                if (!doc.exists) throw new Error("Record not found");
                
                const data = doc.data();
                this.currentRecordData = data;
                const html = this.generateOutstandingHTML(data);
                this.showPrintModal(html);
            })
            .catch(error => {
                console.error("Error fetching record:", error);
                uiManager.showNotification("Failed to load record", "error");
            });
    },
    
    generateOutstandingHTML: function(data) {
        const remaining = data.amount - (data.paidAmount || 0);
        const statusBg = data.status === 'Paid' ? '#10b981' : data.status === 'Partial' ? '#f59e0b' : '#ef4444';
        
        return `
            <div class="print-header">
                <img src="logo.png" alt="Logo" style="height: 80px; margin-bottom: 10px;">
                <h1 style="font-size: 24px; margin: 5px 0; color: #000;">Gulistan Supermarket & Halal Meat</h1>
                <p style="font-size: 14px; margin: 2px 0; color: #000;">187-189 Thomas St, Dandenong VIC 3175</p>
                <p style="font-size: 14px; margin: 2px 0; color: #000;">Phone: (03) 9706 9999</p>
            </div>
            
            <div style="margin-top: 30px; margin-bottom: 20px;">
                <h2 style="font-size: 20px; margin-bottom: 20px;">Outstanding Record</h2>
                
                <div style="margin-bottom: 20px;">
                    <strong style="display: inline-block; width: 150px;">Reference:</strong> ${data.ref}
                </div>
                
                <table class="print-table">
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px;"><strong>Client Name</strong></td>
                        <td style="border: 1px solid #000; padding: 8px;">${data.name}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px;"><strong>Date</strong></td>
                        <td style="border: 1px solid #000; padding: 8px;">${utils.formatDate(data.date)}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px;"><strong>Amount</strong></td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${utils.formatCurrency(data.amount)}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px;"><strong>Amount Paid</strong></td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: right;">${utils.formatCurrency(data.paidAmount || 0)}</td>
                    </tr>
                    <tr style="background-color: #f2f2f2;">
                        <td style="border: 1px solid #000; padding: 8px;"><strong>Remaining Due</strong></td>
                        <td style="border: 1px solid #000; padding: 8px; text-align: right;"><strong>${utils.formatCurrency(remaining)}</strong></td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px;"><strong>Status</strong></td>
                        <td style="border: 1px solid #000; padding: 8px; background-color: ${statusBg}; color: white;"><strong>${data.status}</strong></td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 8px;"><strong>Payment Method</strong></td>
                        <td style="border: 1px solid #000; padding: 8px;">${data.method}</td>
                    </tr>
                    ${data.paidDate ? `<tr>
                        <td style="border: 1px solid #000; padding: 8px;"><strong>Paid On</strong></td>
                        <td style="border: 1px solid #000; padding: 8px;">${utils.formatDate(data.paidDate)}</td>
                    </tr>` : ''}
                    ${data.description ? `<tr>
                        <td style="border: 1px solid #000; padding: 8px;"><strong>Description</strong></td>
                        <td style="border: 1px solid #000; padding: 8px;">${data.description}</td>
                    </tr>` : ''}
                </table>
            </div>
            
            <div style="margin-top: 40px; text-align: center; border-top: 2px solid #000; padding-top: 20px;">
                <p style="font-size: 12px; color: #666;">Generated on: ${new Date().toLocaleString()}</p>
            </div>
        `;
    },
    
    generatePDF: function() {
        if (!this.currentRecordData) {
            uiManager.showNotification("No record selected", "error");
            return;
        }
        
        const element = document.getElementById('print-content');
        const filename = `Gulistan_${this.currentRecordData.ref}_${new Date().getTime()}.pdf`;
        
        const opt = {
            margin: [10, 10, 10, 10],
            filename: filename,
            image: { type: 'png', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
        };
        
        if (window.html2pdf) {
            try {
                html2pdf().set(opt).from(element).save();
                uiManager.showNotification("PDF downloaded: " + filename, "success");
            } catch (error) {
                console.error("PDF generation error:", error);
                window.print(); // Fallback to print
            }
        } else {
            window.print();
        }
    }
});

// Merge enhanced print manager
Object.assign(printManager, printManagerEnhanced);

// ============================================
// ENHANCED SHARE MANAGER
// ============================================

const shareManagerEnhanced = Object.assign({}, shareManager, {
    shareOutstanding: function(id) {
        // If no ID provided, use current record from printManager
        if (!id) {
            id = printManager.currentRecordId;
            if (!id) {
                uiManager.showNotification("No record to share", "error");
                return;
            }
        }
        
        db.collection("outstanding").doc(id).get()
            .then(doc => {
                if (!doc.exists) throw new Error("Record not found");
                
                const data = doc.data();
                const remaining = data.amount - (data.paidAmount || 0);
                
                const message = `Gulistan Outstanding Record\nRef: ${data.ref}\nClient: ${data.name}\nAmount: ${utils.formatCurrency(data.amount)}\nPaid: ${utils.formatCurrency(data.paidAmount || 0)}\nRemaining: ${utils.formatCurrency(remaining)}\nStatus: ${data.status}`;
                
                this.shareVia(message, data);
            })
            .catch(error => {
                console.error("Error fetching record:", error);
                uiManager.showNotification("Failed to share record", "error");
            });
    },
    
    shareVia: function(message, data) {
        const encoded = encodeURIComponent(message);
        const url = encodeURIComponent(window.location.href);
        
        const options = [
            { name: 'WhatsApp', url: 'https://wa.me/?text=' + encoded },
            { name: 'Email', url: 'mailto:?subject=Gulistan%20Outstanding%20-' + data.ref + '&body=' + encoded },
            { name: 'Copy Text', action: () => this.copyToClipboard(message) }
        ];
        
        if (navigator.share) {
            navigator.share({
                title: 'Gulistan - ' + data.ref,
                text: message,
                url: window.location.href
            }).catch(() => {
                this.showShareMenu(options);
            });
        } else {
            this.showShareMenu(options);
        }
    },
    
    showShareMenu: function(options) {
        let html = '<div style="text-align: center; padding: 20px;">';
        html += '<h3>Share Record</h3>';
        html += '<p style="margin: 10px 0; color: #999; font-size: 12px;">Click an option to share:</p>';
        options.forEach(opt => {
            if (opt.action) {
                html += `<button onclick="shareManager.${opt.action.name || opt.name.toLowerCase().replace(/\s/g, '')}()" style="display: block; width: 100%; padding: 10px; margin: 5px 0; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">${opt.name}</button>`;
            } else {
                html += `<a href="${opt.url}" target="_blank" style="display: block; width: 100%; padding: 10px; margin: 5px 0; background: #3b82f6; color: white; border-radius: 6px; text-decoration: none;">${opt.name}</a>`;
            }
        });
        html += '</div>';
        console.log('Share options available');
        uiManager.showNotification("Share options copied to clipboard", "success");
    },
    
    copyToClipboard: function(text) {
        navigator.clipboard.writeText(text)
            .then(() => uiManager.showNotification("Record details copied!", "success"))
            .catch(() => uiManager.showNotification("Failed to copy", "error"));
    }
});

Object.assign(shareManager, shareManagerEnhanced);

// ============================================
// INITIALIZE APP
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing Gulistan Management System...');
    uiManager.init();
    expenseManager.loadExpenses();
    outstandingManager.init();
    
    // Set up periodic sync
    setInterval(() => {
        if (FirebaseService.isConnected) {
            console.log('üîÑ Performing periodic sync...');
            FirebaseService.syncAllCollections();
        }
    }, 300000); // Every 5 minutes
});

</script>
</body>
</html>