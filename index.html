<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e3a8a">
    <title>Gulistan Supermarket & Halal Meat - Management System</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #3b82f6;
            --dark: #0f172a;
            --glass: rgba(15, 23, 42, 0.7);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #020617 0%, #1e293b 100%);
            color: #f1f5f9;
            min-height: 100vh;
            -webkit-user-select: text;
            user-select: text;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .glass {
            background: var(--glass);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
        }
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            color: white;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .btn-primary { background: var(--secondary); }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 14px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        /* Safari date/time input styling */
        input[type="date"],
        input[type="time"],
        input[type="datetime-local"],
        input[type="month"],
        input[type="week"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        /* Safari number input remove spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .input:focus { outline: none; border-color: var(--secondary); }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            min-width: 600px;
        }
        th {
            background: rgba(0, 0, 0, 0.3);
            text-align: left;
            border-bottom: 2px solid var(--secondary);
            font-weight: 600;
        }
        tr:hover { background: rgba(59, 130, 246, 0.05); }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .tab-btn {
            padding: 8px 16px;
            background: rgba(59, 130, 246, 0.2);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            margin-right: 8px;
        }
        .tab-btn.active {
            background: var(--secondary);
        }
        .tab-btn:hover {
            background: var(--secondary);
        }
        .tab-content {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--glass);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            z-index: 2000;
            display: none;
        }
        .notification.show { display: block; }
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .tab { display: none; }
        .tab.active { display: block; }
        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #cbd5e1;
            padding: 10px 0;
        }
        .spinner {
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .nav-tab {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #cbd5e1;
            cursor: pointer;
            border-radius: 6px;
            margin-right: 10px;
            transition: all 0.2s;
        }
        .nav-tab:hover { background: rgba(255, 255, 255, 0.2); }
        .nav-tab.active {
            background: var(--secondary);
            color: white;
            font-weight: 600;
        }
        /* Print styles */
        @media print {
            body { background: white; color: black; }
            .no-print { display: none !important; }
            .print-header { display: block !important; }
            .glass { background: white !important; border: none !important; }
            table th { background: #f3f4f6 !important; color: #111827 !important; border-bottom-color: #e5e7eb !important; }
            table td { border-bottom-color: #e5e7eb !important; color: #111827 !important; }
        }
        .print-header { display: none; text-align: center; margin-bottom: 16px; }
        .toolbar-btn { font-size: 12px; padding: 6px 10px; }
        
        /* Action buttons responsive wrapper */
        .action-buttons {
            display: flex;
            flex-direction: row;
            gap: 6px;
            flex-wrap: wrap;
            max-width: 100%;
        }
        
        @media (max-width: 480px) {
            .action-buttons {
                gap: 3px;
                flex-wrap: nowrap;
                flex-direction: row;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                justify-content: flex-start;
                align-items: center;
            }
            .toolbar-btn {
                padding: 2px 3px !important;
                font-size: 11px !important;
                min-width: 28px;
                min-height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }
            .toolbar-btn i { font-size: 14px; }
        }
        
        @media (max-width: 340px) {
            .action-buttons {
                gap: 2px;
                flex-wrap: nowrap;
                flex-direction: row;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                align-items: center;
            }
            .toolbar-btn {
                padding: 2px 3px !important;
                font-size: 9px !important;
                min-width: 24px;
                min-height: 24px;
                flex-shrink: 0;
            }
            .toolbar-btn i { font-size: 12px; }
        }
        
        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            body { font-size: 14px; }
            .max-w-7xl { padding: 8px; }
            h1 { font-size: 24px !important; }
            h2 { font-size: 18px !important; }
            h3 { font-size: 16px !important; }
            h4, h5, h6 { font-size: 14px !important; }
            .glass { padding: 12px !important; margin-bottom: 12px !important; }
            .modal-content {
                width: 95%;
                max-width: 100%;
                padding: 20px;
                max-height: 90vh;
            }
            .modal-header { margin-bottom: 15px; }
            .form-group { margin-bottom: 12px; }
            .form-label { font-size: 12px; }
            .input { padding: 8px; font-size: 14px; }
            .btn { padding: 8px 12px; font-size: 12px; }
            .toolbar-btn { font-size: 11px; padding: 4px 6px; }
            table { margin: 12px 0; }
            th, td { padding: 6px 4px !important; font-size: 12px; }
            .tab-btn { padding: 6px 12px; font-size: 12px; margin-right: 4px; }
            .nav-tab { padding: 8px 12px; font-size: 12px; }
            .badge { font-size: 11px; padding: 3px 10px; }
            .notification { top: 10px; right: 10px; padding: 10px 15px; font-size: 12px; }
            .text-sm { font-size: 12px !important; }
            .text-xs { font-size: 10px !important; }
            .flex { flex-wrap: wrap; }
            .gap-4 { gap: 8px; }
            .gap-2 { gap: 4px; }
            .overflow-x-auto { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .grid { gap: 8px !important; }
            
            /* Responsive grid columns */
            .grid-cols-1.md\:grid-cols-4 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
            .grid-cols-1.md\:grid-cols-7 { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
            .grid-cols-1.md\:grid-cols-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            
            /* Action buttons stack on mobile */
            .flex.gap-2 { flex-wrap: wrap; }
            
            /* Ensure company group headers are readable */
            [style*="display:flex"][style*="justify-content:space-between"] {
                flex-direction: column;
                gap: 8px !important;
            }
            
            /* Make tables scrollable horizontally on mobile */
            .overflow-x-auto {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
            .overflow-x-auto > div > table,
            .overflow-x-auto table { 
                display: table;
                width: 100%;
                table-layout: auto;
            }
            .overflow-x-auto table th,
            .overflow-x-auto table td {
                white-space: nowrap;
            }
        }
        
        @media (max-width: 480px) {
            body { font-size: 13px; }
            h1 { font-size: 20px !important; }
            h2 { font-size: 16px !important; }
            h3 { font-size: 14px !important; }
            h4, h5, h6 { font-size: 12px !important; }
            .glass { padding: 10px !important; margin-bottom: 10px !important; }
            .modal-content { padding: 15px; }
            .modal-header { margin-bottom: 15px; }
            .form-label { font-size: 11px; }
            .form-group { margin-bottom: 10px; }
            .input { padding: 6px; font-size: 13px; }
            .btn { padding: 6px 10px; font-size: 11px; }
            .toolbar-btn { font-size: 10px; padding: 3px 5px; }
            .nav-tab { padding: 6px 10px; font-size: 11px; }
            .tab-btn { padding: 4px 10px; font-size: 11px; margin-right: 2px; }
            th, td { padding: 4px 2px !important; font-size: 11px; }
            .badge { font-size: 10px; padding: 2px 8px; }
            .notification { top: 8px; right: 8px; padding: 8px 12px; font-size: 11px; }
            .text-sm { font-size: 11px !important; }
            .text-xs { font-size: 9px !important; }
            .text-2xl { font-size: 18px !important; }
            .text-3xl { font-size: 20px !important; }
            .flex.items-center.justify-between { flex-direction: column; align-items: flex-start; gap: 8px; }
            .form-group { margin-bottom: 10px; }
            
            /* Enhanced table scrolling for very small screens */
            table { 
                min-width: 500px;
            }
            
            /* Vertical layout for form groups */
            .grid { grid-template-columns: 1fr !important; }
            
            /* Stack company header info vertically */
            [style*="display:flex"] { flex-wrap: wrap; }
        }
        
        /* Extra small devices (320px and below) */
        @media (max-width: 340px) {
            body { font-size: 12px; }
            h1 { font-size: 18px !important; }
            h2 { font-size: 14px !important; }
            h3 { font-size: 12px !important; }
            .glass { padding: 8px !important; margin-bottom: 8px !important; }
            .modal-content { padding: 12px; }
            .form-label { font-size: 10px; }
            .input { padding: 5px; font-size: 12px; }
            .btn { padding: 5px 8px; font-size: 10px; }
            .toolbar-btn { font-size: 9px; padding: 2px 4px; }
            .nav-tab { padding: 5px 8px; font-size: 10px; }
            .tab-btn { padding: 3px 8px; font-size: 10px; }
            th, td { padding: 3px 1px !important; font-size: 10px; }
            .badge { font-size: 9px; padding: 1px 6px; }
            .text-sm { font-size: 10px !important; }
            .text-xs { font-size: 8px !important; }
            .text-2xl { font-size: 16px !important; }
            .text-3xl { font-size: 18px !important; }
        }
        
        /* Touch-friendly adjustments */
        @media (hover: none) and (pointer: coarse) {
            .btn { padding: 12px 16px; min-height: 44px; }
            .input { padding: 12px; min-height: 44px; }
            .tab-btn { padding: 10px 16px; min-height: 44px; }
            .toolbar-btn { min-height: 40px; min-width: 40px; }
            th, td { padding: 8px 6px !important; }
        }
        
        /* Cross-browser compatibility tweaks */
        select { 
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 20px;
            padding-right: 32px;
        }
        
        /* Firefox focus outline fix */
        @-moz-document url-prefix() {
            .input { -moz-outline: none; }
        }
        
        /* Edge smooth scrolling */
        html { scroll-behavior: smooth; }
        
        /* Safari text selection styling */
        ::selection {
            background: rgba(59, 130, 246, 0.5);
            color: white;
        }
        ::-moz-selection {
            background: rgba(59, 130, 246, 0.5);
            color: white;
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto p-4 sm:p-6">
        <!-- Header -->
        <div class="glass p-6 mb-6 rounded-xl">
            <div class="flex items-center justify-between gap-4 flex-wrap">
                <div class="flex items-center gap-3">
                    <img src="logo.png" alt="Logo" class="w-16 h-16 md:w-12 md:h-12 rounded-xl object-cover" onerror="this.style.display='none'" style="flex-shrink:0">
                    <div>
                        <h1 class="text-3xl font-bold mb-1">Gulistan Supermarket & Halal Meat</h1>
                        <p class="text-gray-400 text-sm">Management System</p>
                    </div>
                </div>
                <div class="flex-1 min-w-[160px]" id="firebase-status" style="display:none">
                    <p class="text-sm" id="connection-status">Connecting...</p>
                    <p class="text-xs text-gray-400" id="build-version"></p>
                </div>
                <div class="flex items-center gap-2 flex-wrap justify-end"></div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="glass p-4 mb-6 rounded-xl overflow-x-auto">
            <div class="flex gap-2 whitespace-nowrap">
                <button class="nav-tab active" data-tab="expenses"><i class="fas fa-receipt mr-2"></i>Expenses</button>
                <button class="nav-tab" data-tab="investments"><i class="fas fa-hand-holding-usd mr-2"></i>Investments</button>
                <button class="nav-tab" data-tab="suppliers"><i class="fas fa-truck mr-2"></i>Suppliers</button>
                <button class="nav-tab" data-tab="invoices"><i class="fas fa-file-invoice mr-2"></i>Invoices</button>
                <button class="nav-tab" data-tab="exchange"><i class="fas fa-exchange-alt mr-2"></i>Exchange</button>
                <button class="nav-tab" data-tab="cash"><i class="fas fa-coins mr-2"></i>Cash</button>
                <button class="nav-tab" data-tab="outstanding"><i class="fas fa-star mr-2"></i>Outstanding</button>
            </div>
        </div>

        <!-- Content -->
        <div class="tab active" id="tab-expenses">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-receipt mr-2"></i>Expenses</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" id="expense-desc" class="input" placeholder="Expense description" list="expenses-list">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="expense-amount" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="expense-date" class="input">
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addExpense()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <div id="expenses-totals" class="text-sm text-gray-300"></div>
                <div class="overflow-x-auto">
                    <div id="expenses-table"></div>
                </div>
            </div>
        </div>

        <div class="tab" id="tab-investments">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-hand-holding-usd mr-2"></i>Investments</h2>
                <div class="grid grid-cols-1 md:grid-cols-7 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" id="inv-name" class="input" placeholder="Investment description">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Investor</label>
                        <select id="inv-investor" class="input">
                            <option>Haji Hayat</option>
                            <option>Abbas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="inv-amount" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Paid to</label>
                        <select id="inv-paid-to" class="input">
                            <option>Shop</option>
                            <option>Real Estate</option>
                            <option>Cash</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="inv-date" class="input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Method</label>
                        <select id="inv-method" class="input">
                            <option>Cash</option>
                            <option>Bank Transfer</option>
                        </select>
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addInvestment()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>

                <!-- Tabs for switching views -->
                <div class="flex gap-2 mb-4 border-b border-gray-600 pb-2">
                    <button class="tab-btn active" onclick="switchInvTab('all')" id="tab-btn-all">All</button>
                    <button class="tab-btn" onclick="switchInvTab('hayat')" id="tab-btn-hayat">Haji Hayat</button>
                    <button class="tab-btn" onclick="switchInvTab('abbas')" id="tab-btn-abbas">Abbas</button>
                </div>

                <!-- All Investments -->
                <div id="inv-all" class="tab-content">
                    <div class="flex items-center gap-2 mb-2">
                        <input id="investments-search" class="input" placeholder="Search investments" style="max-width:320px">
                        <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForTable('investments')"><i class="fas fa-eye mr-1"></i>Preview</button>
                        <button class="btn btn-primary toolbar-btn no-print" onclick="printTable('investments')"><i class="fas fa-print mr-1"></i>Print</button>
                        <button class="btn btn-success toolbar-btn no-print" onclick="exportInvestmentsPDF('all')"><i class="fas fa-file-pdf mr-1"></i>PDF</button>
                        <button class="btn btn-primary toolbar-btn no-print" onclick="exportCSV('investments')"><i class="fas fa-file-export mr-1"></i>Export</button>
                        <button class="btn btn-primary toolbar-btn no-print" onclick="shareTable('investments')"><i class="fas fa-share-alt mr-1"></i>Share</button>
                    </div>
                    <div class="overflow-x-auto">
                        <div id="investments-table"></div>
                    </div>
                    <div id="investments-totals" class="text-sm text-gray-300 mt-2 font-semibold"></div>
                </div>

                <!-- Haji Hayat -->
                <div id="inv-hayat" class="tab-content" style="display:none;">
                    <div class="flex items-center gap-2 mb-2">
                        <input id="inv-hayat-search" class="input" placeholder="Search Haji Hayat" style="max-width:320px">
                        <button class="btn btn-primary toolbar-btn no-print" onclick="shareInvestorTab('hayat')"><i class="fas fa-share-alt mr-1"></i>Share</button>
                        <button class="btn btn-primary toolbar-btn no-print" onclick="printInvestorTab('hayat')"><i class="fas fa-print mr-1"></i>Print</button>
                        <button class="btn btn-success toolbar-btn no-print" onclick="exportInvestmentsPDF('hayat')"><i class="fas fa-file-pdf mr-1"></i>PDF</button>
                    </div>
                    <div class="overflow-x-auto">
                        <div id="investments-hayat-table"></div>
                    </div>
                    <div id="inv-hayat-totals" class="text-sm text-gray-300 mt-2 font-semibold"></div>
                </div>

                <!-- Abbas -->
                <div id="inv-abbas" class="tab-content" style="display:none;">
                    <div class="flex items-center gap-2 mb-2">
                        <input id="inv-abbas-search" class="input" placeholder="Search Abbas" style="max-width:320px">
                        <button class="btn btn-primary toolbar-btn no-print" onclick="shareInvestorTab('abbas')"><i class="fas fa-share-alt mr-1"></i>Share</button>
                        <button class="btn btn-primary toolbar-btn no-print" onclick="printInvestorTab('abbas')"><i class="fas fa-print mr-1"></i>Print</button>
                        <button class="btn btn-success toolbar-btn no-print" onclick="exportInvestmentsPDF('abbas')"><i class="fas fa-file-pdf mr-1"></i>PDF</button>
                    </div>
                    <div class="overflow-x-auto">
                        <div id="investments-abbas-table"></div>
                    </div>
                    <div id="inv-abbas-totals" class="text-sm text-gray-300 mt-2 font-semibold"></div>
                </div>
            </div>
        </div>

        <div class="tab" id="tab-suppliers">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-truck mr-2"></i>Suppliers</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" id="supp-name" class="input" placeholder="Company name" list="companies-list">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="text" id="supp-phone" class="input" placeholder="0422622642">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Product Details</label>
                        <input type="text" id="supp-details" class="input" placeholder="Product Details">
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addSupplier()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <!-- Quick add companies into suppliers -->
                <div class="flex items-center gap-2 mb-2">
                    <select id="suppliers-quick-select" class="input" style="max-width:320px"></select>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="addSupplierQuick()"><i class="fas fa-plus mr-1"></i>Quick Add</button>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <input id="suppliers-search" class="input" placeholder="Search suppliers" style="max-width:320px">
                    <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForTable('suppliers')"><i class="fas fa-eye mr-1"></i>Preview</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="printTable('suppliers')"><i class="fas fa-print mr-1"></i>Print</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="exportCSV('suppliers')"><i class="fas fa-file-export mr-1"></i>Export</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="shareTable('suppliers')"><i class="fas fa-share-alt mr-1"></i>Share</button>
                </div>
                <div class="overflow-x-auto">
                    <div id="suppliers-table"></div>
                </div>
                <div id="suppliers-totals" class="text-sm text-gray-300 mt-2"></div>
            </div>
        </div>

        <div class="tab" id="tab-invoices">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-file-invoice mr-2"></i>Invoices</h2>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">Invoice #</label>
                        <input type="text" id="inv-num" class="input" placeholder="Invoice number">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company</label>
                        <input type="text" id="inv-customer" class="input" placeholder="Company name" list="companies-list" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="inv-price" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">GST Type</label>
                        <select id="inv-gst-type" class="input">
                            <option value="include">include</option>
                            <option value="exclude">exclude</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Paid</label>
                        <select id="inv-paid" class="input">
                            <option value="No">Not Paid</option>
                            <option value="Full">Paid Full</option>
                            <option value="Half">Paid Half</option>
                            <option value="Partially">Paid Partially</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount Paid</label>
                        <input type="number" id="inv-amount-paid" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Paid On</label>
                        <input type="date" id="inv-paid-on" class="input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Method</label>
                        <select id="inv-payment-method" class="input">
                            <option value="cash">cash</option>
                            <option value="bank">bank</option>
                            <option value="card">card</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">BSB</label>
                        <input type="text" id="inv-bsb" class="input" placeholder="033174">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Account</label>
                        <input type="text" id="inv-account" class="input" placeholder="Account number">
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addInvoice()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <input id="invoices-search" class="input" placeholder="Search invoices" style="max-width:320px">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-300">GST %</label>
                        <input id="gst-rate" class="input" type="number" value="10" min="0" max="100" style="width:90px">
                    </div>
                    <button class="btn btn-success toolbar-btn no-print" onclick="expandAllInvoiceGroups()" title="Expand All Groups"><i class="fas fa-expand-alt mr-1"></i>Expand All</button>
                    <button class="btn btn-danger toolbar-btn no-print" onclick="collapseAllInvoiceGroups()" title="Collapse All Groups"><i class="fas fa-compress-alt mr-1"></i>Collapse All</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForTable('invoices')"><i class="fas fa-eye mr-1"></i>Preview</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="printTable('invoices')"><i class="fas fa-print mr-1"></i>Print</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="exportCSV('invoices')"><i class="fas fa-file-export mr-1"></i>Export</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="shareTable('invoices')"><i class="fas fa-share-alt mr-1"></i>Share</button>
                </div>
                <div class="overflow-x-auto">
                    <div id="invoices-table"></div>
                </div>
                <div id="invoices-totals" class="text-sm text-gray-300 mt-2"></div>
            </div>
        </div>

        <div class="tab" id="tab-exchange">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-exchange-alt mr-2"></i>Money Exchange</h2>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
                    <div class="form-group md:col-span-2">
                        <label class="form-label">Amount (AUD)</label>
                        <input type="number" id="exc-amount" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Service</label>
                        <select id="exc-service" class="input">
                            <option>RIA</option>
                            <option>Western Union</option>
                            <option>Money Gram</option>
                            <option>Hawala</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cash Type</label>
                        <select id="exc-type" class="input">
                            <option value="in">Cash In</option>
                            <option value="out">Cash Out</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="exc-status" class="input">
                            <option>Pending</option>
                            <option>Paid</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Paid On</label>
                        <input type="date" id="exc-paid-on" class="input" disabled>
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addExchange()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <input id="exchange-search" class="input" placeholder="Search exchange" style="max-width:320px">
                    <select id="exchange-service-filter" class="input" style="max-width:200px">
                        <option value="all">All Services</option>
                        <option value="RIA">RIA</option>
                        <option value="Western Union">Western Union</option>
                        <option value="Money Gram">Money Gram</option>
                        <option value="Hawala">Hawala</option>
                    </select>
                    <select id="exchange-cash-filter" class="input" style="max-width:160px">
                        <option value="all">All Cash</option>
                        <option value="in">Cash In</option>
                        <option value="out">Cash Out</option>
                    </select>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForTable('exchange')"><i class="fas fa-eye mr-1"></i>Preview</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="printTable('exchange')"><i class="fas fa-print mr-1"></i>Print</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="exportCSV('exchange')"><i class="fas fa-file-export mr-1"></i>Export</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="shareTable('exchange')"><i class="fas fa-share-alt mr-1"></i>Share</button>
                </div>
                <div class="overflow-x-auto">
                    <div id="exchange-table"></div>
                </div>
                <div id="exchange-totals" class="text-sm text-gray-300 mt-2"></div>
            </div>
        </div>

        <div class="tab" id="tab-cash">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-coins mr-2"></i>Cash Drawer</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" id="cash-desc" class="input" placeholder="Description">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select id="cash-type" class="input">
                            <option value="in">Cash In</option>
                            <option value="out">Cash Out</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="cash-amount" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addCash()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <div id="cash-totals" class="text-sm text-gray-300"></div>
                <div class="overflow-x-auto">
                    <div id="cash-table"></div>
                </div>
            </div>
        </div>

        <div class="tab" id="tab-outstanding">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-star mr-2"></i>Outstanding</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">Customer</label>
                        <input type="text" id="out-customer" class="input" placeholder="Customer name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="out-amount" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="out-date" class="input">
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addOutstanding()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <button class="btn btn-success toolbar-btn no-print" onclick="expandAllOutstandingGroups()" title="Expand All Groups"><i class="fas fa-expand-alt mr-1"></i>Expand All</button>
                    <button class="btn btn-danger toolbar-btn no-print" onclick="collapseAllOutstandingGroups()" title="Collapse All Groups"><i class="fas fa-compress-alt mr-1"></i>Collapse All</button>
                </div>
                <div id="outstanding-totals" class="text-sm text-gray-300"></div>
                <div class="overflow-x-auto">
                    <div id="outstanding-table"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>
    <!-- Datalists -->
    <datalist id="expenses-list">
        <option value="Insurance"></option>
        <option value="Store Rent"></option>
        <option value="Utilities"></option>
        <option value="Electricity"></option>
        <option value="Water"></option>
        <option value="Internet"></option>
        <option value="Maintenance"></option>
        <option value="Supplies"></option>
        <option value="Salaries"></option>
        <option value="Taxes"></option>
        <option value="Marketing"></option>
        <option value="Waste Disposal"></option>
        <option value="Security"></option>
        <option value="Cleaning"></option>
        <option value="Licenses"></option>
        <option value="Repairs"></option>
        <option value="Bank Fees"></option>
    </datalist>
    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-xl font-bold">Edit Record</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-form"></form>
            <div class="mt-4 flex justify-between gap-2">
                <button class="btn btn-primary" id="payment-history-btn" style="display:none;" onclick="openPaymentHistoryModal(editState.id, document.querySelector('[name=\'num\']')?.value)" type="button"><i class="fas fa-history mr-2"></i>Payment History</button>
                <div class="flex gap-2">
                    <button class="btn btn-danger" onclick="closeEditModal()" type="button">Cancel</button>
                    <button class="btn btn-success" onclick="saveEdits(event)" type="submit">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment History Modal -->
    <div id="payment-history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-xl font-bold">Payment History</h3>
                <button class="modal-close" onclick="closePaymentHistoryModal()">&times;</button>
            </div>
            <div id="payment-history-content" style="max-height: 400px; overflow-y: auto;"></div>
            <div class="mt-4 mb-4">
                <h4 class="text-lg font-bold mb-3">Record New Payment</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="payment-amount" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Paid On</label>
                        <input type="date" id="payment-date" class="input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Method</label>
                        <select id="payment-method" class="input">
                            <option value="cash">Cash</option>
                            <option value="bank">Bank</option>
                            <option value="card">Card</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <button class="btn btn-danger" onclick="closePaymentHistoryModal()" type="button">Close</button>
                <button class="btn btn-success" onclick="recordPayment()" type="button">Record Payment</button>
            </div>
        </div>
    </div>

    <!-- Print Preview Overlay -->
    <div id="print-overlay" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 95%;">
            <div class="modal-header">
                <h3 class="text-xl font-bold">Print Preview</h3>
                <button class="modal-close" onclick="closePrintPreview()">&times;</button>
            </div>
            <div class="mb-4 no-print flex gap-2 justify-end">
                <button class="btn btn-primary toolbar-btn" onclick="printFromOverlay()"><i class="fas fa-print mr-1"></i>Print</button>
                <button class="btn btn-primary toolbar-btn" onclick="printFromOverlay()"><i class="fas fa-file-pdf mr-1"></i>Save as PDF</button>
                <button class="btn btn-primary toolbar-btn" onclick="shareFromOverlay()"><i class="fas fa-share-alt mr-1"></i>Share</button>
                <button class="btn btn-danger toolbar-btn" onclick="closePrintPreview()">Back to App</button>
            </div>
            <div id="print-content" class="glass p-4" style="background:white;color:#111827"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBcHY8XLvoaKVyilWHwfNdOYpqGQ9Gswik",
            authDomain: "gulistan-store.firebaseapp.com",
            projectId: "gulistan-store",
            storageBucket: "gulistan-store.firebasestorage.app",
            messagingSenderId: "626332439320",
            appId: "1:626332439320:web:a44e7b219d3418baed846d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // LocalDB Fallback
        const LocalDB = {
            getCollection(name) {
                try { return JSON.parse(localStorage.getItem(`gulistan_${name}`) || '[]'); }
                catch(e) { return []; }
            },
            saveCollection(name, data) {
                try { localStorage.setItem(`gulistan_${name}`, JSON.stringify(data)); }
                catch(e) { console.warn('LocalDB save error (Tracking Prevention?):', e); }
            },
            addDoc(name, data) {
                const id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                const col = this.getCollection(name);
                col.push({ id, ...data, createdAt: new Date().toISOString() });
                this.saveCollection(name, col);
                return id;
            },
            updateDoc(name, id, data) {
                const col = this.getCollection(name);
                const idx = col.findIndex(d => d.id === id);
                if (idx !== -1) {
                    col[idx] = { ...col[idx], ...data };
                    this.saveCollection(name, col);
                }
            },
            deleteDoc(name, id) {
                const col = this.getCollection(name).filter(d => d.id !== id);
                this.saveCollection(name, col);
            },
            getDoc(name, id) {
                return this.getCollection(name).find(d => d.id === id);
            }
        };

        // No auth â€“ read/write Firestore directly per your preference

        // Utilities
        function getGstRate() {
            const el = document.getElementById('gst-rate');
            const val = el ? parseFloat(el.value || '10') : 10;
            return (isNaN(val) ? 10 : val) / 100;
        }
        function normalizeName(name) {
            return (name || '').trim().replace(/\s+/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        }
        function notify(message, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.className = `notification ${type} show`;
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // Map logical tab names to Firestore collection names
        const CollectionMap = { outstanding: 'customers' };
        const CloudNameCandidates = {
            expenses: ['expenses', 'Expenses', 'Expense'],
            investments: ['investments', 'Investments', 'Investment'],
            suppliers: ['suppliers', 'Suppliers', 'Supplier'],
            invoices: ['invoices', 'Invoices', 'Invoice'],
            payments: ['payments', 'Payments', 'Payment'],
            exchange: ['exchange', 'Exchange'],
            cash: ['cash', 'Cash'],
            outstanding: ['customers', 'Outstanding', 'outstanding'],
            outstanding_payments: ['customer_payments', 'outstanding_payments', 'OutstandingPayments']
        };
        const CloudNameCacheKey = 'gulistan_cloud_names';
        function getCloudNameCache() {
            try { return JSON.parse(localStorage.getItem(CloudNameCacheKey) || '{}'); } catch { return {}; }
        }
        function setCloudNameCache(obj) {
            try { localStorage.setItem(CloudNameCacheKey, JSON.stringify(obj || {})); }
            catch(e) { console.warn('Cloud cache save error:', e); }
        }
        const resolveColl = (name) => {
            const cache = getCloudNameCache();
            return cache[name] || CollectionMap[name] || name;
        };

        // Field name mapping (cloud <-> local) per collection
        const FieldMapKey = 'gulistan_field_map';
        function getFieldMap() {
            try { return JSON.parse(localStorage.getItem(FieldMapKey) || '{}'); } catch { return {}; }
        }
        function setFieldMap(obj) {
            try { localStorage.setItem(FieldMapKey, JSON.stringify(obj || {})); }
            catch(e) { console.warn('Field map save error:', e); }
        }
        // Map a cloud doc to local keys
        function mapRead(collection, doc) {
            const fm = getFieldMap()[collection] || {};
            const mapped = { ...doc };
            Object.entries(fm).forEach(([localKey, cloudKey]) => {
                if (cloudKey in doc) {
                    mapped[localKey] = doc[cloudKey];
                }
            });
            // Special handling for investments: cloud 'name' holds investor
            if (collection === 'investments') {
                mapped.investor = mapped.investor ?? doc.name ?? mapped.investor;
                mapped.amount = mapped.amount ?? doc.amount ?? mapped.amount;
                mapped.date = mapped.date ?? doc.date ?? mapped.date;
            }
            // Special handling for invoices
            if (collection === 'invoices') {
                mapped.amount = mapped.amount ?? doc.totalAmount ?? doc.netAmount ?? mapped.amount;
                if (typeof mapped.paid === 'undefined' && typeof doc.status !== 'undefined') {
                    mapped.paid = (doc.status === 'paid') ? 'Yes' : 'No';
                }
                mapped.num = mapped.num ?? doc.invoiceNumber ?? mapped.num;
                mapped.customer = mapped.customer ?? doc.customer ?? mapped.customer;
                mapped.date = mapped.date ?? doc.date ?? mapped.date;
                mapped.paymentMethod = mapped.paymentMethod ?? doc.paymentMethod ?? mapped.paymentMethod;
                mapped.bsb = mapped.bsb ?? doc.bsb ?? mapped.bsb;
                // Set default amountPaid and amountUnpaid if missing
                const totalAmt = parseFloat(mapped.amount) || 0;
                if (typeof mapped.amountPaid === 'undefined' || mapped.amountPaid === null) {
                    mapped.amountPaid = (mapped.paid === 'Full' || mapped.paid === 'Yes') ? totalAmt : 0;
                }
                if (typeof mapped.amountUnpaid === 'undefined' || mapped.amountUnpaid === null) {
                    mapped.amountUnpaid = totalAmt - (parseFloat(mapped.amountPaid) || 0);
                }
            }
            return mapped;
        }
        // Map a local doc to cloud keys
        function mapWrite(collection, doc) {
            const fm = getFieldMap()[collection] || {};
            const mapped = { ...doc };
            Object.entries(fm).forEach(([localKey, cloudKey]) => {
                if (localKey in doc) {
                    mapped[cloudKey] = doc[localKey];
                }
            });
            // Special handling for investments: write investor to cloud 'name'
            if (collection === 'investments') {
                if (typeof mapped.name === 'undefined' && typeof doc.investor !== 'undefined') mapped.name = doc.investor;
                if (typeof mapped.amount === 'undefined' && typeof doc.amount !== 'undefined') mapped.amount = doc.amount;
                if (typeof mapped.date === 'undefined' && typeof doc.date !== 'undefined') mapped.date = doc.date;
            }
            // Special handling for invoices
            if (collection === 'invoices') {
                mapped.invoiceNumber = mapped.invoiceNumber ?? doc.num;
                mapped.totalAmount = mapped.totalAmount ?? doc.amount;
                mapped.status = mapped.status ?? ((doc.paid !== 'No') ? 'paid' : 'unpaid');
                // Ensure numeric GST fields
                if (typeof mapped.gstRate === 'undefined' && typeof doc.gstRate !== 'undefined') mapped.gstRate = doc.gstRate;
                if (typeof mapped.gstAmount === 'undefined' && typeof doc.gstAmount !== 'undefined') mapped.gstAmount = doc.gstAmount;
                if (typeof mapped.netAmount === 'undefined' && typeof doc.netAmount !== 'undefined') mapped.netAmount = doc.netAmount;
                if (typeof mapped.amountPaid === 'undefined' && typeof doc.amountPaid !== 'undefined') mapped.amountPaid = doc.amountPaid;
                if (typeof mapped.amountUnpaid === 'undefined' && typeof doc.amountUnpaid !== 'undefined') mapped.amountUnpaid = doc.amountUnpaid;
            }
            // Remove undefined values before sending to Firebase
            Object.keys(mapped).forEach(key => {
                if (mapped[key] === undefined) {
                    delete mapped[key];
                }
            });
            return mapped;
        }

        // Column schemas per collection (label + formatting)
        const Schema = {
            expenses: {
                columns: [
                    { key: 'desc', label: 'Description' },
                    { key: 'amount', label: 'Amount', type: 'currency' },
                    { key: 'date', label: 'Date', type: 'date' }
                ],
                totals: [{ key: 'amount', label: 'Total' }]
            },
            investments: {
                columns: [
                    { key: 'name', label: 'Description' },
                    { label: 'Haji Hayat', type: 'currency', value: r => (r.investor === 'Haji Hayat' ? (parseFloat(r.amount)||0) : 0) },
                    { label: 'Abbas', type: 'currency', value: r => (r.investor === 'Abbas' ? (parseFloat(r.amount)||0) : 0) },
                    { key: 'paidTo', label: 'Paid to' },
                    { key: 'date', label: 'Date', type: 'date' },
                    { key: 'method', label: 'Method' }
                ],
                totals: [
                    { key: 'amount', label: 'Total' },
                    { key: 'amount', label: 'Haji Hayat Total', filter: r => (r.investor === 'Haji Hayat') },
                    { key: 'amount', label: 'Abbas Total', filter: r => (r.investor === 'Abbas') }
                ]
            },
            suppliers: {
                columns: [
                    { key: 'name', label: 'Name' },
                    { key: 'phone', label: 'Phone' },
                    { key: 'details', label: 'Product Details' }
                ]
            },
            invoices: {
                columns: [
                    { key: 'num', label: 'Invoice #' },
                    { key: 'customer', label: 'Company' },
                    { key: 'amount', label: 'Amount', type: 'currency' },
                    { label: 'Amount Paid', type: 'currency', value: r => {
                        const payments = LocalDB.getCollection('payments').filter(p => String(p.invoiceNum).trim() === String(r.num).trim());
                        return payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                    }},
                    { label: 'Balance', type: 'currency', value: r => {
                        const total = parseFloat(r.amount) || 0;
                        const payments = LocalDB.getCollection('payments').filter(p => String(p.invoiceNum).trim() === String(r.num).trim());
                        const paid = payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                        return Math.max(0, total - paid);
                    }},
                    { key: 'date', label: 'Date', type: 'date' },
                    { key: 'paid', label: 'Status' },
                    { key: 'paymentMethod', label: 'Payment Method' }
                ],
                totals: [
                    { key: 'amount', label: 'Total' },
                    { key: 'amountPaid', label: 'Total Paid' },
                    { key: 'amountUnpaid', label: 'Total Balance' },
                    { label: 'Total GST', reducer: rows => rows.reduce((s, r) => s + (parseFloat(r.amount) || 0), 0) * getGstRate() }
                ]
            },
            exchange: {
                columns: [
                    { key: 'amount', label: 'Amount (AUD)', type: 'currency' },
                    { key: 'service', label: 'Service' },
                    { key: 'cashType', label: 'Cash Type' },
                    { key: 'status', label: 'Status' },
                    { key: 'paidOn', label: 'Paid On', type: 'date' }
                ],
                totals: [
                    { key: 'amount', label: 'Total Amount' },
                    { key: 'amount', label: 'Total RIA', filter: r => r.service === 'RIA' },
                    { key: 'amount', label: 'Total Western Union', filter: r => r.service === 'Western Union' },
                    { key: 'amount', label: 'Total Money Gram', filter: r => r.service === 'Money Gram' },
                    { key: 'amount', label: 'Total Hawala', filter: r => r.service === 'Hawala' },
                    { key: 'amount', label: 'Cash In', filter: r => r.cashType === 'in' },
                    { key: 'amount', label: 'Cash Out', filter: r => r.cashType === 'out' }
                ]
            },
            cash: {
                columns: [
                    { key: 'desc', label: 'Description' },
                    { key: 'type', label: 'Type' },
                    { key: 'amount', label: 'Amount', type: 'currency' },
                    { key: 'date', label: 'Date', type: 'date' }
                ],
                totals: [
                    { key: 'amount', label: 'Cash In', filter: r => (r.type === 'in') },
                    { key: 'amount', label: 'Cash Out', filter: r => (r.type === 'out') },
                    { key: 'amount', label: 'Net', reducer: rows => rows.reduce((s, r) => s + (r.type === 'in' ? +(r.amount||0) : -(r.amount||0)), 0) }
                ]
            },
            outstanding: {
                columns: [
                    { key: 'customer', label: 'Customer' },
                    { key: 'amount', label: 'Amount', type: 'currency' },
                    { label: 'Amount Paid', type: 'currency', value: r => {
                        const payments = LocalDB.getCollection('outstanding_payments').filter(p => String(p.outstandingId).trim() === String(r.id).trim());
                        return payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                    }},
                    { label: 'Balance', type: 'currency', value: r => {
                        const total = parseFloat(r.amount) || 0;
                        const payments = LocalDB.getCollection('outstanding_payments').filter(p => String(p.outstandingId).trim() === String(r.id).trim());
                        const paid = payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                        return Math.max(0, total - paid);
                    }},
                    { key: 'date', label: 'Date', type: 'date' }
                ],
                totals: [
                    { key: 'amount', label: 'Total Amount' },
                    { label: 'Total Paid', reducer: rows => {
                        const allPayments = LocalDB.getCollection('outstanding_payments');
                        return allPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                    }},
                    { label: 'Total Balance', reducer: rows => {
                        const totalAmt = rows.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                        const allPayments = LocalDB.getCollection('outstanding_payments');
                        const totalPaid = allPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                        return Math.max(0, totalAmt - totalPaid);
                    }}
                ]
            },
            outstanding_payments: {
                columns: [
                    { key: 'outstandingId', label: 'Outstanding ID' },
                    { key: 'customer', label: 'Customer' },
                    { key: 'amount', label: 'Amount Paid', type: 'currency' },
                    { key: 'paidOn', label: 'Paid On', type: 'date' },
                    { key: 'paymentMethod', label: 'Payment Method' }
                ],
                totals: [{ key: 'amount', label: 'Total Payments' }]
            },
            payments: {
                columns: [
                    { key: 'invoiceNum', label: 'Invoice #' },
                    { key: 'customer', label: 'Company' },
                    { key: 'amount', label: 'Amount Paid', type: 'currency' },
                    { key: 'paidOn', label: 'Paid On', type: 'date' },
                    { key: 'paymentMethod', label: 'Payment Method' }
                ],
                totals: [{ key: 'amount', label: 'Total Payments' }]
            }
        };

        function formatDate(date) {
            if (!date) return 'N/A';
            const d = new Date(date);
            return d.toLocaleDateString();
        }

        function formatCurrency(amount) {
            return '$' + parseFloat(amount || 0).toFixed(2);
        }

        function showLoading(collection, isLoading) {
            const tableId = `${collection}-table`;
            const container = document.getElementById(tableId);
            if (!container) return;
            if (isLoading) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Loading...</span></div>';
            }
        }

        // Tab Switching
        function switchTab(button, tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            const tabEl = document.getElementById(`tab-${tabName}`);
            if (tabEl) tabEl.classList.add('active');
            if (button) button.classList.add('active');
            // Save current tab to localStorage
            try { localStorage.setItem('currentTab', tabName); }
            catch(e) { console.warn('Tab save error:', e); }
        }

        function bindTabClicks() {
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabName = btn.getAttribute('data-tab');
                    if (!tabName) return;
                    switchTab(btn, tabName);
                });
            });
        }

        // Database Helper
        async function addToCollection(collection, data) {
            // Generate a single ID and use it for both LocalDB and Firestore
            const id = LocalDB.addDoc(collection, data);
            try {
                const cloudData = mapWrite(collection, data);
                await db.collection(resolveColl(collection)).doc(id).set(cloudData);
            } catch (e) {
                console.warn('Firebase write error (using LocalDB fallback):', e);
                notify(`Cloud write failed for ${collection}: ${e.message || e}`, 'error');
            }
            loadCollection(collection);
        }

        async function updateInCollection(collection, id, data) {
            LocalDB.updateDoc(collection, id, data);
            try {
                const cloudData = mapWrite(collection, data);
                await db.collection(resolveColl(collection)).doc(id).set(cloudData, { merge: true });
            } catch (e) {
                console.warn('Firebase update error (updated locally):', e);
                notify(`Cloud update failed for ${collection}: ${e.message || e}`, 'error');
            }
            loadCollection(collection);
        }

        async function deleteFromCollection(collection, id) {
            LocalDB.deleteDoc(collection, id);
            try {
                await db.collection(resolveColl(collection)).doc(id).delete();
            } catch (e) {
                // Firebase permissions may be restricted - data is deleted locally, sync disabled
                if (e.code === 'permission-denied') {
                    console.warn('Firebase permission denied for delete - using local storage only');
                } else {
                    console.warn('Firebase delete error (removed locally):', e);
                    notify(`Cloud sync disabled for ${collection}`, 'warn');
                }
            }
            loadCollection(collection);
        }

        function shareRecord(collection, id) {
            const data = LocalDB.getDoc(collection, id);
            if (!data) { notify('Record not found', 'error'); return; }
            
            // Create shareable text content
            let shareText = '';
            if (collection === 'invoices') {
                shareText = `Invoice #${data.num}\nCompany: ${data.customer}\nTotal Amount: ${formatCurrency(data.amount)}\nPaid: ${data.paid}\nAmount Paid: ${formatCurrency(data.amountPaid)}\nAmount Unpaid: ${formatCurrency(data.amountUnpaid)}\nDate: ${formatDate(data.date)}`;
                
                // Include payment history
                const payments = LocalDB.getCollection('payments').filter(p => p.invoiceNum === data.num);
                if (payments.length > 0) {
                    shareText += '\n\n--- Payment History ---';
                    payments.forEach(p => {
                        shareText += `\nDate: ${formatDate(p.paidOn)} | Amount: ${formatCurrency(p.amount)} | Method: ${p.paymentMethod}`;
                    });
                }
            } else if (collection === 'expenses') {
                shareText = `Expense\nCategory: ${data.category}\nAmount: ${formatCurrency(data.amount)}\nDescription: ${data.description}\nDate: ${formatDate(data.date)}`;
            } else if (collection === 'investments') {
                shareText = `Investment\nInvestor: ${data.investor}\nAmount: ${formatCurrency(data.amount)}\nPaid To: ${data.paidTo}\nDate: ${formatDate(data.date)}\nMethod: ${data.method}`;
            } else {
                shareText = JSON.stringify(data, null, 2);
            }
            
            // Check if Web Share API is available
            if (navigator.share) {
                navigator.share({
                    title: `${collection.charAt(0).toUpperCase() + collection.slice(1)} Record`,
                    text: shareText
                }).catch(err => console.log('Share cancelled or failed:', err));
            } else {
                // Fallback: Copy to clipboard
                navigator.clipboard.writeText(shareText).then(() => {
                    notify('Record copied to clipboard!', 'success');
                }).catch(err => {
                    notify('Could not copy to clipboard', 'error');
                });
            }
        }

        function toggleCompanyGroup(company) {
            let currentState = false;
            try {
                currentState = sessionStorage.getItem(`expand_${company}`) !== 'false';
            } catch (e) {
                currentState = true;
            }
            try {
                sessionStorage.setItem(`expand_${company}`, !currentState);
            } catch (e) {
                console.warn('Session storage blocked:', e.message);
            }
            const invoices = LocalDB.getCollection('invoices');
            renderTable('invoices', invoices);
        }

        function togglePaymentHistory(invoiceId) {
            const historyKey = `hist_${invoiceId}`;
            let isShown = false;
            try {
                isShown = sessionStorage.getItem(historyKey) === 'true';
            } catch (e) {
                isShown = false;
            }
            try {
                sessionStorage.setItem(historyKey, !isShown);
            } catch (e) {
                console.warn('Session storage blocked:', e.message);
            }
            // Re-render the invoices table to reflect history visibility
            const invoices = LocalDB.getCollection('invoices');
            renderTable('invoices', invoices);
        }

        function toggleOutstandingGroup(customer) {
            let currentState = false;
            try {
                currentState = sessionStorage.getItem(`expand_out_${customer}`) !== 'false';
            } catch (e) {
                currentState = true;
            }
            try {
                sessionStorage.setItem(`expand_out_${customer}`, !currentState);
            } catch (e) {
                console.warn('Session storage blocked:', e.message);
            }
            const outstanding = LocalDB.getCollection('outstanding');
            renderTable('outstanding', outstanding);
        }

        function toggleOutstandingHistory(outstandingId) {
            const historyKey = `out_hist_${outstandingId}`;
            let isShown = false;
            try {
                isShown = localStorage.getItem(historyKey) === 'true';
            } catch (e) {
                // Handle Tracking Prevention
                console.warn('Storage access blocked:', e.message);
                isShown = false;
            }
            try {
                localStorage.setItem(historyKey, !isShown);
            } catch (e) {
                console.warn('Storage access blocked:', e.message);
            }
            const outstanding = LocalDB.getCollection('outstanding');
            renderTable('outstanding', outstanding);
        }

        function expandAllInvoiceGroups() {
            const invoices = LocalDB.getCollection('invoices');
            const grouped = {};
            invoices.forEach(row => {
                const company = row.customer || 'Unknown';
                if (!grouped[company]) grouped[company] = [];
                grouped[company].push(row);
            });
            Object.keys(grouped).forEach(company => {
                try {
                    sessionStorage.setItem(`expand_${company}`, 'true');
                } catch (e) {
                    console.warn('Session storage blocked:', e.message);
                }
            });
            renderTable('invoices', invoices);
        }

        function collapseAllInvoiceGroups() {
            const invoices = LocalDB.getCollection('invoices');
            const grouped = {};
            invoices.forEach(row => {
                const company = row.customer || 'Unknown';
                if (!grouped[company]) grouped[company] = [];
                grouped[company].push(row);
            });
            Object.keys(grouped).forEach(company => {
                try {
                    sessionStorage.setItem(`expand_${company}`, 'false');
                } catch (e) {
                    console.warn('Session storage blocked:', e.message);
                }
            });
            renderTable('invoices', invoices);
        }

        function expandAllOutstandingGroups() {
            const outstanding = LocalDB.getCollection('outstanding');
            const grouped = {};
            outstanding.forEach(row => {
                const customer = row.customer || 'Unknown';
                if (!grouped[customer]) grouped[customer] = [];
                grouped[customer].push(row);
            });
            Object.keys(grouped).forEach(customer => {
                try {
                    sessionStorage.setItem(`expand_out_${customer}`, 'true');
                } catch (e) {
                    console.warn('Session storage blocked:', e.message);
                }
            });
            renderTable('outstanding', outstanding);
        }

        function collapseAllOutstandingGroups() {
            const outstanding = LocalDB.getCollection('outstanding');
            const grouped = {};
            outstanding.forEach(row => {
                const customer = row.customer || 'Unknown';
                if (!grouped[customer]) grouped[customer] = [];
                grouped[customer].push(row);
            });
            Object.keys(grouped).forEach(customer => {
                try {
                    sessionStorage.setItem(`expand_out_${customer}`, 'false');
                } catch (e) {
                    console.warn('Session storage blocked:', e.message);
                }
            });
            renderTable('outstanding', outstanding);
        }

        function openOutstandingEditModal(id) {
            const row = LocalDB.getDoc('outstanding', id);
            if (!row) return notify('Record not found', 'error');
            
            const modal = document.getElementById('edit-modal');
            modal.innerHTML = `
                <div class="modal-content" style="max-height:90vh;overflow-y:auto">
                    <div class="modal-header">
                        <h3>Record Outstanding Payment</h3>
                        <button class="modal-close" onclick="document.getElementById('edit-modal').classList.remove('active')">&times;</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Customer</label>
                        <div style="padding:8px;background:rgba(0,0,0,0.2);border-radius:4px">${row.customer}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Outstanding Amount</label>
                        <div style="padding:8px;background:rgba(0,0,0,0.2);border-radius:4px">${formatCurrency(row.amount)}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Amount</label>
                        <input type="number" id="out-pay-amount" class="input" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Paid On</label>
                        <input type="date" id="out-pay-date" class="input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Method</label>
                        <select id="out-pay-method" class="input">
                            <option>Cash</option>
                            <option>Bank Transfer</option>
                            <option>Check</option>
                            <option>Card</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary w-full" onclick="recordOutstandingPayment('${id}')">
                            <i class='fas fa-save mr-2'></i>Record Payment
                        </button>
                    </div>
                    <div style="margin-top:20px;border-top:1px solid rgba(59,130,246,0.2);padding-top:20px">
                        <h4 style="margin-bottom:12px">Payment History</h4>
                        <div id="out-payment-history-list" style="max-height:300px;overflow-y:auto"></div>
                    </div>
                </div>
            `;
            
            document.getElementById('out-pay-date').valueAsDate = new Date();
            displayOutstandingPaymentHistory(id);
            modal.classList.add('active');
        }

        function displayOutstandingPaymentHistory(outstandingId) {
            const payments = LocalDB.getCollection('outstanding_payments').filter(p => String(p.outstandingId).trim() === String(outstandingId).trim());
            const container = document.getElementById('out-payment-history-list');
            
            if (payments.length === 0) {
                container.innerHTML = '<p style="color:#9ca3af">No payments recorded yet</p>';
                return;
            }
            
            let html = '<table style="width:100%;border-collapse:collapse">';
            html += '<tr style="border-bottom:1px solid rgba(59,130,246,0.2)"><th style="padding:6px;text-align:left">Date</th><th style="padding:6px;text-align:left">Amount</th><th style="padding:6px;text-align:left">Method</th><th style="padding:6px">Action</th></tr>';
            payments.forEach(p => {
                html += `<tr style="border-bottom:1px solid rgba(59,130,246,0.1)"><td style="padding:6px">${formatDate(p.paidOn)}</td><td style="padding:6px">${p.amount}</td><td style="padding:6px">${p.paymentMethod}</td><td style="padding:6px"><button class="btn btn-danger toolbar-btn" onclick="deleteOutstandingPayment('${p.id}', '${outstandingId}')"><i class='fas fa-trash'></i></button></td></tr>`;
            });
            html += '</table>';
            container.innerHTML = html;
        }

        function recordOutstandingPayment(outstandingId) {
            const amount = document.getElementById('out-pay-amount').value;
            const paidOn = document.getElementById('out-pay-date').value;
            const method = document.getElementById('out-pay-method').value;
            
            if (!amount || parseFloat(amount) <= 0) return notify('Enter valid amount', 'error');
            if (!paidOn) return notify('Select paid on date', 'error');
            
            const outstanding = LocalDB.getDoc('outstanding', outstandingId);
            const paymentData = {
                outstandingId,
                customer: outstanding.customer,
                amount: parseFloat(amount),
                paidOn,
                paymentMethod: method
            };
            
            addToCollection('outstanding_payments', paymentData);
            displayOutstandingPaymentHistory(outstandingId);
            document.getElementById('out-pay-amount').value = '';
            notify('Payment recorded successfully!', 'success');
            
            // Auto-refresh outstanding table
            setTimeout(() => {
                const outstanding = LocalDB.getCollection('outstanding');
                renderTable('outstanding', outstanding);
            }, 200);
        }

        function deleteOutstandingPayment(paymentId, outstandingId) {
            if (!confirm('Delete this payment record?')) return;
            deleteFromCollection('outstanding_payments', paymentId);
            displayOutstandingPaymentHistory(outstandingId);
            notify('Payment deleted', 'success');
        }

        let paymentHistoryState = { invoiceId: null, invoiceNum: null };

        function openPaymentHistoryModal(invoiceId, invoiceNum) {
            paymentHistoryState = { invoiceId, invoiceNum };
            displayPaymentHistory();
            document.getElementById('payment-history-modal').classList.add('active');
            document.getElementById('payment-date').valueAsDate = new Date();
        }

        function closePaymentHistoryModal() {
            document.getElementById('payment-history-modal').classList.remove('active');
        }

        function displayPaymentHistory() {
            const payments = LocalDB.getCollection('payments').filter(p => p.invoiceNum === paymentHistoryState.invoiceNum);
            let html = '<table style="width:100%;"><thead><tr><th>Date</th><th>Amount</th><th>Method</th><th>Action</th></tr></thead><tbody>';
            
            if (payments.length === 0) {
                html += '<tr><td colspan="4" style="text-align:center;padding:20px;">No payments recorded yet</td></tr>';
            } else {
                payments.forEach(p => {
                    html += `<tr>
                        <td>${formatDate(p.paidOn)}</td>
                        <td>${formatCurrency(p.amount)}</td>
                        <td>${p.paymentMethod}</td>
                        <td><button class="btn btn-danger toolbar-btn" onclick="deletePaymentRecord('${p.id}')"><i class='fas fa-trash'></i></button></td>
                    </tr>`;
                });
            }
            html += '</tbody></table>';
            document.getElementById('payment-history-content').innerHTML = html;
        }

        function recordPayment() {
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const paidOn = document.getElementById('payment-date').value;
            const paymentMethod = document.getElementById('payment-method').value;
            
            if (!amount || !paidOn) {
                notify('Fill all payment fields', 'error');
                return;
            }
            
            const invoice = LocalDB.getDoc('invoices', paymentHistoryState.invoiceId);
            if (!invoice) {
                notify('Invoice not found', 'error');
                return;
            }
            
            // Create payment record
            const paymentRecord = {
                invoiceNum: paymentHistoryState.invoiceNum,
                invoiceId: paymentHistoryState.invoiceId,
                customer: invoice.customer,
                amount: amount,
                paidOn: paidOn,
                paymentMethod: paymentMethod
            };
            
            // Add to payments collection
            addToCollection('payments', paymentRecord);
            
            // Update invoice totals
            const currentPaid = parseFloat(invoice.amountPaid) || 0;
            const currentUnpaid = parseFloat(invoice.amountUnpaid) || 0;
            const newAmountPaid = currentPaid + amount;
            const newAmountUnpaid = Math.max(0, currentUnpaid - amount);
            
            updateInCollection('invoices', paymentHistoryState.invoiceId, {
                amountPaid: newAmountPaid,
                amountUnpaid: newAmountUnpaid,
                paid: (newAmountUnpaid <= 0) ? 'Full' : 'Partially'
            });
            
            // Reset form
            document.getElementById('payment-amount').value = '';
            document.getElementById('payment-method').value = 'cash';
            document.getElementById('payment-date').valueAsDate = new Date();
            
            displayPaymentHistory();
            notify('Payment recorded successfully!', 'success');
            loadCollection('invoices');
        }

        function deletePaymentRecord(paymentId) {
            if (confirm('Are you sure you want to delete this payment record?')) {
                const payment = LocalDB.getDoc('payments', paymentId);
                if (payment) {
                    deleteFromCollection('payments', paymentId);
                    
                    // Revert invoice amounts
                    const invoice = LocalDB.getDoc('invoices', payment.invoiceId);
                    if (invoice) {
                        const newAmountPaid = Math.max(0, parseFloat(invoice.amountPaid) - parseFloat(payment.amount));
                        const newAmountUnpaid = parseFloat(invoice.amountUnpaid) + parseFloat(payment.amount);
                        
                        updateInCollection('invoices', payment.invoiceId, {
                            amountPaid: newAmountPaid,
                            amountUnpaid: newAmountUnpaid,
                            paid: (newAmountUnpaid >= parseFloat(invoice.amount)) ? 'No' : (newAmountPaid <= 0 ? 'No' : 'Partially')
                        });
                    }
                }
                displayPaymentHistory();
                notify('Payment record deleted', 'success');
                loadCollection('invoices');
            }
        }

        async function loadCollection(collection) {
            // Firestore-first: try to read from cloud, then fall back to local
            showLoading(collection, true);
            try {
                // Try cache first, else iterate candidates until data found
                const candidates = [resolveColl(collection), ...(CloudNameCandidates[collection] || [])];
                const tried = new Set();
                let foundData = null;
                let foundName = null;
                for (const cname of candidates) {
                    if (!cname || tried.has(cname)) continue;
                    tried.add(cname);
                    try {
                        const snap = await db.collection(cname).get();
                        const data = [];
                        snap.forEach(doc => {
                            const raw = { id: doc.id, ...doc.data() };
                            const mapped = mapRead(collection, raw);
                            data.push(mapped);
                        });
                        if (data.length > 0) {
                            foundData = data;
                            foundName = cname;
                            break;
                        }
                    } catch (e) {
                        // continue trying next candidate
                    }
                }
                if (foundData) {
                    const cache = getCloudNameCache();
                    cache[collection] = foundName;
                    setCloudNameCache(cache);
                    LocalDB.saveCollection(collection, foundData);
                    renderTable(collection, foundData);
                    return;
                }
                // If cloud has no records, prefer existing local data
                const localData = LocalDB.getCollection(collection);
                renderTable(collection, localData);
                return;
            } catch (e) {
                console.warn('Firebase read error, falling back to local:', e);
                notify(`Cloud read failed for ${collection}: ${e.message || e}`, 'error');
            }

            try {
                const localData = LocalDB.getCollection(collection);
                renderTable(collection, localData);
            } catch (e) {
                console.warn('Local render error:', e);
            }
        }

        function updateTotals(collection, data) {
            const el = document.getElementById(`${collection}-totals`);
            if (!el) return;
            const schema = Schema[collection];
            if (!schema || !schema.totals) { el.textContent = ''; return; }
            const rows = Array.isArray(data) ? data : [];
            const parts = [];
            for (const t of schema.totals) {
                if (typeof t.reducer === 'function') {
                    const val = t.reducer(rows);
                    parts.push(`${t.label}: ${formatCurrency(val)}`);
                } else if (t.key) {
                    const filtered = t.filter ? rows.filter(t.filter) : rows;
                    const sum = filtered.reduce((s, r) => s + (parseFloat(r[t.key]) || 0), 0);
                    parts.push(`${t.label}: ${formatCurrency(sum)}`);
                }
            }
            el.textContent = parts.join(' â€¢ ');
        }

        // Add Functions
        function addExpense() {
            const desc = document.getElementById('expense-desc').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const date = document.getElementById('expense-date').value;
            if (!desc || !amount) { notify('Fill all fields', 'error'); return; }
            addToCollection('expenses', { desc, amount, date: date || new Date().toISOString().split('T')[0] });
            document.getElementById('expense-desc').value = '';
            document.getElementById('expense-amount').value = '';
            notify('Expense added');
        }

        function addInvestment() {
            const name = document.getElementById('inv-name').value;
            const investor = document.getElementById('inv-investor') ? document.getElementById('inv-investor').value : '';
            const amount = parseFloat(document.getElementById('inv-amount').value);
            const paidTo = document.getElementById('inv-paid-to') ? document.getElementById('inv-paid-to').value : 'Shop';
            const date = document.getElementById('inv-date').value;
            const method = document.getElementById('inv-method') ? document.getElementById('inv-method').value : 'Cash';
            if (!name || !amount) { notify('Fill all fields', 'error'); return; }
            addToCollection('investments', { name, investor, amount, paidTo, date: date || new Date().toISOString().split('T')[0], method });
            document.getElementById('inv-name').value = '';
            document.getElementById('inv-amount').value = '';
            notify('Investment added');
        }

        function addSupplier() {
            const nameRaw = document.getElementById('supp-name').value;
            const name = normalizeName(nameRaw);
            const phone = document.getElementById('supp-phone') ? document.getElementById('supp-phone').value : '';
            const details = document.getElementById('supp-details') ? document.getElementById('supp-details').value : '';
            if (!name) { notify('Fill supplier name', 'error'); return; }
            addToCollection('suppliers', { name, phone, details });
            document.getElementById('supp-name').value = '';
            document.getElementById('supp-phone') && (document.getElementById('supp-phone').value = '');
            document.getElementById('supp-details') && (document.getElementById('supp-details').value = '');
            notify('Supplier added');
            refreshCompaniesDatalist();
        }

        function addInvoice() {
            const num = document.getElementById('inv-num').value;
            const customerRaw = document.getElementById('inv-customer').value;
            const customer = normalizeName(customerRaw);
            const amount = parseFloat(document.getElementById('inv-price').value);
            const gstType = document.getElementById('inv-gst-type') ? document.getElementById('inv-gst-type').value : 'include';
            const gstRatePct = parseFloat(document.getElementById('gst-rate')?.value || '10');
            const paid = document.getElementById('inv-paid') ? document.getElementById('inv-paid').value : 'No';
            const customAmountPaid = document.getElementById('inv-amount-paid') ? parseFloat(document.getElementById('inv-amount-paid').value) : null;
            const paidOn = document.getElementById('inv-paid-on') ? document.getElementById('inv-paid-on').value : '';
            const paymentMethod = document.getElementById('inv-payment-method') ? document.getElementById('inv-payment-method').value : 'cash';
            const bsb = document.getElementById('inv-bsb') ? document.getElementById('inv-bsb').value : '';
            const account = document.getElementById('inv-account') ? document.getElementById('inv-account').value : '';
            if (!num || !customer || !amount) { notify('Fill all fields', 'error'); return; }
            // Derive cloud-aligned fields
            let netAmount, gstAmount, totalAmount;
            const rate = (isNaN(gstRatePct) ? 10 : gstRatePct) / 100;
            if (gstType === 'include') {
                netAmount = amount / (1 + rate);
                gstAmount = amount - netAmount;
                totalAmount = amount;
            } else {
                netAmount = amount;
                gstAmount = amount * rate;
                totalAmount = netAmount + gstAmount;
            }
            const status = (paid !== 'No') ? 'paid' : 'unpaid';
            let amountPaid, amountUnpaid;
            if (customAmountPaid !== null && !isNaN(customAmountPaid)) {
                amountPaid = customAmountPaid;
                amountUnpaid = totalAmount - customAmountPaid;
            } else if (paid === 'Full') {
                amountPaid = totalAmount;
                amountUnpaid = 0;
            } else if (paid === 'Half') {
                amountPaid = totalAmount / 2;
                amountUnpaid = totalAmount / 2;
            } else if (paid === 'Partially') {
                amountPaid = totalAmount * 0.3; // 30% as default partial
                amountUnpaid = totalAmount * 0.7;
            } else {
                amountPaid = 0;
                amountUnpaid = totalAmount;
            }
            addToCollection('invoices', { num, customer, amount: totalAmount, date: new Date().toISOString().split('T')[0], paid, paidOn, paymentMethod, bsb, account, status, gstType, gstRate: isNaN(gstRatePct) ? 10 : gstRatePct, netAmount, gstAmount, amountPaid, amountUnpaid });
            document.getElementById('inv-num').value = '';
            document.getElementById('inv-customer').value = '';
            document.getElementById('inv-price').value = '';
            document.getElementById('inv-amount-paid').value = '';
            document.getElementById('inv-bsb').value = '';
            document.getElementById('inv-account').value = '';
            notify('Invoice added');
            refreshCompaniesDatalist();
        }

        function addExchange() {
            const amount = parseFloat(document.getElementById('exc-amount').value);
            const service = document.getElementById('exc-service') ? document.getElementById('exc-service').value : '';
            const cashType = document.getElementById('exc-type') ? document.getElementById('exc-type').value : 'in';
            const status = document.getElementById('exc-status') ? document.getElementById('exc-status').value : 'Pending';
            const paidOn = document.getElementById('exc-paid-on') ? document.getElementById('exc-paid-on').value : '';
            if (!amount) { notify('Enter amount', 'error'); return; }
            addToCollection('exchange', { amount, service, cashType, status, paidOn });
            document.getElementById('exc-amount').value = '';
            notify('Exchange record added');
        }

        function addCash() {
            const desc = document.getElementById('cash-desc').value;
            const type = document.getElementById('cash-type').value;
            const amount = parseFloat(document.getElementById('cash-amount').value);
            if (!desc || !amount) { notify('Fill all fields', 'error'); return; }
            addToCollection('cash', { desc, type, amount, date: new Date().toISOString().split('T')[0] });
            document.getElementById('cash-desc').value = '';
            document.getElementById('cash-amount').value = '';
            notify('Cash record added');
        }

        function addOutstanding() {
            const customer = document.getElementById('out-customer').value;
            const amount = parseFloat(document.getElementById('out-amount').value);
            const date = document.getElementById('out-date').value;
            if (!customer || !amount) { notify('Fill all fields', 'error'); return; }
            addToCollection('outstanding', { customer, amount, date: date || new Date().toISOString().split('T')[0] });
            document.getElementById('out-customer').value = '';
            document.getElementById('out-amount').value = '';
            notify('Outstanding added');
        }

        // Setup invoice form auto-lock and auto-fill
        function setupInvoiceFormListeners() {
            const customerInput = document.getElementById('inv-customer');
            if (!customerInput) return;
            
            // Show datalist suggestions on focus or when typing
            const showSuggestions = () => {
                // The native datalist will handle showing suggestions
                // No JavaScript manipulation needed
            };
            
            customerInput.addEventListener('focus', showSuggestions);
            customerInput.addEventListener('input', showSuggestions);
        }
        
        function renderTable(collection, data) {
            const tableId = `${collection}-table`;
            const container = document.getElementById(tableId);
            if (!container) return;

            try {
                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">No records yet</p>';
                    updateTotals(collection, []);
                    return;
                }

                const schema = Schema[collection];
                const cols = (schema && schema.columns) ? schema.columns : Object.keys(data[0] || {}).filter(k => k !== 'id' && k !== 'createdAt').map(k => ({ key: k, label: k }));
                
                // Special grouping for invoices by company
                if (collection === 'invoices') {
                    let html = '';
                    
                    // Group invoices by company
                    const grouped = {};
                    data.forEach(row => {
                        const company = row.customer || 'Unknown';
                        if (!grouped[company]) grouped[company] = [];
                        grouped[company].push(row);
                    });
                    
                    // Sort companies alphabetically
                    const sortedCompanies = Object.keys(grouped).sort((a, b) => a.localeCompare(b));
                    
                    // Build grouped table
                    sortedCompanies.forEach((company, idx) => {
                        const rows = grouped[company];
                        const totalAmount = rows.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                        const totalBalance = rows.reduce((sum, r) => {
                            const payments = LocalDB.getCollection('payments').filter(p => String(p.invoiceNum).trim() === String(r.num).trim());
                            const paid = payments.reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
                            return sum + Math.max(0, parseFloat(r.amount) - paid || 0);
                        }, 0);
                        
                        let isOpen = true;
                        try {
                            isOpen = sessionStorage.getItem(`expand_${company}`) !== 'false';
                        } catch (e) {
                            isOpen = true; // Default expanded
                        }
                        html += `<div style="margin-bottom:15px;border:1px solid #3b82f6;border-radius:6px;overflow:hidden">`;
                        html += `<div style="background:#1e3a8a;padding:12px;cursor:pointer;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:8px" onclick="toggleCompanyGroup('${company}')">
                            <div style="display:flex;align-items:center;gap:10px;min-width:200px">
                                <span style="color:#3b82f6;font-weight:bold">${isOpen ? 'â–¼' : 'â–¶'}</span>
                                <span style="color:white;font-weight:600;word-break:break-word">${company}</span>
                                <span style="color:#cbd5e1;font-size:12px;white-space:nowrap">(${rows.length})</span>
                            </div>
                            <div style="color:#3b82f6;font-size:11px;text-align:right;flex:1;min-width:180px">
                                <div style="margin-top:4px">Total Amount: ${formatCurrency(totalAmount)}</div>
                                <div>Bal: ${formatCurrency(totalBalance)}</div>
                            </div>
                        </div>`;
                        
                        if (isOpen) {
                            html += '<table style="width:100%;border-collapse:collapse">';
                            html += '<thead><tr style="background:#0f172a">';
                            cols.forEach(c => { html += `<th style="padding:8px;border-bottom:1px solid #3b82f6;word-break:break-word">${c.label}</th>`; });
                            html += '<th style="padding:8px;border-bottom:1px solid #3b82f6">Actions</th></tr></thead><tbody>';
                            
                            rows.forEach(row => {
                                const payments = LocalDB.getCollection('payments').filter(p => String(p.invoiceNum).trim() === String(row.num).trim());
                                const invoiceAmount = parseFloat(row.amount) || 0;
                                const historyKey = `hist_${row.id}`;
                                let showHistory = false;
                                try {
                                    showHistory = sessionStorage.getItem(historyKey) === 'true';
                                } catch (e) {
                                    showHistory = false;
                                }
                                
                                html += '<tr style="border-bottom:1px solid #1e293b">';
                                cols.forEach(c => {
                                    let val = (typeof c.value === 'function') ? c.value(row) : row[c.key];
                                    if (c.type === 'currency') val = formatCurrency(val);
                                    else if (c.type === 'date') val = formatDate(val);
                                    html += `<td style="padding:8px">${(val ?? 'N/A')}</td>`;
                                });
                                const id = row.id || '';
                                html += `<td style="padding:8px"><div class="action-buttons">
                                    <button class="btn btn-primary toolbar-btn no-print" onclick="togglePaymentHistory('${id}')" title="History"><i class='fas fa-history'></i></button>
                                    <button class="btn btn-primary toolbar-btn no-print" onclick="openEditModal('${collection}', '${id}')" title="Edit"><i class='fas fa-pen'></i></button>
                                    <button class="btn btn-primary toolbar-btn no-print" onclick="shareRecord('${collection}', '${id}')" title="Share"><i class='fas fa-share-alt'></i></button>
                                    <button class="btn btn-danger toolbar-btn no-print" onclick="deleteFromCollection('${collection}', '${id}')" title="Delete"><i class='fas fa-trash'></i></button>
                                    <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForRow('${collection}', '${id}')" title="Preview"><i class='fas fa-eye'></i></button>
                                    <button class="btn btn-primary toolbar-btn no-print" onclick="printRow('${collection}', '${id}')" title="Print"><i class='fas fa-print'></i></button>
                                </div></td>`;
                                html += '</tr>';
                                
                                // Payment History Row
                                if (showHistory && payments.length > 0) {
                                    const totalPaid = payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                                    const remaining = Math.max(0, invoiceAmount - totalPaid);
                                    html += `<tr style="background:#0f172a;border-bottom:1px solid #1e293b">
                                        <td colspan="${cols.length + 1}" style="padding:12px">
                                            <div style="color:#cbd5e1;font-size:13px">
                                                <div style="margin-bottom:8px;font-weight:600;color:#3b82f6">Payment History - Invoice #${row.num} (${row.customer})</div>
                                                <table style="width:100%;margin-bottom:8px">
                                                    <thead>
                                                        <tr style="border-bottom:1px solid #3b82f6">
                                                            <th style="padding:6px;text-align:left">Date</th>
                                                            <th style="padding:6px;text-align:left">Amount</th>
                                                            <th style="padding:6px;text-align:left">Method</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${payments.map(p => `
                                                            <tr style="border-bottom:1px solid #1e293b">
                                                                <td style="padding:6px">${formatDate(p.paidOn) || 'N/A'}</td>
                                                                <td style="padding:6px">${p.amount}</td>
                                                                <td style="padding:6px">${p.paymentMethod || 'N/A'}</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                                <div style="display:flex;gap:20px;padding-top:8px;border-top:1px solid #3b82f6">
                                                    <div>Invoice Amount: <span style="color:#3b82f6;font-weight:600">${formatCurrency(invoiceAmount)}</span></div>
                                                    <div>Total Paid: <span style="color:#10b981;font-weight:600">${formatCurrency(totalPaid)}</span></div>
                                                    <div>Remaining: <span style="color:#${remaining > 0 ? 'ef4444' : '10b981'};font-weight:600">${formatCurrency(remaining)}</span></div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>`;
                                }
                            });
                            html += '</tbody></table>';
                        }
                        html += '</div>';
                    });
                    
                    container.innerHTML = html;
                    updateTotals(collection, data);
                    return;
                }
                
                // Special grouping for outstanding by customer
                if (collection === 'outstanding') {
                    let html = '';
                    
                    // Group outstanding by customer
                    const grouped = {};
                    data.forEach(row => {
                        const customer = row.customer || 'Unknown';
                        if (!grouped[customer]) grouped[customer] = [];
                        grouped[customer].push(row);
                    });
                    
                    // Sort customers alphabetically
                    const sortedCustomers = Object.keys(grouped).sort((a, b) => a.localeCompare(b));
                    
                    // Build grouped table
                    sortedCustomers.forEach((customer, idx) => {
                        const rows = grouped[customer];
                        const totalAmount = rows.reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
                        const totalBalance = rows.reduce((sum, r) => {
                            const payments = LocalDB.getCollection('outstanding_payments').filter(p => String(p.outstandingId).trim() === String(r.id).trim());
                            const paid = payments.reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
                            return sum + Math.max(0, parseFloat(r.amount) - paid || 0);
                        }, 0);
                        
                        let isOpen = true;
                        try {
                            isOpen = sessionStorage.getItem(`expand_out_${customer}`) !== 'false';
                        } catch (e) {
                            isOpen = true; // Default expanded
                        }
                        html += `<div style="margin-bottom:15px;border:1px solid #3b82f6;border-radius:6px;overflow:hidden">`;
                        html += `<div style="background:#1e3a8a;padding:12px;cursor:pointer;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:8px" onclick="toggleOutstandingGroup('${customer}')">
                            <div style="display:flex;align-items:center;gap:10px;min-width:200px">
                                <span style="color:#3b82f6;font-weight:bold">${isOpen ? 'â–¼' : 'â–¶'}</span>
                                <span style="color:white;font-weight:600;word-break:break-word">${customer}</span>
                                <span style="color:#cbd5e1;font-size:12px;white-space:nowrap">(${rows.length})</span>
                            </div>
                            <div style="color:#3b82f6;font-size:11px;text-align:right;flex:1;min-width:180px">
                                <div style="margin-top:4px">Total Amount: ${formatCurrency(totalAmount)}</div>
                                <div>Bal: ${formatCurrency(totalBalance)}</div>
                            </div>
                        </div>`;
                        
                        if (isOpen) {
                            html += '<div style="overflow-x:auto;-webkit-overflow-scrolling:touch"><table style="width:100%;border-collapse:collapse;min-width:600px">';
                            html += '<thead><tr style="background:#0f172a">';
                            cols.forEach(c => { html += `<th style="padding:8px;border-bottom:1px solid #3b82f6;word-break:break-word">${c.label}</th>`; });
                            html += '<th style="padding:8px;border-bottom:1px solid #3b82f6">Actions</th></tr></thead><tbody>';
                            
                            rows.forEach(row => {
                                const payments = LocalDB.getCollection('outstanding_payments').filter(p => String(p.outstandingId).trim() === String(row.id).trim());
                                const outstandingAmount = parseFloat(row.amount) || 0;
                                const historyKey = `out_hist_${row.id}`;
                                let showHistory = false;
                                try {
                                    showHistory = localStorage.getItem(historyKey) === 'true';
                                } catch (e) {
                                    showHistory = false;
                                }
                                
                                html += '<tr style="border-bottom:1px solid #1e293b">';
                                cols.forEach(c => {
                                    let val = (typeof c.value === 'function') ? c.value(row) : row[c.key];
                                    if (c.type === 'currency') val = formatCurrency(val);
                                    else if (c.type === 'date') val = formatDate(val);
                                    html += `<td style="padding:8px">${(val ?? 'N/A')}</td>`;
                                });
                                const id = row.id || '';
                                html += `<td style="padding:8px"><div class="action-buttons">
                                    <button class="btn btn-primary toolbar-btn no-print" onclick="toggleOutstandingHistory('${id}')" title="History"><i class='fas fa-history'></i></button>
                                    <button class="btn btn-primary toolbar-btn no-print" onclick="openOutstandingEditModal('${id}')" title="Edit"><i class='fas fa-pen'></i></button>
                                    <button class="btn btn-primary toolbar-btn no-print" onclick="shareRecord('${collection}', '${id}')" title="Share"><i class='fas fa-share-alt'></i></button>
                                    <button class="btn btn-danger toolbar-btn no-print" onclick="deleteFromCollection('${collection}', '${id}')" title="Delete"><i class='fas fa-trash'></i></button>
                                    <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForRow('${collection}', '${id}')" title="Preview"><i class='fas fa-eye'></i></button>
                                    <button class="btn btn-primary toolbar-btn no-print" onclick="printRow('${collection}', '${id}')" title="Print"><i class='fas fa-print'></i></button>
                                </div></td>`;
                                html += '</tr>';
                                
                                // Payment History Row
                                if (showHistory) {
                                    const totalPaid = payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                                    const remaining = Math.max(0, outstandingAmount - totalPaid);
                                    html += `<tr style="background:#0f172a;border-bottom:1px solid #1e293b">
                                        <td colspan="${cols.length + 1}" style="padding:12px">
                                            <div style="color:#cbd5e1;font-size:13px;max-height:400px;overflow-y:auto">
                                                <div style="margin-bottom:8px;font-weight:600;color:#3b82f6">Payment History - ${row.customer}</div>
                                                <table style="width:100%;margin-bottom:8px">
                                                    <thead>
                                                        <tr style="border-bottom:1px solid #3b82f6">
                                                            <th style="padding:6px;text-align:left">Paid On</th>
                                                            <th style="padding:6px;text-align:left">Amount</th>
                                                            <th style="padding:6px;text-align:left">Method</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${payments.map(p => `
                                                            <tr style="border-bottom:1px solid #1e293b">
                                                                <td style="padding:6px">${formatDate(p.paidOn) || 'N/A'}</td>
                                                                <td style="padding:6px">${p.amount}</td>
                                                                <td style="padding:6px">${p.paymentMethod || 'N/A'}</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                                <div style="display:flex;gap:20px;padding-top:8px;border-top:1px solid #3b82f6;flex-wrap:wrap">
                                                    <div>Outstanding Amount: <span style="color:#3b82f6;font-weight:600">${formatCurrency(outstandingAmount)}</span></div>
                                                    <div>Total Paid: <span style="color:#10b981;font-weight:600">${formatCurrency(totalPaid)}</span></div>
                                                    <div>Remaining: <span style="color:#${remaining > 0 ? 'ef4444' : '10b981'};font-weight:600">${formatCurrency(remaining)}</span></div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>`;
                                }
                            });
                            html += '</tbody></table></div>';
                        }
                        html += '</div>';
                    });
                    
                    container.innerHTML = html;
                    updateTotals(collection, data);
                    return;
                }
                
                // Default table rendering for other collections
                let html = '<table>';
                html += '<thead><tr>';
                cols.forEach(c => { html += `<th>${c.label}</th>`; });
                html += '<th>Actions</th></tr></thead><tbody>';

                data.forEach(row => {
                    html += '<tr>';
                    cols.forEach(c => {
                        let val = (typeof c.value === 'function') ? c.value(row) : row[c.key];
                        if (c.type === 'currency') val = formatCurrency(val);
                        else if (c.type === 'date') val = formatDate(val);
                        html += `<td>${(val ?? 'N/A')}</td>`;
                    });
                    const id = row.id || '';
                    html += `<td class="flex gap-2">
                        <button class="btn btn-primary toolbar-btn no-print" onclick="openEditModal('${collection}', '${id}')"><i class='fas fa-pen'></i></button>
                        <button class="btn btn-primary toolbar-btn no-print" onclick="shareRecord('${collection}', '${id}')"><i class='fas fa-share-alt'></i></button>
                        <button class="btn btn-danger toolbar-btn no-print" onclick="deleteFromCollection('${collection}', '${id}')"><i class='fas fa-trash'></i></button>
                        <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForRow('${collection}', '${id}')"><i class='fas fa-eye'></i></button>
                        <button class="btn btn-primary toolbar-btn no-print" onclick="printRow('${collection}', '${id}')"><i class='fas fa-print'></i></button>
                    </td>`;
                    html += '</tr>';
                });
                html += '</tbody></table>';
                container.innerHTML = html;
                updateTotals(collection, data);
            } catch (e) {
                console.error('renderTable error:', e);
                container.innerHTML = '<p class="text-red-400">Error rendering table</p>';
            }
        }

        function renderTableToContainer(collection, data, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            let html = '';
            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = '<p class="text-gray-400">No records yet</p>';
                return;
            }
            const schema = Schema[collection];
            let cols = (schema && schema.columns) ? schema.columns : Object.keys(data[0] || {}).filter(k => k !== 'id' && k !== 'createdAt').map(k => ({ key: k, label: k }));
            
            // Filter columns based on investor data for investments
            if (collection === 'investments' && containerId === 'investments-hayat-table') {
                cols = cols.filter(c => c.label !== 'Abbas');
            } else if (collection === 'investments' && containerId === 'investments-abbas-table') {
                cols = cols.filter(c => c.label !== 'Haji Hayat');
            }
            
            html += '<table><thead><tr>' + cols.map(c => `<th>${c.label}</th>`).join('') + '<th>Actions</th></tr></thead><tbody>';
            data.forEach(row => {
                html += '<tr>';
                cols.forEach(c => {
                    let val = (typeof c.value === 'function') ? c.value(row) : row[c.key];
                    if (c.type === 'currency') val = formatCurrency(val);
                    else if (c.type === 'date') val = formatDate(val);
                    html += `<td>${(val ?? 'N/A')}</td>`;
                });
                const id = row.id || '';
                html += `<td class="flex gap-2">
                    <button class="btn btn-primary toolbar-btn no-print" onclick="openEditModal('${collection}', '${id}')"><i class='fas fa-pen'></i></button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="shareRecord('${collection}', '${id}')"><i class='fas fa-share-alt'></i></button>
                    <button class="btn btn-danger toolbar-btn no-print" onclick="deleteFromCollection('${collection}', '${id}')"><i class='fas fa-trash'></i></button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForRow('${collection}', '${id}')"><i class='fas fa-eye'></i></button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="printRow('${collection}', '${id}')"><i class='fas fa-print'></i></button>
                </td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function refreshInvestmentsSplit() {
            const rows = LocalDB.getCollection('investments');
            const hayat = rows.filter(r => r.investor === 'Haji Hayat');
            const abbas = rows.filter(r => r.investor === 'Abbas');
            renderTableToContainer('investments', hayat, 'investments-hayat-table');
            renderTableToContainer('investments', abbas, 'investments-abbas-table');
            updateInvestorTotal('hayat', hayat);
            updateInvestorTotal('abbas', abbas);
        }

        function switchInvTab(tab) {
            // Hide all
            document.getElementById('inv-all').style.display = 'none';
            document.getElementById('inv-hayat').style.display = 'none';
            document.getElementById('inv-abbas').style.display = 'none';
            // Reset buttons
            document.getElementById('tab-btn-all').classList.remove('active');
            document.getElementById('tab-btn-hayat').classList.remove('active');
            document.getElementById('tab-btn-abbas').classList.remove('active');
            // Save investment subtab selection
            try { localStorage.setItem('currentInvTab', tab); }
            catch(e) { console.warn('Investment tab save error:', e); }
            // Show selected
            if (tab === 'all') {
                document.getElementById('inv-all').style.display = 'block';
                document.getElementById('tab-btn-all').classList.add('active');
                loadCollection('investments');
            } else if (tab === 'hayat') {
                document.getElementById('inv-hayat').style.display = 'block';
                document.getElementById('tab-btn-hayat').classList.add('active');
                loadInvestorFromFirebase('Haji Hayat');
            } else if (tab === 'abbas') {
                document.getElementById('inv-abbas').style.display = 'block';
                document.getElementById('tab-btn-abbas').classList.add('active');
                loadInvestorFromFirebase('Abbas');
            }
        }

        async function loadInvestorFromFirebase(investor) {
            showLoading('investments', true);
            try {
                // Fetch from Firebase
                const snapshot = await db.collection('investments').where('investor', '==', investor).get();
                const firebaseData = [];
                snapshot.forEach(doc => {
                    const raw = { id: doc.id, ...doc.data() };
                    const mapped = mapRead('investments', raw);
                    firebaseData.push(mapped);
                });
                
                // Merge with local data
                const localRows = LocalDB.getCollection('investments').filter(r => r.investor === investor);
                const combined = [...firebaseData];
                localRows.forEach(local => {
                    if (!combined.find(f => f.id === local.id)) {
                        combined.push(local);
                    }
                });
                
                // Ensure all required fields exist
                const requiredFields = ['name', 'investor', 'amount', 'paidTo', 'date', 'method'];
                const processed = combined.map(r => {
                    requiredFields.forEach(field => {
                        if (!(field in r)) {
                            r[field] = field === 'amount' ? 0 : field === 'paidTo' ? 'Shop' : field === 'method' ? 'Cash' : '';
                        }
                    });
                    return r;
                });
                
                if (investor === 'Haji Hayat') {
                    renderTableToContainer('investments', processed, 'investments-hayat-table');
                    updateInvestorTotal('hayat', processed);
                } else {
                    renderTableToContainer('investments', processed, 'investments-abbas-table');
                    updateInvestorTotal('abbas', processed);
                }
                notify(`Loaded ${processed.length} ${investor} records from Firebase`, 'success');
            } catch (e) {
                console.warn('Firebase load error:', e);
                // Fallback to local data
                const localRows = LocalDB.getCollection('investments').filter(r => r.investor === investor);
                if (investor === 'Haji Hayat') {
                    renderTableToContainer('investments', localRows, 'investments-hayat-table');
                    updateInvestorTotal('hayat', localRows);
                } else {
                    renderTableToContainer('investments', localRows, 'investments-abbas-table');
                    updateInvestorTotal('abbas', localRows);
                }
                notify('Loaded from local storage', 'success');
            }
            showLoading('investments', false);
        }

        function updateInvestorTotal(investor, data) {
            const total = data.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
            const name = investor === 'hayat' ? 'Haji Hayat' : 'Abbas';
            const el = document.getElementById(`inv-${investor}-totals`);
            if (el) el.textContent = `${name} Total: ${formatCurrency(total)}`;
        }

        function printInvestorTab(investor) {
            const rows = LocalDB.getCollection('investments');
            const name = investor === 'hayat' ? 'Haji Hayat' : 'Abbas';
            const filtered = rows.filter(r => r.investor === name);
            const schema = Schema.investments;
            const cols = schema.columns;
            let html = buildPrintHeader(`${name} - Investments`);
            html += '<table style="width:100%;border-collapse:collapse"><thead><tr>';
            cols.forEach(c => html += `<th style="border-bottom:1px solid #ccc;padding:8px;text-align:left">${c.label}</th>`);
            html += '</tr></thead><tbody>';
            filtered.forEach(r => {
                html += '<tr>';
                cols.forEach(c => {
                    let val = (typeof c.value === 'function') ? c.value(r) : r[c.key];
                    if (c.type === 'currency') val = formatCurrency(val);
                    else if (c.type === 'date') val = formatDate(val);
                    html += `<td style="padding:8px;border-bottom:1px solid #eee">${val ?? ''}</td>`;
                });
                html += '</tr>';
            });
            const total = filtered.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
            html += `<tr><td colspan="${cols.length - 1}" style="text-align:right;font-weight:bold;padding:8px">Total:</td><td style="font-weight:bold;padding:8px">${formatCurrency(total)}</td></tr>`;
            html += '</tbody></table>';
            const win = window.open('', '_blank');
            if (!win) return notify('Popup blocked', 'error');
            win.document.write(`<html><head><title>${name}</title><style>body{padding:20px;font-family:Arial}</style></head><body><div style="margin-bottom:10px"><button onclick="window.print()">Print</button> <button onclick="window.close()">Close</button></div>${html}</body></html>`);
            win.document.close();
        }

        function exportInvestmentsPDF(type) {
            const rows = LocalDB.getCollection('investments');
            let filtered, title;
            if (type === 'hayat') {
                filtered = rows.filter(r => r.investor === 'Haji Hayat');
                title = 'Haji Hayat Investments';
            } else if (type === 'abbas') {
                filtered = rows.filter(r => r.investor === 'Abbas');
                title = 'Abbas Investments';
            } else {
                filtered = rows;
                title = 'All Investments';
            }
            const schema = Schema.investments;
            const cols = schema.columns;
            let html = buildPrintHeader(title);
            html += '<table style="width:100%;border-collapse:collapse"><thead><tr>';
            cols.forEach(c => html += `<th style="border-bottom:1px solid #ccc;padding:8px;text-align:left">${c.label}</th>`);
            html += '</tr></thead><tbody>';
            filtered.forEach(r => {
                html += '<tr>';
                cols.forEach(c => {
                    let val = (typeof c.value === 'function') ? c.value(r) : r[c.key];
                    if (c.type === 'currency') val = formatCurrency(val);
                    else if (c.type === 'date') val = formatDate(val);
                    html += `<td style="padding:8px;border-bottom:1px solid #eee">${val ?? ''}</td>`;
                });
                html += '</tr>';
            });
            const total = filtered.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
            html += `<tr><td colspan="${cols.length - 1}" style="text-align:right;font-weight:bold;padding:8px">Total:</td><td style="font-weight:bold;padding:8px">${formatCurrency(total)}</td></tr>`;
            html += '</tbody></table>';
            const win = window.open('', '_blank');
            if (!win) return notify('Popup blocked', 'error');
            win.document.write(`<html><head><title>${title}</title><style>body{padding:20px;font-family:Arial}@media print{.btn{display:none}}</style></head><body><div style="margin-bottom:10px"><button class="btn" onclick="window.print()">Save as PDF</button> <button class="btn" onclick="window.close()">Close</button></div>${html}</body></html>`);
            win.document.close();
        }

        // Edit Modal Logic
        let editState = { collection: null, id: null, fields: [] };

        function openEditModal(collection, id) {
            const data = LocalDB.getDoc(collection, id);
            if (!data) { notify('Record not found', 'error'); return; }
            editState = { collection, id, fields: Object.keys(data).filter(k => k !== 'id' && k !== 'createdAt') };
            const form = document.getElementById('edit-form');
            form.innerHTML = '';
            
            // Get schema columns for this collection
            const schema = Schema[collection];
            const columns = schema && schema.columns ? schema.columns : [];
            
            // Special handling for investments fields
            if (collection === 'investments') {
                const investorName = data.investor === 'Haji Hayat' ? 'Haji Hayat' : 'Abbas';
                
                // Description
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Description</label>
                    <input class="input" name="name" value="${data.name || ''}">
                </div>`;
                
                // Investor Amount (labeled as investor name)
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">${investorName} Amount</label>
                    <input class="input" type="number" name="amount" value="${parseFloat(data.amount) || 0}">
                </div>`;
                
                // Paid to
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Paid to</label>
                    <select class="input" name="paidTo">
                        <option value="Shop" ${data.paidTo === 'Shop' ? 'selected' : ''}>Shop</option>
                        <option value="Real Estate" ${data.paidTo === 'Real Estate' ? 'selected' : ''}>Real Estate</option>
                        <option value="Cash" ${data.paidTo === 'Cash' ? 'selected' : ''}>Cash</option>
                    </select>
                </div>`;
                
                // Date
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Date</label>
                    <input class="input" type="date" name="date" value="${data.date || ''}">
                </div>`;
                
                // Method
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Method</label>
                    <select class="input" name="method">
                        <option value="Cash" ${data.method === 'Cash' ? 'selected' : ''}>Cash</option>
                        <option value="Bank Transfer" ${data.method === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option>
                    </select>
                </div>`;
                
                // Hidden investor field (don't edit investor directly)
                form.innerHTML += `<input type="hidden" name="investor" value="${data.investor}">`;
                
            } else if (collection === 'invoices') {
                // Special handling for invoices
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Invoice #</label>
                    <input class="input" name="num" value="${data.num || ''}">
                </div>`;
                
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Company</label>
                    <input class="input" name="customer" value="${data.customer || ''}">
                </div>`;
                
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Total Amount</label>
                    <input class="input" type="number" name="amount" value="${parseFloat(data.amount) || 0}">
                </div>`;
                
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Paid Status</label>
                    <select class="input" name="paid">
                        <option value="No" ${data.paid === 'No' ? 'selected' : ''}>Not Paid</option>
                        <option value="Full" ${data.paid === 'Full' ? 'selected' : ''}>Paid Full</option>
                        <option value="Half" ${data.paid === 'Half' ? 'selected' : ''}>Paid Half</option>
                        <option value="Partially" ${data.paid === 'Partially' ? 'selected' : ''}>Paid Partially</option>
                    </select>
                </div>`;
                
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Amount Paid</label>
                    <input class="input" type="number" name="amountPaid" value="${parseFloat(data.amountPaid) || 0}">
                </div>`;
                
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Amount Unpaid</label>
                    <input class="input" type="number" name="amountUnpaid" value="${parseFloat(data.amountUnpaid) || 0}">
                </div>`;
                
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Date</label>
                    <input class="input" type="date" name="date" value="${data.date || ''}">
                </div>`;
                
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Paid On</label>
                    <input class="input" type="date" name="paidOn" value="${data.paidOn || ''}">
                </div>`;
                
                form.innerHTML += `<div class="form-group">
                    <label class="form-label">Payment Method</label>
                    <select class="input" name="paymentMethod">
                        <option value="cash" ${data.paymentMethod === 'cash' ? 'selected' : ''}>Cash</option>
                        <option value="bank" ${data.paymentMethod === 'bank' ? 'selected' : ''}>Bank</option>
                        <option value="card" ${data.paymentMethod === 'card' ? 'selected' : ''}>Card</option>
                    </select>
                </div>`;
                
            } else if (columns.length > 0) {
                // Use schema columns for other collections
                columns.forEach(col => {
                    if (!col.key) return; // Skip computed columns
                    const fieldName = col.key;
                    const fieldLabel = col.label;
                    const fieldValue = data[fieldName] ?? '';
                    
                    // Determine input type based on schema type
                    let inputType = 'text';
                    if (col.type === 'currency') inputType = 'number';
                    else if (col.type === 'date') inputType = 'date';
                    
                    // Handle special cases
                    if (fieldName === 'paid' || fieldName === 'status' || fieldName === 'type' || fieldName === 'cashType' || fieldName === 'service') {
                        // These should be dropdowns - we'll detect based on existing values
                        form.innerHTML += `<div class="form-group"><label class="form-label">${fieldLabel}</label><input class="input" name="${fieldName}" value="${fieldValue}"></div>`;
                    } else {
                        form.innerHTML += `<div class="form-group"><label class="form-label">${fieldLabel}</label><input class="input" type="${inputType}" name="${fieldName}" value="${fieldValue}"></div>`;
                    }
                });
            } else {
                // Fallback: generic handling if no schema defined
                editState.fields.forEach(k => {
                    const val = data[k] ?? '';
                    form.innerHTML += `<div class="form-group"><label class="form-label">${k}</label><input class="input" name="${k}" value="${val}"></div>`;
                });
            }
            
            // Show payment history button for invoices
            const paymentHistoryBtn = document.getElementById('payment-history-btn');
            if (collection === 'invoices') {
                paymentHistoryBtn.style.display = 'block';
                paymentHistoryBtn.onclick = () => openPaymentHistoryModal(id, data.num);
            } else {
                paymentHistoryBtn.style.display = 'none';
            }
            
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        function saveEdits(e) {
            e.preventDefault();
            const form = document.getElementById('edit-form');
            const updated = {};
            
            if (editState.collection === 'investments') {
                // For investments, map form fields to data fields
                const name = form.querySelector('[name="name"]');
                const amount = form.querySelector('[name="amount"]');
                const paidTo = form.querySelector('[name="paidTo"]');
                const date = form.querySelector('[name="date"]');
                const method = form.querySelector('[name="method"]');
                
                if (name) updated.name = name.value;
                if (amount) updated.amount = parseFloat(amount.value) || 0;
                if (paidTo) updated.paidTo = paidTo.value;
                if (date) updated.date = date.value;
                if (method) updated.method = method.value;
            } else if (editState.collection === 'invoices') {
                // For invoices, map form fields to data fields
                const num = form.querySelector('[name="num"]');
                const customer = form.querySelector('[name="customer"]');
                const amount = form.querySelector('[name="amount"]');
                const paid = form.querySelector('[name="paid"]');
                const amountPaid = form.querySelector('[name="amountPaid"]');
                const amountUnpaid = form.querySelector('[name="amountUnpaid"]');
                const date = form.querySelector('[name="date"]');
                const paidOn = form.querySelector('[name="paidOn"]');
                const paymentMethod = form.querySelector('[name="paymentMethod"]');
                
                if (num) updated.num = num.value;
                if (customer) updated.customer = customer.value;
                if (amount) updated.amount = parseFloat(amount.value) || 0;
                if (paid) updated.paid = paid.value;
                if (amountPaid) updated.amountPaid = parseFloat(amountPaid.value) || 0;
                if (amountUnpaid) updated.amountUnpaid = parseFloat(amountUnpaid.value) || 0;
                if (date) updated.date = date.value;
                if (paidOn) updated.paidOn = paidOn.value;
                if (paymentMethod) updated.paymentMethod = paymentMethod.value;
                updated.status = (paid && paid.value !== 'No') ? 'paid' : 'unpaid';
            } else {
                // Generic handling for other collections
                editState.fields.forEach(k => {
                    const input = form.querySelector(`[name="${k}"]`);
                    updated[k] = input ? (isFinite(input.value) ? parseFloat(input.value) : input.value) : undefined;
                });
            }
            
            updateInCollection(editState.collection, editState.id, updated);
            closeEditModal();
            notify('Record updated successfully!', 'success');
            
            // Auto-refresh the table after a short delay to show updates
            setTimeout(() => {
                const data = LocalDB.getCollection(editState.collection);
                renderTable(editState.collection, data);
            }, 200);
        }

        // Data Sync & Seeding
        async function syncAllFromFirebase() {
            const cols = ['expenses','investments','suppliers','invoices','exchange','cash','outstanding','outstanding_payments','payments'];
            let totalCloud = 0;
            let hasPermissionError = false;
            for (const c of cols) {
                try {
                    const snapshot = await db.collection(resolveColl(c)).get();
                    const data = [];
                    snapshot.forEach(doc => {
                        const raw = { id: doc.id, ...doc.data() };
                        const mapped = mapRead(c, raw);
                        data.push(mapped);
                    });
                    if (data.length) {
                        LocalDB.saveCollection(c, data);
                        renderTable(c, data);
                        totalCloud += data.length;
                    }
                } catch (e) {
                    if (e.code === 'permission-denied') {
                        hasPermissionError = true;
                        console.warn('Firebase sync blocked - check Firestore security rules');
                    } else {
                        console.warn('Sync read error:', e);
                    }
                }
            }
            if (hasPermissionError) {
                notify(`Synced ${totalCloud} local records (Firebase sync disabled - check security rules)`, 'warn');
            } else {
                notify(`Synced ${totalCloud} cloud records`);
            }
        }

        async function seedDemoData() {
            // Avoid duplicate seeding if local data exists
            const cols = ['expenses','investments','suppliers','invoices','exchange','cash','outstanding','outstanding_payments','payments'];
            const existing = cols.reduce((s, c) => s + (LocalDB.getCollection(c).length || 0), 0);
            if (existing > 0) {
                notify('Data already exists; seed skipped', 'warn');
                return;
            }
            const fmt = (d) => d.toISOString().split('T')[0];
            const today = new Date();
            const day = (n) => fmt(new Date(today.getFullYear(), today.getMonth(), today.getDate() - n));

            // Suppliers
            const suppliers = ['Alpha Traders','Beta Supplies','Gamma Imports','Delta Wholesale'];
            for (const name of suppliers) await addToCollection('suppliers', { name });

            // Expenses
            const expenses = [
                { desc:'Store Rent', amount: 1200, date: day(25) },
                { desc:'Utilities', amount: 320, date: day(22) },
                { desc:'Insurance', amount: 150, date: day(20) },
                { desc:'Internet', amount: 80, date: day(18) }
            ];
            for (const r of expenses) await addToCollection('expenses', r);

            // Investments
            const investments = [
                { name:'Initial Capital', investor:'Haji Hayat', amount: 5000, date: day(30), method:'Cash' },
                { name:'Equipment Purchase', investor:'Abbas', amount: 3000, date: day(27), method:'Bank Transfer' },
                { name:'Working Capital', investor:'Haji Hayat', amount: 2000, date: day(15), method:'Cash' }
            ];
            for (const r of investments) await addToCollection('investments', r);

            // Invoices
            const invoices = [
                { num:'INV-001', customer:'Alpha Traders', amount: 750, date: day(14), paid:'Yes', paidOn: day(10) },
                { num:'INV-002', customer:'Beta Supplies', amount: 540, date: day(12), paid:'No', paidOn:'' },
                { num:'INV-003', customer:'Gamma Imports', amount: 920, date: day(8), paid:'Yes', paidOn: day(5) }
            ];
            for (const r of invoices) await addToCollection('invoices', r);

            // Exchange (AUD-only)
            const exchange = [
                { amount: 1000, service:'RIA', cashType:'in', status:'Paid', paidOn: day(9) },
                { amount: 650, service:'Western Union', cashType:'out', status:'Pending', paidOn:'' },
                { amount: 1200, service:'Money Gram', cashType:'in', status:'Paid', paidOn: day(6) }
            ];
            for (const r of exchange) await addToCollection('exchange', r);

            // Cash
            const cash = [
                { desc:'Float Top-up', type:'in', amount: 300, date: day(7) },
                { desc:'Petty Expense', type:'out', amount: 45, date: day(7) }
            ];
            for (const r of cash) await addToCollection('cash', r);

            // Outstanding
            const outstanding = [
                { customer:'Delta Wholesale', amount: 410, date: day(3) }
            ];
            for (const r of outstanding) await addToCollection('outstanding', r);

            notify('Seeded demo data across all tabs');
        }

        async function checkCloudStatus() {
            const el = document.getElementById('cloud-status');
            if (!el) {
                console.warn('cloud-status element not found, skipping cloud status check');
                return;
            }
            el.textContent = 'Checking cloud collections...';
            const cols = ['expenses','investments','suppliers','invoices','exchange','cash','outstanding','outstanding_payments','payments'];
            const cache = getCloudNameCache();
            const rows = [];
            for (const c of cols) {
                let resolved = cache[c] || CollectionMap[c] || c;
                let count = 0;
                let used = resolved;
                let sampleKeys = [];
                const candidates = [resolved, ...(CloudNameCandidates[c] || [])];
                const tried = new Set();
                for (const name of candidates) {
                    if (!name || tried.has(name)) continue;
                    tried.add(name);
                    try {
                        const snap = await db.collection(name).get();
                        count = snap.size;
                        used = name;
                        if (count > 0) {
                            resolved = name;
                            // Fetch one doc to show its field keys
                            try {
                                const sampleSnap = await db.collection(name).limit(1).get();
                                sampleSnap.forEach(doc => {
                                    const data = doc.data() || {};
                                    sampleKeys = Object.keys(data).sort();
                                });
                            } catch {}
                            break;
                        }
                    } catch {}
                }
                cache[c] = resolved;
                rows.push({ tab: c, cloud: used, count, sampleKeys });
            }
            setCloudNameCache(cache);
            const html = `<div class="glass p-4 mt-2"><div class="font-bold mb-2">Cloud Status</div>
                <table style="width:100%;border-collapse:collapse">
                    <thead><tr>
                        <th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Tab</th>
                        <th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Cloud Collection</th>
                        <th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Docs</th>
                        <th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Sample Keys</th>
                    </tr></thead>
                    <tbody>${rows.map(r => `<tr>
                        <td style='padding:6px;border-bottom:1px solid #e5e7eb'>${r.tab}</td>
                        <td style='padding:6px;border-bottom:1px solid #e5e7eb'>${r.cloud}</td>
                        <td style='padding:6px;border-bottom:1px solid #e5e7eb;text-align:right'>${r.count}</td>
                        <td style='padding:6px;border-bottom:1px solid #e5e7eb'>${(r.sampleKeys||[]).join(', ')}</td>
                    </tr>`).join('')}</tbody>
                </table></div>`;
            el.innerHTML = html;
        }

        function loadSchemaMapUI() {
            const fm = getFieldMap();
            const el = document.getElementById('schema-map-json');
            if (el) el.value = JSON.stringify(fm, null, 2);
        }
        function saveSchemaMapUI() {
            const el = document.getElementById('schema-map-json');
            if (!el) return;
            const txt = el.value;
            try {
                const obj = JSON.parse(txt || '{}');
                setFieldMap(obj);
                notify('Saved field mapping');
                ['expenses','investments','suppliers','invoices','exchange','cash','outstanding','outstanding_payments','payments'].forEach(col => loadCollection(col));
            } catch (e) {
                notify('Invalid JSON mapping', 'error');
            }
        }

        // Backup/Import removed per your preference

        // Initialize
        async function updateConnectionStatus() {
            const el = document.getElementById('connection-status');
            try {
                await db.collection('expenses').limit(1).get();
                el.textContent = 'âœ… Connected to Firebase';
            } catch (e) {
                el.textContent = 'ðŸŸ  Offline mode (LocalDB)';
            }
        }

        window.addEventListener('error', (e) => {
            notify(`Error: ${e.message}`, 'error');
        });
        window.addEventListener('unhandledrejection', (e) => {
            notify(`Error: ${e.reason && e.reason.message ? e.reason.message : e.reason}`, 'error');
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Force-remove any old PWA caches/service workers from previous app versions
            (async () => {
                try {
                    // Only attempt service worker cleanup if we're in a proper protocol (not null/file)
                    if ('serviceWorker' in navigator && window.location.protocol !== 'null:') {
                        try {
                            const regs = await navigator.serviceWorker.getRegistrations();
                            regs.forEach(r => r.unregister());
                        } catch (swErr) {
                            console.warn('Service worker cleanup skipped:', swErr.message);
                        }
                    }
                    if (window.caches && caches.keys) {
                        try {
                            const keys = await caches.keys();
                            await Promise.all(keys.map(k => caches.delete(k)));
                        } catch (cacheErr) {
                            console.warn('Cache cleanup skipped:', cacheErr.message);
                        }
                    }
                    console.log('âœ“ Cleared old service workers and caches');
                } catch (e) {
                    console.warn('Cleanup error:', e.message);
                }
            })();

            document.getElementById('expense-date').valueAsDate = new Date();
            document.getElementById('inv-date').valueAsDate = new Date();
            document.getElementById('out-date').valueAsDate = new Date();
            const suppDateEl = document.getElementById('supp-date');
            if (suppDateEl) suppDateEl.valueAsDate = new Date();
            bindTabClicks();
            
            // Update connection status by probing Firestore
            updateConnectionStatus();
            
            // Prefill field mapping defaults if empty
            try {
                const fmExisting = getFieldMap();
                if (!fmExisting || Object.keys(fmExisting).length === 0) {
                    const fmDefault = {
                        expenses: { desc: 'desc', amount: 'amount', date: 'date' },
                        // Cloud 'name' corresponds to local 'investor'
                        investments: { investor: 'name', amount: 'amount', date: 'date', paidTo: 'paidTo', method: 'method' },
                        suppliers: { name: 'name', phone: 'phone', details: 'details' },
                        invoices: { num: 'invoiceNumber', customer: 'customer', amount: 'totalAmount', date: 'date', paidOn: 'paidOn', paymentMethod: 'paymentMethod', bsb: 'bsb', gstRate: 'gstRate', gstAmount: 'gstAmount', netAmount: 'netAmount', amountPaid: 'amountPaid', amountUnpaid: 'amountUnpaid', gstType: 'gstType' },
                        exchange: { amount: 'amount', service: 'service', cashType: 'cashType', status: 'status', paidOn: 'paidOn' },
                        cash: { desc: 'desc', type: 'type', amount: 'amount', date: 'date' },
                        outstanding: { customer: 'customer', amount: 'amount', date: 'date' },
                        outstanding_payments: { outstandingId: 'outstandingId', customer: 'customer', amount: 'amount', paidOn: 'paidOn', paymentMethod: 'paymentMethod' },
                        payments: { invoiceNum: 'invoiceNum', invoiceId: 'invoiceId', customer: 'customer', amount: 'amount', paidOn: 'paidOn', paymentMethod: 'paymentMethod' }
                    };
                    setFieldMap(fmDefault);
                    const schemaEl = document.getElementById('schema-map-json');
                    if (schemaEl) schemaEl.value = JSON.stringify(fmDefault, null, 2);
                }
            } catch (e) {
                console.warn('Field mapping init error:', e);
            }

            // Load all collections then perform a cloud sync to ensure latest data is shown
            const collections = ['expenses', 'investments', 'suppliers', 'invoices', 'exchange', 'cash', 'outstanding', 'outstanding_payments', 'payments'];
            collections.forEach(col => loadCollection(col));
            
            // Restore previous tab state after a short delay to ensure DOM is ready
            setTimeout(() => {
                try {
                    const savedTab = localStorage.getItem('currentTab');
                    if (savedTab && document.getElementById(`tab-${savedTab}`)) {
                        const tabBtn = document.querySelector(`[data-tab="${savedTab}"]`);
                        if (tabBtn) {
                            switchTab(tabBtn, savedTab);
                            // If investments tab, also restore the investment subtab
                            if (savedTab === 'investments') {
                                const savedInvTab = localStorage.getItem('currentInvTab') || 'all';
                                switchInvTab(savedInvTab);
                            }
                        }
                    } else {
                        // Default to expenses tab if no saved state
                        const expensesBtn = document.querySelector('[data-tab="expenses"]');
                        if (expensesBtn) switchTab(expensesBtn, 'expenses');
                    }
                } catch (e) {
                    console.warn('Tab state restore error:', e);
                    // Default to expenses tab on error
                    const expensesBtn = document.querySelector('[data-tab="expenses"]');
                    if (expensesBtn) switchTab(expensesBtn, 'expenses');
                }
            }, 100);
            // Light delay to avoid blocking UI
            setTimeout(() => { syncAllFromFirebase(); }, 300);
            // Setup invoice form listeners
            setTimeout(() => { setupInvoiceFormListeners(); }, 50);
            // After syncing, auto-check cloud status to show sample keys
            setTimeout(() => { checkCloudStatus(); }, 600);
            // Populate company autocomplete
            refreshCompaniesDatalist();
            
            const build = '2026-01-29T' + new Date().toTimeString().slice(0,8);
            document.getElementById('build-version').textContent = `Build: ${build}`;
            console.log('âœ“ Gulistan Supermarket & Halal Meat Initialized');
            console.log('âœ“ Firebase Firestore Connected');
            console.log('âœ“ Build version:', build);

            // Enable Paid On fields when Paid = Yes
            const invPaidSel = document.getElementById('inv-paid');
            const invPaidOn = document.getElementById('inv-paid-on');
            if (invPaidSel && invPaidOn) {
                invPaidSel.addEventListener('change', () => {
                    invPaidOn.disabled = invPaidSel.value !== 'Yes';
                    if (invPaidOn.disabled) invPaidOn.value = '';
                });
            }

            const excStatusSel = document.getElementById('exc-status');
            const excPaidOn = document.getElementById('exc-paid-on');
            if (excStatusSel && excPaidOn) {
                excStatusSel.addEventListener('change', () => {
                    excPaidOn.disabled = excStatusSel.value !== 'Paid';
                    if (excPaidOn.disabled) excPaidOn.value = '';
                });
            }

            // Simple search bindings per tab
            ['invoices','exchange','investments','suppliers'].forEach(tab => {
                const input = document.getElementById(`${tab}-search`);
                if (!input) return;
                input.addEventListener('input', () => {
                    const q = input.value.toLowerCase();
                    const rows = LocalDB.getCollection(tab);
                    const filtered = rows.filter(r => JSON.stringify(r).toLowerCase().includes(q));
                    renderTable(tab, filtered);
                });
            });

            // Investment investor tab searches
            const hayatSearch = document.getElementById('inv-hayat-search');
            if (hayatSearch) {
                hayatSearch.addEventListener('input', () => {
                    const q = hayatSearch.value.toLowerCase();
                    const rows = LocalDB.getCollection('investments').filter(r => r.investor === 'Haji Hayat');
                    const filtered = rows.filter(r => JSON.stringify(r).toLowerCase().includes(q));
                    renderTableToContainer('investments', filtered, 'investments-hayat-table');
                    updateInvestorTotal('hayat', filtered);
                });
            }

            const abbasSearch = document.getElementById('inv-abbas-search');
            if (abbasSearch) {
                abbasSearch.addEventListener('input', () => {
                    const q = abbasSearch.value.toLowerCase();
                    const rows = LocalDB.getCollection('investments').filter(r => r.investor === 'Abbas');
                    const filtered = rows.filter(r => JSON.stringify(r).toLowerCase().includes(q));
                    renderTableToContainer('investments', filtered, 'investments-abbas-table');
                    updateInvestorTotal('abbas', filtered);
                });
            }
        });

        // Company autocomplete list (based on existing invoices + suppliers)
        function refreshCompaniesDatalist() {
            const elId = 'companies-list';
            let dl = document.getElementById(elId);
            if (!dl) {
                dl = document.createElement('datalist');
                dl.id = elId;
                document.body.appendChild(dl);
            }
            const names = new Set();
            LocalDB.getCollection('suppliers').forEach(s => { if (s.name) names.add(s.name); });
            LocalDB.getCollection('invoices').forEach(i => { if (i.customer) names.add(i.customer); });
            dl.innerHTML = Array.from(names).sort().map(n => `<option value="${n}"></option>`).join('');
            const quickSel = document.getElementById('suppliers-quick-select');
            if (quickSel) {
                quickSel.innerHTML = '<option value="">Select company...</option>' + Array.from(names).sort().map(n => `<option value="${n}">${n}</option>`).join('');
            }
        }

        function addSupplierQuick() {
            const sel = document.getElementById('suppliers-quick-select');
            const name = normalizeName(sel ? sel.value : '');
            if (!name) return notify('Select a company to add', 'error');
            const existing = LocalDB.getCollection('suppliers');
            if (existing.some(s => normalizeName(s.name) === name)) {
                return notify('Supplier already exists', 'warn');
            }
            addToCollection('suppliers', { name });
            notify('Supplier added');
            refreshCompaniesDatalist();
        }

        // Printing helpers
        function buildPrintHeader(title) {
            const logo = '<img src="logo.png" alt="Logo" style="height:48px;margin-bottom:8px" onerror="this.style.display=\'none\'">';
            const company = '<div style="font-weight:700;font-size:16px">Gulistan Supermarket & Halal Meat - Management System</div>';
            const sub = `<div style="font-size:12px;color:#374151">${new Date().toLocaleString()}</div>`;
            return `<div class="print-header">${logo}${company}${sub}<div style="margin-top:8px;font-weight:600">${title}</div></div>`;
        }

        function buildSummaryHTML(collection, rows) {
            const schema = Schema[collection];
            const parts = [];
            if (schema && Array.isArray(schema.totals)) {
                for (const t of schema.totals) {
                    if (typeof t.reducer === 'function') {
                        const val = t.reducer(rows);
                        parts.push(`${t.label}: ${typeof val === 'number' ? formatCurrency(val) : val}`);
                    } else if (t.key) {
                        const filtered = t.filter ? rows.filter(t.filter) : rows;
                        const sum = filtered.reduce((s, r) => s + (parseFloat(r[t.key]) || 0), 0);
                        parts.push(`${t.label}: ${formatCurrency(sum)}`);
                    }
                }
            }
            // Additional summaries per collection
            if (collection === 'investments') {
                const hayat = rows.filter(r => r.investor === 'Haji Hayat').reduce((s, r) => s + (parseFloat(r.amount)||0), 0);
                const abbas = rows.filter(r => r.investor === 'Abbas').reduce((s, r) => s + (parseFloat(r.amount)||0), 0);
                parts.push(`Haji Hayat: ${formatCurrency(hayat)}`);
                parts.push(`Abbas: ${formatCurrency(abbas)}`);
                const methodCash = rows.filter(r => r.method === 'Cash').reduce((s, r) => s + (parseFloat(r.amount)||0), 0);
                const methodBank = rows.filter(r => r.method === 'Bank Transfer').reduce((s, r) => s + (parseFloat(r.amount)||0), 0);
                parts.push(`Cash: ${formatCurrency(methodCash)}`);
                parts.push(`Bank Transfer: ${formatCurrency(methodBank)}`);
            } else if (collection === 'suppliers') {
                parts.push(`Suppliers Count: ${rows.length}`);
            }
            if (!parts.length) return '';
            return `<div style="margin-top:12px"><div style="font-weight:600;margin-bottom:6px">Summary</div><ul style="list-style:none;padding:0;margin:0">${parts.map(p => `<li style="margin-bottom:4px">${p}</li>`).join('')}</ul></div>`;
        }

        function getMonthKey(d) {
            const date = new Date(d || Date.now());
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${y}-${m}`;
        }

        function buildMonthlySection(collection, rows) {
            const fieldMap = { expenses:'amount', investments:'amount', invoices:'amount', exchange:'amount', cash:'amount', outstanding:'amount' };
            const field = fieldMap[collection];
            if (!field) return '';
            // Invoices: monthly Paid vs Unpaid columns
            if (collection === 'invoices') {
                const monthly = new Map();
                rows.forEach(r => {
                    const key = getMonthKey(r.date || r.createdAt);
                    const amt = parseFloat(r.amount) || 0;
                    const isPaid = (r.paid !== 'No');
                    const cur = monthly.get(key) || { paid:0, unpaid:0 };
                    if (isPaid) cur.paid += amt; else cur.unpaid += amt;
                    monthly.set(key, cur);
                });
                if (!monthly.size) return '';
                const rowsHtml = Array.from(monthly.entries()).sort(([a],[b]) => a.localeCompare(b))
                    .map(([mon, o]) => {
                        const total = (o.paid||0) + (o.unpaid||0);
                        return `<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb">${mon}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right">${formatCurrency(o.paid||0)}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right">${formatCurrency(o.unpaid||0)}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right">${formatCurrency(total)}</td></tr>`;
                    })
                    .join('');
                return `<div style="margin-top:12px"><div style="font-weight:600;margin-bottom:6px">Monthly Breakdown</div><table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Month</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Paid</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Unpaid</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Total</th></tr></thead><tbody>${rowsHtml}</tbody></table></div>`;
            }
            // Exchange: monthly totals and Cash In/Out
            if (collection === 'exchange') {
                // First section: Amount, Cash In, Cash Out
                const monthly = new Map();
                rows.forEach(r => {
                    const key = getMonthKey(r.date || r.createdAt);
                    const amt = parseFloat(r.amount) || 0;
                    const cur = monthly.get(key) || { amount:0, in:0, out:0 };
                    cur.amount += amt;
                    if (r.cashType === 'in') cur.in += amt; else if (r.cashType === 'out') cur.out += amt;
                    monthly.set(key, cur);
                });
                if (!monthly.size) return '';
                const rowsHtml1 = Array.from(monthly.entries()).sort(([a],[b]) => a.localeCompare(b))
                    .map(([mon, o]) => `<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb">${mon}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right">${formatCurrency(o.amount||0)}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right">${formatCurrency(o.in||0)}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right">${formatCurrency(o.out||0)}</td></tr>`)
                    .join('');
                const section1 = `<div style="margin-top:12px"><div style="font-weight:600;margin-bottom:6px">Monthly Breakdown</div><table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Month</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Amount</th><th style=\"text-align:right;padding:6px;border-bottom:1px solid #e5e7eb\">Cash In</th><th style=\"text-align:right;padding:6px;border-bottom:1px solid #e5e7eb\">Cash Out</th></tr></thead><tbody>${rowsHtml1}</tbody></table></div>`;

                // Second section: Per-service totals per month (based on To Amount)
                const monthlySvc = new Map();
                rows.forEach(r => {
                    const key = getMonthKey(r.date || r.createdAt);
                    const to = parseFloat(r.amount) || 0;
                    const svc = r.service || 'Other';
                    const cur = monthlySvc.get(key) || { RIA:0, 'Western Union':0, 'Money Gram':0, Hawala:0 };
                    if (svc in cur) cur[svc] += to;
                    monthlySvc.set(key, cur);
                });
                const rowsHtml2 = Array.from(monthlySvc.entries()).sort(([a],[b]) => a.localeCompare(b))
                    .map(([mon, o]) => `<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb">${mon}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right">${formatCurrency(o['RIA']||0)}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right">${formatCurrency(o['Western Union']||0)}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right">${formatCurrency(o['Money Gram']||0)}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right">${formatCurrency(o['Hawala']||0)}</td></tr>`)
                    .join('');
                const section2 = `<div style="margin-top:12px"><div style="font-weight:600;margin-bottom:6px">Monthly by Service</div><table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Month</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">RIA</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Western Union</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Money Gram</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Hawala</th></tr></thead><tbody>${rowsHtml2}</tbody></table></div>`;
                return section1 + section2;
            }
            // Default: single Total column per month
            const monthly = new Map();
            rows.forEach(r => {
                const key = getMonthKey(r.date || r.createdAt);
                const val = parseFloat(r[field]) || 0;
                monthly.set(key, (monthly.get(key) || 0) + val);
            });
            if (!monthly.size) return '';
            const rowsHtml = Array.from(monthly.entries()).sort(([a],[b]) => a.localeCompare(b))
                .map(([mon, total]) => `<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb">${mon}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right">${formatCurrency(total)}</td></tr>`)
                .join('');
            return `<div style="margin-top:12px"><div style="font-weight:600;margin-bottom:6px">Monthly Breakdown</div><table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Month</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Total</th></tr></thead><tbody>${rowsHtml}</tbody></table></div>`;
        }

        function printTable(collection) {
            const rows = LocalDB.getCollection(collection);
            const schema = Schema[collection];
            const cols = (schema && schema.columns) ? schema.columns : Object.keys(rows[0]||{}).filter(k => k!=='id' && k!=='createdAt').map(k => ({key:k,label:k}));
            let html = buildPrintHeader(`${collection.toUpperCase()} Report`);
            html += '<table style="width:100%;border-collapse:collapse">';
            html += '<thead><tr>' + cols.map(c => `<th style="border-bottom:1px solid #e5e7eb;padding:8px;text-align:left">${c.label}</th>`).join('') + '</tr></thead><tbody>';
            rows.forEach(r => {
                html += '<tr>' + cols.map(c => {
                    let val = r[c.key];
                    if (c.type==='currency') val = formatCurrency(val);
                    else if (c.type==='date') val = formatDate(val);
                    return `<td style="border-bottom:1px solid #e5e7eb;padding:8px">${val ?? ''}</td>`;
                }).join('') + '</tr>';
            });
            html += '</tbody></table>';
            const win = window.open('', '_blank');
            if (!win) return notify('Popup blocked: enable popups to print', 'error');
            win.document.write(`<html><head><title>${collection} Report</title>
            <style>body{font-family:Segoe UI,Tahoma,sans-serif;padding:16px} .bar{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px}</style>
            </head><body>
            <div class="bar"><button onclick="window.close()">Back to App</button><button onclick="window.print()">Print</button></div>
            ${html}
            </body></html>`);
            win.document.close();
            win.focus();
        }

        function printRow(collection, id) {
            const row = LocalDB.getDoc(collection, id);
            if (!row) return notify('Record not found', 'error');
            const schema = Schema[collection];
            const cols = (schema && schema.columns) ? schema.columns : Object.keys(row).filter(k => k!=='id' && k!=='createdAt').map(k => ({key:k,label:k}));
            let html = buildPrintHeader(`${collection.toUpperCase()} Item`);
            html += '<table style="width:100%;border-collapse:collapse">';
            cols.forEach(c => {
                let val = row[c.key];
                if (c.type==='currency') val = formatCurrency(val);
                else if (c.type==='date') val = formatDate(val);
                html += `<tr><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">${c.label}</th><td style="padding:8px;border-bottom:1px solid #e5e7eb">${val ?? ''}</td></tr>`;
            });
            html += '</table>';
            
            // Add payment history for invoices
            if (collection === 'invoices') {
                const payments = LocalDB.getCollection('payments').filter(p => p.invoiceNum === row.num);
                if (payments.length > 0) {
                    html += '<h3 style="margin-top:20px;margin-bottom:10px">Payment History</h3>';
                    html += '<table style="width:100%;border-collapse:collapse">';
                    html += '<thead><tr style="background:#f3f4f6"><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">Date</th><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">Amount</th><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">Method</th></tr></thead>';
                    payments.forEach(p => {
                        html += `<tr><td style="padding:8px;border-bottom:1px solid #e5e7eb">${formatDate(p.paidOn)}</td><td style="padding:8px;border-bottom:1px solid #e5e7eb">${formatCurrency(p.amount)}</td><td style="padding:8px;border-bottom:1px solid #e5e7eb">${p.paymentMethod}</td></tr>`;
                    });
                    html += '</table>';
                }
            }
            
            const win = window.open('', '_blank');
            if (!win) return notify('Popup blocked: enable popups to print', 'error');
            win.document.write(`<html><head><title>${collection} Item</title>
            <style>body{font-family:Segoe UI,Tahoma,sans-serif;padding:16px} .bar{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px}</style>
            </head><body>
            <div class="bar"><button onclick="window.close()">Back to App</button><button onclick="window.print()">Print</button></div>
            ${html}
            </body></html>`);
            win.document.close();
            win.focus();
        }

        // Print Preview helpers
        function openPrintPreviewHTML(title, html, shareText) {
            const container = document.getElementById('print-content');
            container.innerHTML = buildPrintHeader(title) + html;
            container.dataset.shareText = shareText || '';
            document.getElementById('print-overlay').classList.add('active');
        }

        function closePrintPreview() {
            document.getElementById('print-overlay').classList.remove('active');
            document.getElementById('print-content').innerHTML = '';
        }

        function printFromOverlay() {
            window.print();
        }

        async function shareFromOverlay() {
            const txt = document.getElementById('print-content').dataset.shareText || '';
            if (!txt) return notify('Nothing to share', 'error');
            if (navigator.share) {
                try { await navigator.share({ title: 'Report', text: txt }); } catch (e) {}
            } else {
                await navigator.clipboard.writeText(txt);
                notify('Copied summary to clipboard');
            }
        }

        function openPrintPreviewForTable(collection) {
            const rows = LocalDB.getCollection(collection);
            const schema = Schema[collection];
            const cols = (schema && schema.columns) ? schema.columns : Object.keys(rows[0]||{}).filter(k => k!=='id' && k!=='createdAt').map(k => ({key:k,label:k}));
            let table = '<table style="width:100%;border-collapse:collapse">';
            table += '<thead><tr>' + cols.map(c => `<th style="border-bottom:1px solid #e5e7eb;padding:8px;text-align:left">${c.label}</th>`).join('') + '</tr></thead><tbody>';
            rows.forEach(r => {
                table += '<tr>' + cols.map(c => {
                    let val = r[c.key];
                    if (c.type==='currency') val = formatCurrency(val);
                    else if (c.type==='date') val = formatDate(val);
                    return `<td style="border-bottom:1px solid #e5e7eb;padding:8px">${val ?? ''}</td>`;
                }).join('') + '</tr>';
            });
            table += '</tbody></table>';
            const summary = buildSummaryHTML(collection, rows);
            const monthly = buildMonthlySection(collection, rows);
            const shareText = rows.map(r => cols.map(c => `${c.label}: ${r[c.key] ?? ''}`).join(' | ')).join('\n')
                + (summary ? `\n\n${summary.replace(/<[^>]+>/g,'')}` : '')
                + (monthly ? `\n\n${monthly.replace(/<[^>]+>/g,'')}` : '');
            openPrintPreviewHTML(`${collection.toUpperCase()} Report`, table + summary + monthly, shareText);
        }

        function openPrintPreviewForRow(collection, id) {
            const row = LocalDB.getDoc(collection, id);
            if (!row) return notify('Record not found', 'error');
            const schema = Schema[collection];
            const cols = (schema && schema.columns) ? schema.columns : Object.keys(row).filter(k => k!=='id' && k!=='createdAt').map(k => ({key:k,label:k}));
            let table = '<table style="width:100%;border-collapse:collapse">';
            cols.forEach(c => {
                let val = row[c.key];
                if (c.type==='currency') val = formatCurrency(val);
                else if (c.type==='date') val = formatDate(val);
                table += `<tr><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">${c.label}</th><td style="padding:8px;border-bottom:1px solid #e5e7eb">${val ?? ''}</td></tr>`;
            });
            table += '</table>';
            
            // Add payment history for invoices
            if (collection === 'invoices') {
                const payments = LocalDB.getCollection('payments').filter(p => p.invoiceNum === row.num);
                if (payments.length > 0) {
                    table += '<h3 style="margin-top:20px;margin-bottom:10px">Payment History</h3>';
                    table += '<table style="width:100%;border-collapse:collapse">';
                    table += '<thead><tr style="background:#f3f4f6"><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">Date</th><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">Amount</th><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">Method</th></tr></thead>';
                    payments.forEach(p => {
                        table += `<tr><td style="padding:8px;border-bottom:1px solid #e5e7eb">${formatDate(p.paidOn)}</td><td style="padding:8px;border-bottom:1px solid #e5e7eb">${formatCurrency(p.amount)}</td><td style="padding:8px;border-bottom:1px solid #e5e7eb">${p.paymentMethod}</td></tr>`;
                    });
                    table += '</table>';
                }
            }
            
            const shareText = cols.map(c => `${c.label}: ${row[c.key] ?? ''}`).join(' | ');
            openPrintPreviewHTML(`${collection.toUpperCase()} Item`, table, shareText);
        }

        function exportCSV(collection) {
            const rows = LocalDB.getCollection(collection);
            if (!rows.length) return notify('No data to export', 'error');
            const headers = Object.keys(rows[0]).filter(k => k!=='id' && k!=='createdAt');
            const csv = [headers.join(',')].concat(rows.map(r => headers.map(h => JSON.stringify(r[h] ?? '')).join(','))).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${collection}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function shareTable(collection) {
            const rows = LocalDB.getCollection(collection);
            if (!rows.length) return notify('No data to share', 'error');
            const headers = Object.keys(rows[0]).filter(k => k!=='id' && k!=='createdAt');
            const text = rows.map(r => headers.map(h => `${h}: ${r[h] ?? ''}`).join(' | ')).join('\n');
            if (navigator.share) {
                try {
                    await navigator.share({ title: `${collection} report`, text });
                } catch (e) { notify('Share cancelled', 'error'); }
            } else {
                await navigator.clipboard.writeText(text);
                notify('Copied summary to clipboard');
            }
        }
        
        async function shareInvestorTab(investor) {
            try {
                const investorName = investor === 'hayat' ? 'Haji Hayat' : 'Abbas';
                // Export as PDF first, then share
                await exportInvestmentsPDF(investor);
                notify(`${investorName} PDF exported and ready to share`, 'success');
            } catch (e) {
                notify(`Error sharing ${investor} data: ${e.message}`, 'error');
            }
        }
    </script>
    
    <!-- Browser Compatibility Script -->
    <script>
        // Detect browser and add compatibility flags
        const userAgent = navigator.userAgent;
        const isChrome = /Chrome/.test(userAgent) && /Google Inc/.test(navigator.vendor);
        const isFirefox = /Firefox/.test(userAgent);
        const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
        const isEdge = /Edg/.test(userAgent);
        
        // Store browser info in window for conditional fixes
        window.browserInfo = {
            isChrome,
            isFirefox,
            isSafari,
            isEdge,
            isMobile: /iPhone|iPad|iPod|Android/.test(userAgent)
        };
        
        // Fix for Safari iOS viewport height issue
        if (window.browserInfo.isSafari && window.browserInfo.isMobile) {
            const fixViewportHeight = () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };
            fixViewportHeight();
            window.addEventListener('resize', fixViewportHeight);
            window.addEventListener('orientationchange', fixViewportHeight);
            // Use CSS variable for height: height: 100vh; /* fallback */ height: calc(var(--vh, 1vh) * 100);
        }
        
        // Polyfill for Object.hasOwn (Edge/older Safari)
        if (typeof Object.hasOwn !== 'function') {
            Object.hasOwn = function(obj, prop) {
                return Object.prototype.hasOwnProperty.call(obj, prop);
            };
        }
        
        // Polyfill for String.prototype.replaceAll (older Edge)
        if (!String.prototype.replaceAll) {
            String.prototype.replaceAll = function(str, newStr) {
                if (Object.prototype.toString.call(str) === '[object RegExp]') {
                    return this.replace(str, newStr);
                }
                return this.replace(new RegExp(str, 'g'), newStr);
            };
        }
        
        // Fix for Firefox localStorage in private mode
        if (window.browserInfo.isFirefox) {
            const testStorage = () => {
                try {
                    const test = '__test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            };
            window.storageAvailable = testStorage();
        }
        
        console.log('âœ“ Browser Compatibility initialized:', window.browserInfo);
    </script>
</body>
</html>
