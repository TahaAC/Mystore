<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Gulistan - Management System</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #3b82f6;
            --dark: #0f172a;
            --glass: rgba(15, 23, 42, 0.7);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #020617 0%, #1e293b 100%);
            color: #f1f5f9;
            min-height: 100vh;
        }
        .glass {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
        }
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            color: white;
        }
        .btn-primary { background: var(--secondary); }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }
        .input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 14px;
        }
        .input:focus { outline: none; border-color: var(--secondary); }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid var(--secondary);
            font-weight: 600;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }
        tr:hover { background: rgba(59, 130, 246, 0.05); }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--glass);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            z-index: 2000;
            display: none;
        }
        .notification.show { display: block; }
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .tab { display: none; }
        .tab.active { display: block; }
        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #cbd5e1;
            padding: 10px 0;
        }
        .spinner {
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .nav-tab {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #cbd5e1;
            cursor: pointer;
            border-radius: 6px;
            margin-right: 10px;
            transition: all 0.2s;
        }
        .nav-tab:hover { background: rgba(255, 255, 255, 0.2); }
        .nav-tab.active {
            background: var(--secondary);
            color: white;
            font-weight: 600;
        }
        /* Print styles */
        @media print {
            body { background: white; color: black; }
            .no-print { display: none !important; }
            .print-header { display: block !important; }
            .glass { background: white !important; border: none !important; }
            table th { background: #f3f4f6 !important; color: #111827 !important; border-bottom-color: #e5e7eb !important; }
            table td { border-bottom-color: #e5e7eb !important; color: #111827 !important; }
        }
        .print-header { display: none; text-align: center; margin-bottom: 16px; }
        .toolbar-btn { font-size: 12px; padding: 6px 10px; }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto p-4 sm:p-6">
        <!-- Header -->
        <div class="glass p-6 mb-6 rounded-xl">
            <div class="flex items-center justify-between gap-4 flex-wrap">
                <div class="flex items-center gap-3">
                    <img src="logo.png" alt="Logo" class="w-10 h-10 rounded-xl object-cover" onerror="this.style.display='none'">
                    <div>
                        <h1 class="text-3xl font-bold mb-1">Gulistan</h1>
                        <p class="text-gray-400 text-sm">Management System</p>
                    </div>
                </div>
                <div class="flex-1 min-w-[160px]" id="firebase-status" style="display:none">
                    <p class="text-sm" id="connection-status">Connecting...</p>
                    <p class="text-xs text-gray-400" id="build-version"></p>
                </div>
                <div class="flex items-center gap-2 flex-wrap justify-end"></div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="glass p-4 mb-6 rounded-xl overflow-x-auto">
            <div class="flex gap-2 whitespace-nowrap">
                <button class="nav-tab active" data-tab="expenses"><i class="fas fa-receipt mr-2"></i>Expenses</button>
                <button class="nav-tab" data-tab="investments"><i class="fas fa-hand-holding-usd mr-2"></i>Investments</button>
                <button class="nav-tab" data-tab="suppliers"><i class="fas fa-truck mr-2"></i>Suppliers</button>
                <button class="nav-tab" data-tab="invoices"><i class="fas fa-file-invoice mr-2"></i>Invoices</button>
                <button class="nav-tab" data-tab="exchange"><i class="fas fa-exchange-alt mr-2"></i>Exchange</button>
                <button class="nav-tab" data-tab="cash"><i class="fas fa-coins mr-2"></i>Cash</button>
                <button class="nav-tab" data-tab="outstanding"><i class="fas fa-star mr-2"></i>Outstanding</button>
                <button class="nav-tab" data-tab="reports"><i class="fas fa-chart-line mr-2"></i>Reports</button>
            </div>
        </div>

        <!-- Content -->
        <div class="tab active" id="tab-expenses">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-receipt mr-2"></i>Expenses</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" id="expense-desc" class="input" placeholder="Expense description">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="expense-amount" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="expense-date" class="input">
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addExpense()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <div id="expenses-totals" class="text-sm text-gray-300"></div>
                <div id="expenses-table"></div>
            </div>
        </div>

        <div class="tab" id="tab-investments">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-hand-holding-usd mr-2"></i>Investments</h2>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" id="inv-name" class="input" placeholder="Investment description">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Investor</label>
                        <select id="inv-investor" class="input">
                            <option>Haji Hayat</option>
                            <option>Abbas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="inv-amount" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="inv-date" class="input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Method</label>
                        <select id="inv-method" class="input">
                            <option>Cash</option>
                            <option>Bank Transfer</option>
                        </select>
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addInvestment()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <input id="investments-search" class="input" placeholder="Search investments" style="max-width:320px">
                    <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForTable('investments')"><i class="fas fa-eye mr-1"></i>Preview</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="printTable('investments')"><i class="fas fa-print mr-1"></i>Print</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="exportCSV('investments')"><i class="fas fa-file-export mr-1"></i>Export</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="shareTable('investments')"><i class="fas fa-share-alt mr-1"></i>Share</button>
                </div>
                <div id="investments-table"></div>
                <div id="investments-totals" class="text-sm text-gray-300 mt-2"></div>
            </div>
        </div>

        <div class="tab" id="tab-suppliers">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-truck mr-2"></i>Suppliers</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" id="supp-name" class="input" placeholder="Supplier name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact</label>
                        <input type="text" id="supp-contact" class="input" placeholder="Phone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="supp-email" class="input" placeholder="Email">
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addSupplier()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <input id="suppliers-search" class="input" placeholder="Search suppliers" style="max-width:320px">
                    <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForTable('suppliers')"><i class="fas fa-eye mr-1"></i>Preview</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="printTable('suppliers')"><i class="fas fa-print mr-1"></i>Print</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="exportCSV('suppliers')"><i class="fas fa-file-export mr-1"></i>Export</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="shareTable('suppliers')"><i class="fas fa-share-alt mr-1"></i>Share</button>
                </div>
                <div id="suppliers-table"></div>
                <div id="suppliers-totals" class="text-sm text-gray-300 mt-2"></div>
            </div>
        </div>

        <div class="tab" id="tab-invoices">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-file-invoice mr-2"></i>Invoices</h2>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">Invoice #</label>
                        <input type="text" id="inv-num" class="input" placeholder="Invoice number">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company</label>
                        <input type="text" id="inv-customer" class="input" placeholder="Company name" list="companies-list">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="inv-price" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Paid</label>
                        <select id="inv-paid" class="input">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Paid On</label>
                        <input type="date" id="inv-paid-on" class="input" disabled>
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addInvoice()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <input id="invoices-search" class="input" placeholder="Search invoices" style="max-width:320px">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-300">GST %</label>
                        <input id="gst-rate" class="input" type="number" value="10" min="0" max="100" style="width:90px">
                    </div>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForTable('invoices')"><i class="fas fa-eye mr-1"></i>Preview</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="printTable('invoices')"><i class="fas fa-print mr-1"></i>Print</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="exportCSV('invoices')"><i class="fas fa-file-export mr-1"></i>Export</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="shareTable('invoices')"><i class="fas fa-share-alt mr-1"></i>Share</button>
                </div>
                <div id="invoices-table"></div>
                <div id="invoices-totals" class="text-sm text-gray-300 mt-2"></div>
            </div>
        </div>

        <div class="tab" id="tab-exchange">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-exchange-alt mr-2"></i>Money Exchange</h2>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">From Currency</label>
                        <input type="text" id="exc-from-curr" class="input" placeholder="USD">
                    </div>
                    <div class="form-group">
                        <label class="form-label">From Amount</label>
                        <input type="number" id="exc-from-amt" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">To Currency</label>
                        <input type="text" id="exc-to-curr" class="input" placeholder="PKR">
                    </div>
                    <div class="form-group">
                        <label class="form-label">To Amount</label>
                        <input type="number" id="exc-to-amt" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Service</label>
                        <select id="exc-service" class="input">
                            <option>RIA</option>
                            <option>Western Union</option>
                            <option>Money Gram</option>
                            <option>Hawala</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="exc-status" class="input">
                            <option>Pending</option>
                            <option>Paid</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Paid On</label>
                        <input type="date" id="exc-paid-on" class="input" disabled>
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addExchange()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <input id="exchange-search" class="input" placeholder="Search exchange" style="max-width:320px">
                    <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForTable('exchange')"><i class="fas fa-eye mr-1"></i>Preview</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="printTable('exchange')"><i class="fas fa-print mr-1"></i>Print</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="exportCSV('exchange')"><i class="fas fa-file-export mr-1"></i>Export</button>
                    <button class="btn btn-primary toolbar-btn no-print" onclick="shareTable('exchange')"><i class="fas fa-share-alt mr-1"></i>Share</button>
                </div>
                <div id="exchange-table"></div>
                <div id="exchange-totals" class="text-sm text-gray-300 mt-2"></div>
            </div>
        </div>

        <div class="tab" id="tab-cash">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-coins mr-2"></i>Cash Drawer</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" id="cash-desc" class="input" placeholder="Description">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select id="cash-type" class="input">
                            <option value="in">Cash In</option>
                            <option value="out">Cash Out</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="cash-amount" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addCash()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <div id="cash-totals" class="text-sm text-gray-300"></div>
                <div id="cash-table"></div>
            </div>
        </div>

        <div class="tab" id="tab-outstanding">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-star mr-2"></i>Outstanding</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">Customer</label>
                        <input type="text" id="out-customer" class="input" placeholder="Customer name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="out-amount" class="input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="out-date" class="input">
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="addOutstanding()"><i class="fas fa-plus mr-2"></i>Add</button>
                    </div>
                </div>
                <div id="outstanding-totals" class="text-sm text-gray-300"></div>
                <div id="outstanding-table"></div>
            </div>
        </div>

        <div class="tab" id="tab-reports">
            <div class="glass p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4"><i class="fas fa-chart-line mr-2"></i>Reports</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="form-group">
                        <label class="form-label">From</label>
                        <input type="date" id="rep-from" class="input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">To</label>
                        <input type="date" id="rep-to" class="input">
                    </div>
                    <div class="form-group flex items-end">
                        <button class="btn btn-primary w-full" onclick="generateReports()"><i class="fas fa-filter mr-2"></i>Generate</button>
                    </div>
                </div>
                <div id="reports-table"></div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>
    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-xl font-bold">Edit Record</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-form"></form>
            <div class="mt-4 flex justify-end gap-2">
                <button class="btn btn-danger" onclick="closeEditModal()" type="button">Cancel</button>
                <button class="btn btn-success" onclick="saveEdits(event)" type="submit">Save</button>
            </div>
        </div>
    </div>

    <!-- Print Preview Overlay -->
    <div id="print-overlay" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 95%;">
            <div class="modal-header">
                <h3 class="text-xl font-bold">Print Preview</h3>
                <button class="modal-close" onclick="closePrintPreview()">&times;</button>
            </div>
            <div class="mb-4 no-print flex gap-2 justify-end">
                <button class="btn btn-primary toolbar-btn" onclick="printFromOverlay()"><i class="fas fa-print mr-1"></i>Print</button>
                <button class="btn btn-primary toolbar-btn" onclick="printFromOverlay()"><i class="fas fa-file-pdf mr-1"></i>Save as PDF</button>
                <button class="btn btn-primary toolbar-btn" onclick="shareFromOverlay()"><i class="fas fa-share-alt mr-1"></i>Share</button>
                <button class="btn btn-danger toolbar-btn" onclick="closePrintPreview()">Back to App</button>
            </div>
            <div id="print-content" class="glass p-4" style="background:white;color:#111827"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBcHY8XLvoaKVyilWHwfNdOYpqGQ9Gswik",
            authDomain: "gulistan-store.firebaseapp.com",
            projectId: "gulistan-store",
            storageBucket: "gulistan-store.firebasestorage.app",
            messagingSenderId: "626332439320",
            appId: "1:626332439320:web:a44e7b219d3418baed846d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // LocalDB Fallback
        const LocalDB = {
            getCollection(name) {
                try { return JSON.parse(localStorage.getItem(`gulistan_${name}`) || '[]'); }
                catch(e) { return []; }
            },
            saveCollection(name, data) {
                localStorage.setItem(`gulistan_${name}`, JSON.stringify(data));
            },
            addDoc(name, data) {
                const id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                const col = this.getCollection(name);
                col.push({ id, ...data, createdAt: new Date().toISOString() });
                this.saveCollection(name, col);
                return id;
            },
            updateDoc(name, id, data) {
                const col = this.getCollection(name);
                const idx = col.findIndex(d => d.id === id);
                if (idx !== -1) {
                    col[idx] = { ...col[idx], ...data };
                    this.saveCollection(name, col);
                }
            },
            deleteDoc(name, id) {
                const col = this.getCollection(name).filter(d => d.id !== id);
                this.saveCollection(name, col);
            },
            getDoc(name, id) {
                return this.getCollection(name).find(d => d.id === id);
            }
        };

        // No auth – read/write Firestore directly per your preference

        // Utilities
        function getGstRate() {
            const el = document.getElementById('gst-rate');
            const val = el ? parseFloat(el.value || '10') : 10;
            return (isNaN(val) ? 10 : val) / 100;
        }
        function normalizeName(name) {
            return (name || '').trim().replace(/\s+/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        }
        function notify(message, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.className = `notification ${type} show`;
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // Map logical tab names to Firestore collection names
        const CollectionMap = { outstanding: 'customers' };
        const resolveColl = (name) => CollectionMap[name] || name;

        // Column schemas per collection (label + formatting)
        const Schema = {
            expenses: {
                columns: [
                    { key: 'desc', label: 'Description' },
                    { key: 'amount', label: 'Amount', type: 'currency' },
                    { key: 'date', label: 'Date', type: 'date' }
                ],
                totals: [{ key: 'amount', label: 'Total' }]
            },
            investments: {
                columns: [
                    { key: 'name', label: 'Description' },
                    { key: 'investor', label: 'Investor' },
                    { key: 'amount', label: 'Amount', type: 'currency' },
                    { key: 'date', label: 'Date', type: 'date' },
                    { key: 'method', label: 'Method' }
                ],
                totals: [{ key: 'amount', label: 'Total' }]
            },
            suppliers: {
                columns: [
                    { key: 'name', label: 'Name' },
                    { key: 'contact', label: 'Contact' },
                    { key: 'email', label: 'Email' }
                ]
            },
            invoices: {
                columns: [
                    { key: 'num', label: 'Invoice #' },
                    { key: 'customer', label: 'Company' },
                    { key: 'amount', label: 'Amount', type: 'currency' },
                    { key: 'date', label: 'Date', type: 'date' },
                    { key: 'paid', label: 'Paid' },
                    { key: 'paidOn', label: 'Paid On', type: 'date' }
                ],
                totals: [
                    { key: 'amount', label: 'Total' },
                    { label: 'Total GST', reducer: rows => rows.reduce((s, r) => s + (parseFloat(r.amount) || 0), 0) * getGstRate() },
                    { key: 'amount', label: 'Total Paid', filter: r => (r.paid === 'Yes') },
                    { key: 'amount', label: 'Total Unpaid', filter: r => (r.paid !== 'Yes') }
                ]
            },
            exchange: {
                columns: [
                    { key: 'fromCurr', label: 'From Curr' },
                    { key: 'fromAmt', label: 'From Amt', type: 'currency' },
                    { key: 'toCurr', label: 'To Curr' },
                    { key: 'toAmt', label: 'To Amt', type: 'currency' },
                    { key: 'rate', label: 'Rate' },
                    { key: 'service', label: 'Service' },
                    { key: 'status', label: 'Status' },
                    { key: 'paidOn', label: 'Paid On', type: 'date' }
                ],
                totals: [
                    { key: 'fromAmt', label: 'Total From' },
                    { key: 'toAmt', label: 'Total To' }
                ]
            },
            cash: {
                columns: [
                    { key: 'desc', label: 'Description' },
                    { key: 'type', label: 'Type' },
                    { key: 'amount', label: 'Amount', type: 'currency' },
                    { key: 'date', label: 'Date', type: 'date' }
                ],
                totals: [
                    { key: 'amount', label: 'Cash In', filter: r => (r.type === 'in') },
                    { key: 'amount', label: 'Cash Out', filter: r => (r.type === 'out') },
                    { key: 'amount', label: 'Net', reducer: rows => rows.reduce((s, r) => s + (r.type === 'in' ? +(r.amount||0) : -(r.amount||0)), 0) }
                ]
            },
            outstanding: {
                columns: [
                    { key: 'customer', label: 'Customer' },
                    { key: 'amount', label: 'Amount', type: 'currency' },
                    { key: 'date', label: 'Date', type: 'date' }
                ],
                totals: [{ key: 'amount', label: 'Total' }]
            }
        };

        function formatDate(date) {
            if (!date) return 'N/A';
            const d = new Date(date);
            return d.toLocaleDateString();
        }

        function formatCurrency(amount) {
            return '$' + parseFloat(amount || 0).toFixed(2);
        }

        function showLoading(collection, isLoading) {
            const tableId = `${collection}-table`;
            const container = document.getElementById(tableId);
            if (!container) return;
            if (isLoading) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Loading...</span></div>';
            }
        }

        // Tab Switching
        function switchTab(button, tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            const tabEl = document.getElementById(`tab-${tabName}`);
            if (tabEl) tabEl.classList.add('active');
            if (button) button.classList.add('active');
        }

        function bindTabClicks() {
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabName = btn.getAttribute('data-tab');
                    if (!tabName) return;
                    switchTab(btn, tabName);
                });
            });
        }

        // Database Helper
        async function addToCollection(collection, data) {
            // Generate a single ID and use it for both LocalDB and Firestore
            const id = LocalDB.addDoc(collection, data);
            try {
                await db.collection(resolveColl(collection)).doc(id).set(data);
            } catch (e) {
                console.warn('Firebase write error (using LocalDB fallback):', e);
                notify(`Cloud write failed for ${collection}: ${e.message || e}`, 'error');
            }
            loadCollection(collection);
        }

        async function updateInCollection(collection, id, data) {
            LocalDB.updateDoc(collection, id, data);
            try {
                await db.collection(resolveColl(collection)).doc(id).set(data, { merge: true });
            } catch (e) {
                console.warn('Firebase update error (updated locally):', e);
                notify(`Cloud update failed for ${collection}: ${e.message || e}`, 'error');
            }
            loadCollection(collection);
        }

        async function deleteFromCollection(collection, id) {
            LocalDB.deleteDoc(collection, id);
            try {
                await db.collection(resolveColl(collection)).doc(id).delete();
            } catch (e) {
                console.warn('Firebase delete error (removed locally):', e);
                notify(`Cloud delete failed for ${collection}: ${e.message || e}`, 'error');
            }
            loadCollection(collection);
        }

        async function loadCollection(collection) {
            // Firestore-first: try to read from cloud, then fall back to local
            showLoading(collection, true);
            try {
                const snapshot = await db.collection(resolveColl(collection)).get();
                const data = [];
                snapshot.forEach(doc => {
                    data.push({ id: doc.id, ...doc.data() });
                });
                LocalDB.saveCollection(collection, data);
                renderTable(collection, data);
                return;
            } catch (e) {
                console.warn('Firebase read error, falling back to local:', e);
                notify(`Cloud read failed for ${collection}: ${e.message || e}`, 'error');
            }

            try {
                const localData = LocalDB.getCollection(collection);
                renderTable(collection, localData);
            } catch (e) {
                console.warn('Local render error:', e);
            }
        }

        function updateTotals(collection, data) {
            const el = document.getElementById(`${collection}-totals`);
            if (!el) return;
            const schema = Schema[collection];
            if (!schema || !schema.totals) { el.textContent = ''; return; }
            const rows = Array.isArray(data) ? data : [];
            const parts = [];
            for (const t of schema.totals) {
                if (typeof t.reducer === 'function') {
                    const val = t.reducer(rows);
                    parts.push(`${t.label}: ${formatCurrency(val)}`);
                } else if (t.key) {
                    const filtered = t.filter ? rows.filter(t.filter) : rows;
                    const sum = filtered.reduce((s, r) => s + (parseFloat(r[t.key]) || 0), 0);
                    parts.push(`${t.label}: ${formatCurrency(sum)}`);
                }
            }
            el.textContent = parts.join(' • ');
        }

        // Add Functions
        function addExpense() {
            const desc = document.getElementById('expense-desc').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const date = document.getElementById('expense-date').value;
            if (!desc || !amount) { notify('Fill all fields', 'error'); return; }
            addToCollection('expenses', { desc, amount, date: date || new Date().toISOString().split('T')[0] });
            document.getElementById('expense-desc').value = '';
            document.getElementById('expense-amount').value = '';
            notify('Expense added');
        }

        function addInvestment() {
            const name = document.getElementById('inv-name').value;
            const investor = document.getElementById('inv-investor') ? document.getElementById('inv-investor').value : '';
            const amount = parseFloat(document.getElementById('inv-amount').value);
            const date = document.getElementById('inv-date').value;
            const method = document.getElementById('inv-method') ? document.getElementById('inv-method').value : 'Cash';
            if (!name || !amount) { notify('Fill all fields', 'error'); return; }
            addToCollection('investments', { name, investor, amount, date: date || new Date().toISOString().split('T')[0], method });
            document.getElementById('inv-name').value = '';
            document.getElementById('inv-amount').value = '';
            notify('Investment added');
        }

        function addSupplier() {
            const nameRaw = document.getElementById('supp-name').value;
            const name = normalizeName(nameRaw);
            const contact = document.getElementById('supp-contact').value;
            const email = document.getElementById('supp-email').value;
            if (!name) { notify('Fill supplier name', 'error'); return; }
            addToCollection('suppliers', { name, contact, email });
            document.getElementById('supp-name').value = '';
            document.getElementById('supp-contact').value = '';
            document.getElementById('supp-email').value = '';
            notify('Supplier added');
            refreshCompaniesDatalist();
        }

        function addInvoice() {
            const num = document.getElementById('inv-num').value;
            const customerRaw = document.getElementById('inv-customer').value;
            const customer = normalizeName(customerRaw);
            const amount = parseFloat(document.getElementById('inv-price').value);
            const paid = document.getElementById('inv-paid') ? document.getElementById('inv-paid').value : 'No';
            const paidOn = document.getElementById('inv-paid-on') ? document.getElementById('inv-paid-on').value : '';
            if (!num || !customer || !amount) { notify('Fill all fields', 'error'); return; }
            addToCollection('invoices', { num, customer, amount, date: new Date().toISOString().split('T')[0], paid, paidOn });
            document.getElementById('inv-num').value = '';
            document.getElementById('inv-customer').value = '';
            document.getElementById('inv-price').value = '';
            notify('Invoice added');
            refreshCompaniesDatalist();
        }

        function addExchange() {
            const fromCurr = document.getElementById('exc-from-curr').value;
            const fromAmt = parseFloat(document.getElementById('exc-from-amt').value);
            const toCurr = document.getElementById('exc-to-curr').value;
            const toAmt = parseFloat(document.getElementById('exc-to-amt').value);
            const service = document.getElementById('exc-service') ? document.getElementById('exc-service').value : '';
            const status = document.getElementById('exc-status') ? document.getElementById('exc-status').value : 'Pending';
            const paidOn = document.getElementById('exc-paid-on') ? document.getElementById('exc-paid-on').value : '';
            if (!fromCurr || !fromAmt || !toCurr || !toAmt) { notify('Fill all fields', 'error'); return; }
            addToCollection('exchange', { fromCurr, fromAmt, toCurr, toAmt, rate: (toAmt / fromAmt).toFixed(4), service, status, paidOn });
            document.getElementById('exc-from-curr').value = '';
            document.getElementById('exc-from-amt').value = '';
            document.getElementById('exc-to-curr').value = '';
            document.getElementById('exc-to-amt').value = '';
            notify('Exchange record added');
        }

        function addCash() {
            const desc = document.getElementById('cash-desc').value;
            const type = document.getElementById('cash-type').value;
            const amount = parseFloat(document.getElementById('cash-amount').value);
            if (!desc || !amount) { notify('Fill all fields', 'error'); return; }
            addToCollection('cash', { desc, type, amount, date: new Date().toISOString().split('T')[0] });
            document.getElementById('cash-desc').value = '';
            document.getElementById('cash-amount').value = '';
            notify('Cash record added');
        }

        function addOutstanding() {
            const customer = document.getElementById('out-customer').value;
            const amount = parseFloat(document.getElementById('out-amount').value);
            const date = document.getElementById('out-date').value;
            if (!customer || !amount) { notify('Fill all fields', 'error'); return; }
            addToCollection('outstanding', { customer, amount, date: date || new Date().toISOString().split('T')[0] });
            document.getElementById('out-customer').value = '';
            document.getElementById('out-amount').value = '';
            notify('Outstanding added');
        }

        // Render Table
        function renderTable(collection, data) {
            const tableId = `${collection}-table`;
            const container = document.getElementById(tableId);
            if (!container) return;

            try {
                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">No records yet</p>';
                    updateTotals(collection, []);
                    return;
                }

                const schema = Schema[collection];
                let html = '<table>';
                const cols = (schema && schema.columns) ? schema.columns : Object.keys(data[0] || {}).filter(k => k !== 'id' && k !== 'createdAt').map(k => ({ key: k, label: k }));
                html += '<thead><tr>';
                cols.forEach(c => { html += `<th>${c.label}</th>`; });
                html += '<th>Actions</th></tr></thead><tbody>';

                data.forEach(row => {
                    html += '<tr>';
                    cols.forEach(c => {
                        let val = row[c.key];
                        if (c.type === 'currency') val = formatCurrency(val);
                        else if (c.type === 'date') val = formatDate(val);
                        html += `<td>${(val ?? 'N/A')}</td>`;
                    });
                    const id = row.id || '';
                    html += `<td class="flex gap-2">
                        <button class="btn btn-primary toolbar-btn no-print" onclick="openEditModal('${collection}', '${id}')"><i class='fas fa-pen'></i></button>
                        <button class="btn btn-danger toolbar-btn no-print" onclick="deleteFromCollection('${collection}', '${id}')"><i class='fas fa-trash'></i></button>
                        <button class="btn btn-primary toolbar-btn no-print" onclick="openPrintPreviewForRow('${collection}', '${id}')"><i class='fas fa-eye'></i></button>
                        <button class="btn btn-primary toolbar-btn no-print" onclick="printRow('${collection}', '${id}')"><i class='fas fa-print'></i></button>
                    </td>`;
                    html += '</tr>';
                });
                html += '</tbody></table>';
                container.innerHTML = html;
                updateTotals(collection, data);
            } catch (e) {
                console.warn('Table render error:', e);
                container.innerHTML = '<p class="text-red-400">Error rendering table</p>';
            }
        }

        // Edit Modal Logic
        let editState = { collection: null, id: null, fields: [] };

        function openEditModal(collection, id) {
            const data = LocalDB.getDoc(collection, id);
            if (!data) { notify('Record not found', 'error'); return; }
            editState = { collection, id, fields: Object.keys(data).filter(k => k !== 'id' && k !== 'createdAt') };
            const form = document.getElementById('edit-form');
            form.innerHTML = '';
            editState.fields.forEach(k => {
                const val = data[k] ?? '';
                form.innerHTML += `<div class="form-group"><label class="form-label">${k}</label><input class="input" name="${k}" value="${val}"></div>`;
            });
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        function saveEdits(e) {
            e.preventDefault();
            const form = document.getElementById('edit-form');
            const updated = {};
            editState.fields.forEach(k => {
                const input = form.querySelector(`[name="${k}"]`);
                updated[k] = input ? (isFinite(input.value) ? parseFloat(input.value) : input.value) : undefined;
            });
            updateInCollection(editState.collection, editState.id, updated);
            closeEditModal();
            notify('Record updated');
        }

        // Reports
        function generateReports() {
            const from = document.getElementById('rep-from').value;
            const to = document.getElementById('rep-to').value;
            const start = from ? new Date(from) : null;
            const end = to ? new Date(to) : null;
            const cols = ['expenses','investments','invoices','exchange','cash','outstanding'];
            const totals = {};
            const fieldMap = { expenses:'amount', investments:'amount', invoices:'amount', exchange:'toAmt', cash:'amount', outstanding:'amount' };
            cols.forEach(c => {
                const field = fieldMap[c];
                const rows = LocalDB.getCollection(c).filter(r => {
                    const d = new Date(r.date || r.createdAt || Date.now());
                    return (!start || d >= start) && (!end || d <= end);
                });
                totals[c] = rows.reduce((s, r) => s + (parseFloat(r[field]) || 0), 0);
            });
            // Per-investor totals
            const invRows = LocalDB.getCollection('investments').filter(r => {
                const d = new Date(r.date || r.createdAt || Date.now());
                return (!start || d >= start) && (!end || d <= end);
            });
            const investHayat = invRows.filter(r => (r.investor === 'Haji Hayat'));
            const investAbbas = invRows.filter(r => (r.investor === 'Abbas'));
            const totalHayat = investHayat.reduce((s, r) => s + (parseFloat(r.amount)||0), 0);
            const totalAbbas = investAbbas.reduce((s, r) => s + (parseFloat(r.amount)||0), 0);
            const el = document.getElementById('reports-table');
            el.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="glass p-4"><h4 class="font-bold mb-2">Expenses</h4><div>${formatCurrency(totals.expenses)}</div></div>
                <div class="glass p-4"><h4 class="font-bold mb-2">Investments</h4><div>${formatCurrency(totals.investments)}</div></div>
                <div class="glass p-4"><h4 class="font-bold mb-2">Invoices</h4><div>${formatCurrency(totals.invoices)}</div></div>
                <div class="glass p-4"><h4 class="font-bold mb-2">Exchange</h4><div>${formatCurrency(totals.exchange)}</div></div>
                <div class="glass p-4"><h4 class="font-bold mb-2">Cash</h4><div>${formatCurrency(totals.cash)}</div></div>
                <div class="glass p-4"><h4 class="font-bold mb-2">Outstanding</h4><div>${formatCurrency(totals.outstanding)}</div></div>
                <div class="glass p-4"><h4 class="font-bold mb-2">Haji Hayat Investments</h4><div>${formatCurrency(totalHayat)}</div></div>
                <div class="glass p-4"><h4 class="font-bold mb-2">Abbas Investments</h4><div>${formatCurrency(totalAbbas)}</div></div>
            </div>`;
        }

        // Backup/Import removed per your preference

        // Initialize
        async function updateConnectionStatus() {
            const el = document.getElementById('connection-status');
            try {
                await db.collection('expenses').limit(1).get();
                el.textContent = '✅ Connected to Firebase';
            } catch (e) {
                el.textContent = '🟠 Offline mode (LocalDB)';
            }
        }

        window.addEventListener('error', (e) => {
            notify(`Error: ${e.message}`, 'error');
        });
        window.addEventListener('unhandledrejection', (e) => {
            notify(`Error: ${e.reason && e.reason.message ? e.reason.message : e.reason}`, 'error');
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Force-remove any old PWA caches/service workers from previous app versions
            (async () => {
                try {
                    if ('serviceWorker' in navigator) {
                        const regs = await navigator.serviceWorker.getRegistrations();
                        regs.forEach(r => r.unregister());
                    }
                    if (window.caches && caches.keys) {
                        const keys = await caches.keys();
                        await Promise.all(keys.map(k => caches.delete(k)));
                    }
                    console.log('✓ Cleared old service workers and caches');
                } catch (e) {
                    console.warn('Cleanup error:', e);
                }
            })();

            document.getElementById('expense-date').valueAsDate = new Date();
            document.getElementById('inv-date').valueAsDate = new Date();
            document.getElementById('out-date').valueAsDate = new Date();
            bindTabClicks();
            
            // Update connection status by probing Firestore
            updateConnectionStatus();
            
            // Load all collections
            const collections = ['expenses', 'investments', 'suppliers', 'invoices', 'exchange', 'cash', 'outstanding'];
            collections.forEach(col => loadCollection(col));
            // Populate company autocomplete
            refreshCompaniesDatalist();
            
            const build = '2026-01-29T' + new Date().toTimeString().slice(0,8);
            document.getElementById('build-version').textContent = `Build: ${build}`;
            console.log('✓ Gulistan Management System Initialized');
            console.log('✓ Firebase Firestore Connected');
            console.log('✓ Build version:', build);

            // Enable Paid On fields when Paid = Yes
            const invPaidSel = document.getElementById('inv-paid');
            const invPaidOn = document.getElementById('inv-paid-on');
            if (invPaidSel && invPaidOn) {
                invPaidSel.addEventListener('change', () => {
                    invPaidOn.disabled = invPaidSel.value !== 'Yes';
                    if (invPaidOn.disabled) invPaidOn.value = '';
                });
            }

            const excStatusSel = document.getElementById('exc-status');
            const excPaidOn = document.getElementById('exc-paid-on');
            if (excStatusSel && excPaidOn) {
                excStatusSel.addEventListener('change', () => {
                    excPaidOn.disabled = excStatusSel.value !== 'Paid';
                    if (excPaidOn.disabled) excPaidOn.value = '';
                });
            }

            // Simple search bindings per tab
            ['invoices','exchange','investments','suppliers'].forEach(tab => {
                const input = document.getElementById(`${tab}-search`);
                if (!input) return;
                input.addEventListener('input', () => {
                    const q = input.value.toLowerCase();
                    const rows = LocalDB.getCollection(tab);
                    const filtered = rows.filter(r => JSON.stringify(r).toLowerCase().includes(q));
                    renderTable(tab, filtered);
                });
            });
        });

        // Company autocomplete list (based on existing invoices + suppliers)
        function refreshCompaniesDatalist() {
            const elId = 'companies-list';
            let dl = document.getElementById(elId);
            if (!dl) {
                dl = document.createElement('datalist');
                dl.id = elId;
                document.body.appendChild(dl);
            }
            const names = new Set();
            LocalDB.getCollection('suppliers').forEach(s => { if (s.name) names.add(s.name); });
            LocalDB.getCollection('invoices').forEach(i => { if (i.customer) names.add(i.customer); });
            dl.innerHTML = Array.from(names).sort().map(n => `<option value="${n}"></option>`).join('');
        }

        // Printing helpers
        function buildPrintHeader(title) {
            const logo = '<img src="logo.png" alt="Logo" style="height:48px;margin-bottom:8px" onerror="this.style.display=\'none\'">';
            const company = '<div style="font-weight:700;font-size:16px">Gulistan - Management System</div>';
            const sub = `<div style="font-size:12px;color:#374151">${new Date().toLocaleString()}</div>`;
            return `<div class="print-header">${logo}${company}${sub}<div style="margin-top:8px;font-weight:600">${title}</div></div>`;
        }

        function buildSummaryHTML(collection, rows) {
            const schema = Schema[collection];
            const parts = [];
            if (schema && Array.isArray(schema.totals)) {
                for (const t of schema.totals) {
                    if (typeof t.reducer === 'function') {
                        const val = t.reducer(rows);
                        parts.push(`${t.label}: ${typeof val === 'number' ? formatCurrency(val) : val}`);
                    } else if (t.key) {
                        const filtered = t.filter ? rows.filter(t.filter) : rows;
                        const sum = filtered.reduce((s, r) => s + (parseFloat(r[t.key]) || 0), 0);
                        parts.push(`${t.label}: ${formatCurrency(sum)}`);
                    }
                }
            }
            // Additional summaries per collection
            if (collection === 'investments') {
                const hayat = rows.filter(r => r.investor === 'Haji Hayat').reduce((s, r) => s + (parseFloat(r.amount)||0), 0);
                const abbas = rows.filter(r => r.investor === 'Abbas').reduce((s, r) => s + (parseFloat(r.amount)||0), 0);
                parts.push(`Haji Hayat: ${formatCurrency(hayat)}`);
                parts.push(`Abbas: ${formatCurrency(abbas)}`);
                const methodCash = rows.filter(r => r.method === 'Cash').reduce((s, r) => s + (parseFloat(r.amount)||0), 0);
                const methodBank = rows.filter(r => r.method === 'Bank Transfer').reduce((s, r) => s + (parseFloat(r.amount)||0), 0);
                parts.push(`Cash: ${formatCurrency(methodCash)}`);
                parts.push(`Bank Transfer: ${formatCurrency(methodBank)}`);
            } else if (collection === 'suppliers') {
                parts.push(`Suppliers Count: ${rows.length}`);
            }
            if (!parts.length) return '';
            return `<div style="margin-top:12px"><div style="font-weight:600;margin-bottom:6px">Summary</div><ul style="list-style:none;padding:0;margin:0">${parts.map(p => `<li style="margin-bottom:4px">${p}</li>`).join('')}</ul></div>`;
        }

        function getMonthKey(d) {
            const date = new Date(d || Date.now());
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${y}-${m}`;
        }

        function buildMonthlySection(collection, rows) {
            const fieldMap = { expenses:'amount', investments:'amount', invoices:'amount', exchange:'toAmt', cash:'amount', outstanding:'amount' };
            const field = fieldMap[collection];
            if (!field) return '';
            const monthly = new Map();
            rows.forEach(r => {
                const key = getMonthKey(r.date || r.createdAt);
                const val = parseFloat(r[field]) || 0;
                monthly.set(key, (monthly.get(key) || 0) + val);
            });
            if (!monthly.size) return '';
            const rowsHtml = Array.from(monthly.entries()).sort(([a],[b]) => a.localeCompare(b))
                .map(([mon, total]) => `<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb">${mon}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right">${formatCurrency(total)}</td></tr>`)
                .join('');
            return `<div style="margin-top:12px"><div style="font-weight:600;margin-bottom:6px">Monthly Breakdown</div><table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Month</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Total</th></tr></thead><tbody>${rowsHtml}</tbody></table></div>`;
        }

        function printTable(collection) {
            const rows = LocalDB.getCollection(collection);
            const schema = Schema[collection];
            const cols = (schema && schema.columns) ? schema.columns : Object.keys(rows[0]||{}).filter(k => k!=='id' && k!=='createdAt').map(k => ({key:k,label:k}));
            let html = buildPrintHeader(`${collection.toUpperCase()} Report`);
            html += '<table style="width:100%;border-collapse:collapse">';
            html += '<thead><tr>' + cols.map(c => `<th style="border-bottom:1px solid #e5e7eb;padding:8px;text-align:left">${c.label}</th>`).join('') + '</tr></thead><tbody>';
            rows.forEach(r => {
                html += '<tr>' + cols.map(c => {
                    let val = r[c.key];
                    if (c.type==='currency') val = formatCurrency(val);
                    else if (c.type==='date') val = formatDate(val);
                    return `<td style="border-bottom:1px solid #e5e7eb;padding:8px">${val ?? ''}</td>`;
                }).join('') + '</tr>';
            });
            html += '</tbody></table>';
            const win = window.open('', '_blank');
            if (!win) return notify('Popup blocked: enable popups to print', 'error');
            win.document.write(`<html><head><title>${collection} Report</title></head><body>${html}</body></html>`);
            win.document.close();
            win.focus();
            win.print();
        }

        function printRow(collection, id) {
            const row = LocalDB.getDoc(collection, id);
            if (!row) return notify('Record not found', 'error');
            const schema = Schema[collection];
            const cols = (schema && schema.columns) ? schema.columns : Object.keys(row).filter(k => k!=='id' && k!=='createdAt').map(k => ({key:k,label:k}));
            let html = buildPrintHeader(`${collection.toUpperCase()} Item`);
            html += '<table style="width:100%;border-collapse:collapse">';
            cols.forEach(c => {
                let val = row[c.key];
                if (c.type==='currency') val = formatCurrency(val);
                else if (c.type==='date') val = formatDate(val);
                html += `<tr><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">${c.label}</th><td style="padding:8px;border-bottom:1px solid #e5e7eb">${val ?? ''}</td></tr>`;
            });
            html += '</table>';
            const win = window.open('', '_blank');
            if (!win) return notify('Popup blocked: enable popups to print', 'error');
            win.document.write(`<html><head><title>${collection} Item</title></head><body>${html}</body></html>`);
            win.document.close();
            win.focus();
            win.print();
        }

        // Print Preview helpers
        function openPrintPreviewHTML(title, html, shareText) {
            const container = document.getElementById('print-content');
            container.innerHTML = buildPrintHeader(title) + html;
            container.dataset.shareText = shareText || '';
            document.getElementById('print-overlay').classList.add('active');
        }

        function closePrintPreview() {
            document.getElementById('print-overlay').classList.remove('active');
            document.getElementById('print-content').innerHTML = '';
        }

        function printFromOverlay() {
            window.print();
        }

        async function shareFromOverlay() {
            const txt = document.getElementById('print-content').dataset.shareText || '';
            if (!txt) return notify('Nothing to share', 'error');
            if (navigator.share) {
                try { await navigator.share({ title: 'Report', text: txt }); } catch (e) {}
            } else {
                await navigator.clipboard.writeText(txt);
                notify('Copied summary to clipboard');
            }
        }

        function openPrintPreviewForTable(collection) {
            const rows = LocalDB.getCollection(collection);
            const schema = Schema[collection];
            const cols = (schema && schema.columns) ? schema.columns : Object.keys(rows[0]||{}).filter(k => k!=='id' && k!=='createdAt').map(k => ({key:k,label:k}));
            let table = '<table style="width:100%;border-collapse:collapse">';
            table += '<thead><tr>' + cols.map(c => `<th style="border-bottom:1px solid #e5e7eb;padding:8px;text-align:left">${c.label}</th>`).join('') + '</tr></thead><tbody>';
            rows.forEach(r => {
                table += '<tr>' + cols.map(c => {
                    let val = r[c.key];
                    if (c.type==='currency') val = formatCurrency(val);
                    else if (c.type==='date') val = formatDate(val);
                    return `<td style="border-bottom:1px solid #e5e7eb;padding:8px">${val ?? ''}</td>`;
                }).join('') + '</tr>';
            });
            table += '</tbody></table>';
            const summary = buildSummaryHTML(collection, rows);
            const monthly = buildMonthlySection(collection, rows);
            const shareText = rows.map(r => cols.map(c => `${c.label}: ${r[c.key] ?? ''}`).join(' | ')).join('\n')
                + (summary ? `\n\n${summary.replace(/<[^>]+>/g,'')}` : '')
                + (monthly ? `\n\n${monthly.replace(/<[^>]+>/g,'')}` : '');
            openPrintPreviewHTML(`${collection.toUpperCase()} Report`, table + summary + monthly, shareText);
        }

        function openPrintPreviewForRow(collection, id) {
            const row = LocalDB.getDoc(collection, id);
            if (!row) return notify('Record not found', 'error');
            const schema = Schema[collection];
            const cols = (schema && schema.columns) ? schema.columns : Object.keys(row).filter(k => k!=='id' && k!=='createdAt').map(k => ({key:k,label:k}));
            let table = '<table style="width:100%;border-collapse:collapse">';
            cols.forEach(c => {
                let val = row[c.key];
                if (c.type==='currency') val = formatCurrency(val);
                else if (c.type==='date') val = formatDate(val);
                table += `<tr><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb">${c.label}</th><td style="padding:8px;border-bottom:1px solid #e5e7eb">${val ?? ''}</td></tr>`;
            });
            table += '</table>';
            const shareText = cols.map(c => `${c.label}: ${row[c.key] ?? ''}`).join(' | ');
            openPrintPreviewHTML(`${collection.toUpperCase()} Item`, table, shareText);
        }

        function exportCSV(collection) {
            const rows = LocalDB.getCollection(collection);
            if (!rows.length) return notify('No data to export', 'error');
            const headers = Object.keys(rows[0]).filter(k => k!=='id' && k!=='createdAt');
            const csv = [headers.join(',')].concat(rows.map(r => headers.map(h => JSON.stringify(r[h] ?? '')).join(','))).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${collection}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function shareTable(collection) {
            const rows = LocalDB.getCollection(collection);
            if (!rows.length) return notify('No data to share', 'error');
            const headers = Object.keys(rows[0]).filter(k => k!=='id' && k!=='createdAt');
            const text = rows.map(r => headers.map(h => `${h}: ${r[h] ?? ''}`).join(' | ')).join('\n');
            if (navigator.share) {
                try {
                    await navigator.share({ title: `${collection} report`, text });
                } catch (e) { notify('Share cancelled', 'error'); }
            } else {
                await navigator.clipboard.writeText(text);
                notify('Copied summary to clipboard');
            }
        }
    </script>
</body>
</html>
